\newbox\pbbox
\setbox\pbbox=\hbox{\xy \POS(65,0)\ar@{-} (0,0) \ar@{-} (65,65)\endxy}
\def\pb{\save[]+<3.5mm,-3.5mm>*{\copy\pbbox} \restore}

\newcommand{\comp}[2]{\ensuremath{{#2} \circ {#1}}}
\newcommand{\contr}{\ensuremath{\mathsf{contr}}}
\newcommand{\istype}[1]{\mathsf{is}\mbox{-}{#1}\mbox{-}\mathsf{type}}
% \newcommand{\nplusone}{\ensuremath{(n\mbox{\rm{+}}1)}}
% \newcommand{\nminusone}{\ensuremath{(n\mbox{\rm{-}}1)}}
\newcommand{\nplusone}{\ensuremath{(n+1)}}
\newcommand{\nminusone}{\ensuremath{(n-1)}}

% Subuniverse
\renewcommand{\P}{\ensuremath{\mathsf{P}}\xspace}
% Reflector, projection and extension in an arbitrary reflective subuniverse
\newcommand{\reflect}{\mathsf{r}}
\newcommand{\project}{\mathsf{p}}
\newcommand{\ext}{\mathsf{ext}}


\chapter{\texorpdfstring{$n$}{n}-types and modalities}
\label{cha:hlevels}

\section{$n$-types}

In homotopy theory one often talks about $n$-types, i.e.\ spaces whose homotopy groups vanish above $n$.
We mentioned in \autoref{sec:basics-sets} that a similar notion can be defined in type theory, with the $0$-types being the sets and continuing inductively.
As mentioned in \autoref{sec:logic,sec:contractibility}, it turns out to be convenient to start two levels lower, where the $(-1)$-types being the mere propositions and the $(-2)$-types the contractible ones.
We now define these formally for all $n$.

\begin{defn}\label{def:hlevel}
  Define the predicate $\istype{n} : \type \to \type$ for $n \geq -2$ by recursion as follows:
  \[ \istype{n}(X) \defeq
  \begin{cases}
    \iscontr(X) & \text{ if } n = -2 , \\
    \prd{x,y : X} \istype{n'}(\id[X]{x}{y}) & \text{ if } n = n'+1
  \end{cases}
  \]
  We say that $X$ \emph{is an $n$-type} if $\istype{n}(X)$ is inhabited.
\end{defn}

\begin{rmk}
  The number $n$ in \autoref{def:hlevel} ranges over all integers greater than or equal to $-2$.
  We could make sense of this formally by defining a type $\Z_{{\geq}-2}$ of such integers (a type whose induction principle is identical to that of $\Nat$), or instead defining a predicate $\istype{(k-2)}$ for $k : \Nat$.
  Either way, we can prove theorems about $n$-types by induction on $n$, with $n = -2$ as the base case.
\end{rmk}

As in classical homotopy theory, a type does not have to be an $n$-type for any number $n$.
In \autoref{cha:hits} will define some types that are expected to be counterexamples.

\begin{eg}
  We saw in \autoref{thm:prop-minusonetype} that $X$ is a $(-1)$-type if and only if it is a mere proposition.
  Therefore, $X$ is a $0$-type if and only if it is a set.
\end{eg}

We start by showing $n$-types are closed under certain operations and constructors.

\begin{thm}\label{thm:h-level-retracts}
 Let $p : X \to Y$ be a retraction and suppose that $X$ is an $n$-type, for any $n\geq -2$.
 Then $Y$ is also an $n$-type.
\end{thm}

By definition, a \textbf{retraction} is a function $p : X \to Y$ such that there exists a function $s : Y \to X$, called its \textbf{section} and a homotopy $\epsilon:\prd{y:Y} (p(s(y))=y)$.

\begin{proof}
 We proceed by induction on $n$.

 For $n=-2$, assume $X$ is contractible; let $x_0 : X$ be the center of contraction.
 We claim that $y_0 \defeq p(x_0) : Y$ is a center of contraction for $Y$.
 Let $y : Y$; we need a path $y = y_0$.
 But we have $\epsilon_y : p(s(y)) = y$ and $\contr_{s(y)} : s(y) = x_0$, so by composition
 \[ \opp{\epsilon_y} \ct \ap{p}{\contr_{s(y)}} : y = p(x_0) \jdeq y_0 .\]

 For the inductive step, assume that any retract of an $n$-type is an $n$-type, and that $X$ is an $\nplusone$-type.
 Let $y, y' : Y$; we must show that $\id{y}{y'}$ is an $n$-type.
 Snce $X$ is an $\nplusone$-type, $\id[X]{s(y)}{s(y')}$ is an $n$-type.
 We claim that $\id{y}{y'}$ is a retract of $\id[X]{s(y)}{s(y')}$.
 As the section, we have
 \[ \apfunc s : (y=y') \to (s(y)=s(y')). \]
 For the retraction, we define $t:(s(y)=s(y'))\to(y=y')$ by
 \[ t(q) \defeq  \opp{\epsilon_y} \ct \ap p q \ct \epsilon_{y'}.\]
 To show that $t$ is a retraction of $\apfunc s$, we must show that
 \[ \opp{\epsilon_y} \ct \ap p {\ap sr} \ct \epsilon_{y'} = q \]
 for any $r:y=y'$.
 But this follows easily from \autoref{lem:htpy-natural}.
\end{proof}

As an immediate corollary we obtain the stability of $n$-types under equivalence:

\begin{cor}\label{cor:preservation-hlevels-weq}
 If $\eqv{X}{Y}$ and $X$ is an $n$-type, then so is $Y$.
\end{cor}

Recall also the notion of monomorphism from \autoref{sec:mono-surj}.

\begin{thm}\label{thm:isntype-mono}
  If $f:X\to Y$ is a monomorphism and $Y$ is an $n$-type for some $n\ge -1$, then so is $X$.
\end{thm}
\begin{proof}
  Let $x,x':X$; we must show that $\id[X]{x}{x'}$ is an $\nminusone$-type.
  But since $f$ is a monomorphism, we have $(\id[X]{x}{x'}) \simeq (\id[Y]{f(x)}{f(x')})$, and the latter is an $\nminusone$-type by assumption.
\end{proof}

Note that this theorem fails when $n=-2$: the map $\emptyt \to \unit$ is a monomorphism, but $\unit$ is a $(-2)$-type while $\emptyt$ is not.

\begin{thm}\label{thm:hlevel-cumulative}
 The hierarchy of $n$-types is cumulative in the following sense:
   given a number $n \geq -2$, if $X$ is an $n$-type, then it is also an $\nplusone$-type.
\end{thm}

\begin{proof}
 We proceed by induction on $n$.

 For $n = -2$, we need to show that a contractible type, say, $A$, has contractible path spaces.
       Let $a_0: A$ be the center of contraction of $A$, and let $x, y : A$. We show that $\id[A]{x}{y}$
       is contractible.
       By contractibility of $A$ we have a path $\contr_x \ct \opp{\contr_y} : x = y$, which we choose as
       the center of contraction for $\id{x}{y}$.
       Given any $p : x = y$, we need to show $p = \contr_x \ct \opp{\contr_y}$.
           By identity elimination, it suffices to show that
        $\refl{x} = \contr_x \ct \opp{\contr_x}$, which is trivial.

 For the inductive step, we need to show that $\id[X]{x}{y}$ is an $\nplusone$-type, provided
          that $X$ is an $\nplusone$-type. Applying the induction hypothesis to $\id[X]{x}{y}$
         yields the desired result.
\end{proof}

% \section{Preservation under constructors}
% \label{sec:ntype-pres}

We now show that $n$-types are preserved by most type forming operations.

\begin{thm}
 Let $n \geq -2$, and let $A : \type$ and $B : A \to \type$.
 If $A$ is an $n$-type and for all $a : A$, $B(a)$ is an $n$-type, then so is $\sm{x : A} B(x)$.
\end{thm}

\begin{proof}
 We proceed by induction on $n$.

 For $n = -2$, we choose the center of contraction for $\sm{x : A} B(x)$ to be the pair
       $(a_0, b_0)$, where $a_0 : A$ is the center of contraction of $A$ and $b_0 : B(a_0)$ is the center of contraction of $B(a_0)$.
       Given any other element $(a,b)$ of $\sm{x : A} B(x)$, we provide a path $\id{(a, b)}{(a_0,b_0)}$
       by contractibility of $A$ and $B(a_0)$, respectively.

 For the inductive step, suppose that $A$ is an $\nplusone$-type and
         for any $a : A$, $B(a)$ is an $\nplusone$-type. We show that $\sm{x : A} B(x)$ is an $\nplusone$-type:
      fix $(a_1, b_1)$ and $(a_2,b_2)$ in $\sm{x : A} B(x)$,
     we show that $\id{(a_1, b_1)}{(a_2,b_2)}$ is an $n$-type.
      By \autoref{thm:path-sigma} we have
      \[ \eqvspaced{(\id{(a_1, b_1)}{(a_2,b_2)})}{\sm{p : \id{a_1}{a_2}} (\id[B(a_2)]{\trans{p}{b_1}}{b_2})} \]
   and by preservation of $n$-types under equivalences (\autoref{cor:preservation-hlevels-weq})
   it suffices to prove that the latter is an $n$-type. This follows from the
   induction hypothesis.
\end{proof}


\begin{thm}\label{thm:hlevel-prod}
 Let $n\geq -2$, and let $A : \type$ and $B : A \to \type$.
 If for all $a : A$, $B(a)$ is an $n$-type, then so is $\prd{x : A} B(x)$.
\end{thm}

\begin{proof}
  We proceed by induction on $n$.
  For $n = -2$, the result is simply \autoref{thm:contr-forall}.

  For the inductive step, let $f, g : \prd{a:A}B(a)$.
  We need to show that $\id{f}{g}$ is an $n$-type.
  By function extensionality and closure of $n$-types under equivalence, it suffices to show that $\prd{a : A} (\id[B(a)]{f(a)}{g(a)})$ is an $n$-type.
  But this follows from the inductive hypothesis.
\end{proof}

As a special case of the above theorem, the function space $A \to B$ is an $n$-type provided that $B$ is an $n$-type.
We can now generalize our observations in \autoref{cha:basics} that $\isset(A)$ and $\isprop(A)$ are mere propositions.

\begin{thm}\label{thm:isaprop-isofhlevel}
 For any $n \geq -2$ and any type $X$, the type $\istype{n}(X)$ is a mere proposition.
\end{thm}
\begin{proof}
  We proceed by induction with respect to $n$.

 For the base case, we need to show that for any $X$, the type $\iscontr(X)$ is a mere proposition.
 By \autoref{thm:contr-unit}, it suffices to show that if $X$ is contractible, then $\iscontr(X)$ is a mere proposition.
 But this follows from \autoref{thm:contr-contr}.

For the inductive step we need to show
\[\prod_{X : \type} \isprop (\istype{n}(X)) \to \prod_{X : \type} \isprop (\istype{\nplusone}(X)) \]
To show the conclusion of this implication, we need to show that for any type $X$, the type
    \[\prod_{x, x' : X}\istype{n}(x = x')\]
is a mere proposition. By \autoref{thm:hlevel-prod} it suffices to show that for any $x, x' : X$, the type $\istype{n}(x =_X x')$ is a mere proposition.
But this follows from the induction hypothesis applied to the type $(x =_X x')$.
\end{proof}

Finally, we show that the type of $n$-types is itself an $\nplusone$-type.
We define this to be:
\[\ntype{n} \defeq \sm{X : \type} \istype{n}(X) \]
In particular, we have $\prop \defeq \ntype{(-1)}$ and $\set \defeq \ntype{0}$, as defined in \autoref{cha:basics}.
Note that just as for \prop and \set, because $\istype{n}(X)$ is a mere proposition, for any $(X,p), (X',p'):\ntype{n}$ we have
\[ (\id[\ntype{n}]{(X, p)}{(X', p')}) \;\simeq\; (\id[\type] X X') \;\simeq\; (\eqv{X}{X'}).\]
by \autoref{thm:path-subset}.

\begin{thm}\label{thm:hleveln-of-hlevelSn}
 For any $n \geq -2$, the type $\ntype{n}$ is an $\nplusone$-type.
\end{thm}
\begin{proof}[Proof of \autoref{thm:hleveln-of-hlevelSn}]
  Let $(X, p), (X', p') : \ntype{n}$; we need to show that $\id{(X, p)}{(X', p')}$ is an $n$-type.
  By the above observation, this type is equivalent to $\eqv{X}{X'}$.
  Next, we observe that the projection
  \[(\eqv{X}{X'}) \hookrightarrow (X \rightarrow X').\]
  is a monomorphism, so that if $n\geq -1$, then by \autoref{thm:isntype-mono} it suffices to show that $X \rightarrow X'$ is an $n$-type.
  But since $n$-types are preserved under the arrow type, this reduces to an assumption that $X'$ is an $n$-type.

  In the case $n=-2$, this argument shows that $\eqv{X}{X'}$ is a $(-1)$-type --- but it is also inhabited, since any two contractible types are equivalent to \unit, and hence to each other.
  Thus, $\eqv{X}{X'}$ it is also a $(-2)$-type.
\end{proof}

\section{Axiom K and Hedberg's theorem}
\label{sec:hedberg}

In \autoref{sec:basics-sets} we defined a type $X$ to be a \emph{set} if for all $x, y : X$ and $p, q : x =_X y$ we have $p = q$.
In type theory this property goes by the name of \emph{uniqueness of identity proofs (UIP)}.
We have seen also that it is equivalent to being a $0$-type in the sense of the previous section.
Here is another equivalent characterization:

\begin{thm}\label{thm:h-set-uip-K}
 A type $X$ is a set if and only if it satisfies \emph{Axiom K}: for all $x : X$ and $p : (x =_A x)$ we have $p = \refl{x}$.
\end{thm}

\begin{proof}
  Clearly Axiom K is a special case of UIP.
  Conversely, if $X$ satisfies Axiom K, let $x, y : X$ and $p, q : (\id{x}{y})$; we want to show $p=q$.
  But induction on $q$ reduces this goal precisely to Axiom K.
\end{proof}

\begin{thm}\label{thm:h-set-refrel-in-paths-sets}
  Suppose the identity on $X$ contains a mere reflexive relation $R$. Then $R(x,y)$ is
  equivalent to $\id[X]{x}{y}$ and so $X$ is a set.
\end{thm}

\begin{proof}
Let $\rho$ be a witness of the reflexivity of $R$ and let $f : \prd{x,y:X} R(x,y)
\to x = y$. To show that each $f(x,y)$ is an equivalence, it suffices to show that~$f$
induces an equivalence of total spaces:
\begin{equation*}
\eqv{\sm{y:X}R(x,y)}{\sm{y:X}x=y}.
\end{equation*}
Note that the type on the right is contractible, so we have to show that
$\sm{y:X}R(x,y)$ is contractible. As the center of contraction we take the
term $\pairr{x,\rho(x)}$ and it remains to show that
\begin{equation*}
\prd{y:X}{H:R(x,y)}\pairr{y,H}=\pairr{x,\rho(x)}.
\end{equation*}
Since $R$ is propositional, the above type is equivalent to the type
\begin{equation*}
\prd{y:X}R(x,y)\to y=x,
\end{equation*}
which we get from our assumption $f$ and from symmetry of identity.
\end{proof}

Another convenient way to show that a type is a set is by way of the following property.

\begin{defn}\label{defn:decidable-equality}
 A type $X$ has \textbf{decidable equality} if for all $x, y : X$ we have
 \[(x =_X y) + \neg (x =_X y).\]
\end{defn}

In the propositions-as-types language, we can say that $X$ has decidable equality if for every $x,y:X$, either $x=y$ or $x\neq y$.
Note that this is a very constructive form of ``or''.
LEM implies that \emph{any} type $X$ has \emph{decidable mere equality}, meaning
\[\prd{x,y:X} \big(\brck{x=y} + \brck{x\neq y}\big).\]
\autoref{defn:decidable-equality} asserts moreover that a path $x=y$ can be chosen, when it exists, continuously (or computably, or functorially) in $x$ and $y$.
This has the following strong consequence.

\begin{thm}[Hedberg]\label{thm:hedberg}
  If $X$ has decidable equality, then $X$ is a set.
\end{thm}

\begin{proof}
Fix $x : X$ and assume that for all $y : Y$ we have
  \[\alpha(y) : (x = y) + \neg (x = y). \]
  For any $y : Y$ we define
      $  \eta_y : (x = y) \to (x = y) $
    by
    \[ \eta_y(p) := \begin{cases}
                     q & \text{ if } \alpha(y) = \inl(q) \\
                     \mathsf{elim}_\emptyt(f(p)) & \text{ if } \alpha(y) = \inr(f).
                    \end{cases}
\]

(Recall that $\emptyt$-elimination allows us to conclude anything, given an element of $\emptyt$.)

\noindent
 By case analysis we see that for any $p, p' : x = y$ we have
 \begin{equation}\eta_y(p) = \eta_y(p') . \label{eq:eqdec-eta}\end{equation}

 \noindent
 Next, we prove that for any $y : Y$, the map $\eta_y$ has a left inverse $\theta_y$.
   Once we have this left inverse $\theta_y$, we obtain the desired result as follows: given
     $p, p' : x = y$, we have
   \[ p = \theta_y (\eta_y(p)) \stackrel{\eqref{eq:eqdec-eta}}{=} \theta_y (\eta_y(p')) = p' . \]
 Define $\theta_y$ by
     $\theta_y(q) \defeq \opp{\eta_x(\refl{}(x))} \ct q$.
  Finally, we prove $\theta_y(\eta_y(p)) = p$ by path induction on $p$:
   \[\theta_x(\eta_x(\refl{}(x))) = \opp{\eta_x(\refl{}(x))} \ct \eta_x(\refl{}(x)) = \refl{}(x). \qedhere \]
\end{proof}

There is, of course, a strong connection between this theorem and \autoref{thm:not-lem}.
The form of LEM denied by \autoref{thm:not-lem} clearly implies that every type has decidable equality, and hence is a set; which we know is not the case.

Recall that in \autoref{thm:nat-set} we observe that $\nat$ is a set, using our characterization of its equality types in \autoref{sec:compute-nat}.
A more traditional proof of this theorem uses only~\eqref{eq:zero-not-succ} and~\eqref{eq:suc-injective}, rather than the full characterization of \autoref{thm:path-nat}, with \autoref{thm:hedberg} to fill in the blanks.

\begin{thm}\label{prop:nat-is-set}
 The type $\Nat$ of natural numbers has decidable equality, and hence is a set.
\end{thm}

\begin{proof}
  Let $x, y : \Nat$ be given; we proceed by induction on $x$ and case analysis on $y$ to prove $(x=y)+\neg(x=y)$.
  If $x \jdeq 0$ and $y \jdeq 0$, we take $\inl(\refl{}(0))$.
  If $x \jdeq 0$ and $y \jdeq \suc(n)$, then by~\eqref{eq:zero-not-succ} we get $\neg (0 = \suc (n))$.

  For the inductive step, let $x \jdeq \suc (n)$.
  If $y \jdeq 0$, we use~\eqref{eq:zero-not-succ} again.
  Finally, if $y \jdeq \suc (m)$, the induction hypothesis gives $(m = n)+\neg(m = n)$.
  In the first case, if $p:m=n$, then $\ap \suc p:\suc(m)=\suc(n)$.
  And in the second case,~\eqref{eq:suc-injective} yields $\neg(\suc(m)=\suc(n))$.
\end{proof}

Although Hedberg's theorem appears rather special to sets ($0$-types), Axiom K generalizes naturally to $n$-types.
Note that the ordinary Axiom K states that for all $x:X$, the loop space $\Omega(X,x)$ (see \cref{def:loopspace}) is contractible.
Since $\Omega(X,x)$ is always inhabited (by $\refl{x}$), this is equivalent to its being a mere proposition (a $(-1)$-type).
Since $0 = (-1)+1$, this suggests the following generalization.

\begin{thm}\label{thm:hlevel-loops}
  For any $n\geq -1$, a type $X$ type is an $\nplusone$-type if and only if for all $x : X$, the type $\Omega(X, x)$ is an $n$-type.
\end{thm}

Before proving this, we prove an auxiliary lemma:

\begin{lem}\label{lem:hlevel-if-inhab-hlevel}
  Given $n \geq -1$ and $X : \type$.
  If, given any inhabitant of $X$ it follows that $X$ is an $n$-type, then $X$ is an $n$-type.
\end{lem}
\begin{proof}
  Let $f : X \to \istype{n}(X)$ be the given map.
  We need to show that for any $x, x' : X$, the type $\id{x}{x'}$ is an $\nminusone$-type.
  But then $f(x)$ shows that $X$ is an $n$-type, hence all its path spaces are $\nminusone$-types.
\end{proof}

\begin{proof}[Proof of \autoref{thm:hlevel-loops}]
  The ``only if'' direction is obvious, since $\Omega(X,x)\defeq (\id[X]xx)$.
  Conversely, in order to show that $X$ is an $\nplusone$-type, we need to show that for any $x, x' : X$, the type $\id{x}{x'}$ is an $n$-type.
  Following \autoref{lem:hlevel-if-inhab-hlevel} it suffices to give a map
  \[ (\id{x}{x'}) \to \istype{n}(\id{x}{x'})  .\]
  By path induction, it suffices to do this when $x\jdeq x'$, in which case it follows from the assumption that $\Omega(X, x)$ is an $n$-type.
\end{proof}

The following theorem will see how we may detect the homotopy level of a type using spheres.
The basic idea is that if $A$ is an $n$-type, then all the maps from $\Sn^{n+1}$ to $A$ are null-homotopic.

\begin{defn}
  A function $f:X\to A$ is said to be \emph{null-homotopic} if there is an $a:A$ such that $f=(\lambda x.a)$.
  In other words, we define
  \begin{equation*}
    \mathsf{hNull}(f)\defeq\sm{a:A} (f=(\lambda x.a)) .
  \end{equation*}
\end{defn}

\begin{lem}\label{lem:hnull_to_map_hnull}
If a function $f:X\to A$ is null-homotopic, then so is
\[\apfunc f : (x= y)\to (f(x)= f(y)).\]
\end{lem}

\begin{proof}
Suppose $H:\sm{a:A} (f=\lambda x.a)$.  A proof by path induction on $p:x= y$ reveals that there is a homotopy
\begin{equation*}
\apfunc{f} = \lambda p.(\pi_2 H(y))^{-1}\ct (\pi_2 H(x)).\qedhere
\end{equation*}
\end{proof}

Recall from \autoref{sec:suspension} that we can define the $n$-sphere $\Sn^n$ inductively as the suspension of the $(n-1)$-sphere, starting with $\Sn^{-1}\defeq \emptyt$.

\begin{thm}\label{thm:sphere_n_hnull_to_hlevel_sn}
For every $n:\N$, a type $A$ is an $n$-type if all the functions from $\Sn^{n+1}$ to $A$ are null-homotopic.
\end{thm}

\begin{proof}
The exact statement which we will prove is
\begin{equation*}
\prd{n:\N}{A:\type} \big(\prd{f:\Sn^n\to A} \mathsf{hNull}(f)\big)\to\istype{\nminusone}(A).
\end{equation*}
The proof is by induction on $n$.  In the case $n\jdeq 0$ we have that
\begin{equation*}
\big(\prd{f:\Sn^{0}\to A} \mathsf{hNull}(f)\big)\simeq\prd{x,y:A} (x= y),
\end{equation*}
so we see immediately that a type $A$ is a proposition whenever every function $f:\Sn^0\to A$ is null-homotopic.

Now suppose that we have a function of type
\begin{equation*}
\prd{A:\type}{f:\Sn^n\to A}{t:\Sn^n} (f(t)= f(\north^n)\big)\to\istype{\nminusone}(A).
\end{equation*}
and let $A$ be a type and let 
\begin{equation*}
H:\prd{f:\Sn^{n+1}\to A}{t:\Sn^{n+1}} (f(t)= f(\north^{n+1})).
\end{equation*}
We wish to show that $A$ is an $n$-type, which we will do by showing that $x= y$ is an $\nminusone$-type for each $x,y:A$.
Suppose that $x,y:A$; then by the induction hypothesis it suffices to show that every function $\Sn^n\to (x= y)$ is null-homotopic.
We have that $\Sn^n\to(x= y)$ is equivalent to
\[\sm{f:S^{n+1}\to A} (f(\north^{n+1})= x)\times(f(\south^{n+1})= y).\]
Suppose that $f:\Sn^n\to A$ is a function and suppose that $\tilde{f}$ corresponds to $f$ via the indicated equivalence. Then $\tilde{f}$ is null-homotopic, and hence $\lambda t.\tilde{f}(\merid^n(t))$ is null-homotopic (by \autoref{lem:hnull_to_map_hnull}).
It follows that $f$ is null-homotopic.
\end{proof}

We conclude that:
\begin{thm}\label{thm:ntype-nloop}
  For any $n\ge -1$, a type $X$ is an $n$-type if and only if $\Omega^{n+1}(X,x)$ is contractible for all $x:X$.
\end{thm}

\section{Truncations}
\label{sec:truncations}

In \autoref{subsec:prop-trunc} we introduced the propositional truncation, which makes the ``best approximation'' of a type that is a mere
proposition, i.e.\ a $(-1)$-type.
In \autoref{sec:hittruncations} we constructed this truncation as a higher inductive type, and gave one way to generalize it to a
0-truncation.
We now explain a better generalization of this, which truncates any type into an $n$-type for any $n\geq -2$.

The idea is to make use of \autoref{thm:ntype-nloop}, which states that $A$ is an $n$-type just when $\Omega^{n+1}(A,a)$ is contractible for
all $a:A$, and \autoref{lem:susp-loop-adj}, which implies that $\Omega^{n+1}(A,a) \simeq \Map_*(\Sn^{n+1},(A,a))$, where $\Sn^{n+1}$ is
equipped with some basepoint which we may as well call \base.
However, contractibility of $\Map_*(\Sn^{n+1},(A,a))$ is something that we can ensure directly by giving path constructors.

We might first of all try to define $\trunc nA$ to be generated by a function $\tproj n- : A \to \trunc n A$, together with for each $r:\Sn^{n+1} \to \trunc n A$ and each $x:\Sn^{n+1}$, a path $s_r(x):r(x) = r(\base)$.

But this does not quite work, for the same reason that \autoref{rmk:spokes-no-hub} fails.
Instead, we use the full ``hub and spoke'' construction.

Thus, we take $\trunc nA$ to be the higher inductive type generated by:
\begin{itemize}
\item a function $\tproj n- : A \to \trunc n A$,
\item for each $r:\Sn^{n+1} \to \trunc n A$, a \emph{hub} point $h(r):\trunc n A$, and
\item for each $r:\Sn^{n+1} \to \trunc n A$ and each $x:\Sn^{n+1}$, a \emph{spoke} path $s_r(x):r(x) = h(r)$.
\end{itemize}

The existence of these constructors is now enough to show:

\begin{lem}
  $\trunc n A$ is an $n$-type.
\end{lem}
\begin{proof}
  By \autoref{thm:ntype-nloop}, it suffices to show that $\Omega ^{n+1}(\trunc nA,b)$ is contractible for all $b:\trunc nA$, which by
\autoref{lem:susp-loop-adj} is equivalent to $\Map_*(\Sn^{n+1},(\trunc nA,b))$.
  As center of contraction for the latter, we choose the function $c_b:\Sn^{n+1} \to \trunc nA$ which is constant at $b$, together with $\refl b : c_b(\base) = b$.

  Now, an arbitrary element of $\Map_*(\Sn^{n+1},(\trunc nA,b))$ consists of a map $r:\Sn^{n+1} \to \trunc n A$ together with a path $p:r(\base)=b$.
  By function extensionality, to show $r = c_b$ it suffices to give, for each $x:\Sn^{n+1}$, a path $r(x)=c_b(x) \jdeq b$.
  We choose this to be the composite $s_r(x) \ct \opp{s_r(\base)} \ct p$, where $s_r(x)$ is the spoke at $x$.


  Finally, we must show that when transported along this equality $r=c_b$, the path $p$ becomes $\refl b$.
  By transport in path types, this means we need
  \[\opp{(s_r(\base) \ct \opp{s_r(\base)} \ct p)} \ct p = \refl b.\]
  But this is immediate from path operations.
\end{proof}

To show the desired universal property of the $n$-truncation, we need the induction principle.
We extract this from the constructors in the usual way; it says that given $P:\trunc nA\to\type$ together with
\begin{itemize}
\item For each $a:A$, an element $g(a) : P(\tproj na)$,
\item For each $r:\Sn^{n+1} \to \trunc n A$ and $r':\prd{x:\Sn^{n+1}}, P(r(x))$, an element $h'(r,r'):P(h(r))$.
\item For each $r:\Sn^{n+1} \to \trunc n A$ and $r':\prd{x:\Sn^{n+1}}, P(r(x))$, and each $x:\Sn^{n+1}$, a dependent path $\dpath{P}{s_r(x)}{r'(x)}{h'(r,r')}$.
\end{itemize}

\begin{thm}\label{thm:truncn-ind}
  For any type family $P:\trunc n A \to \type$ such that each $P(x)$ is an $n$-type, and any function $g : \prd{a:A} P(\tproj n a)$, there
exists a section $f:\prd{x:\trunc n A} P(x)$ such that $f(\tproj n a)\defeq g(a)$ for all $a:A$.
\end{thm}
\begin{proof}
  It will suffice to construct the second and third data listed above, since $g$ has exactly the type of the first datum.
  Given $r:\Sn^{n+1} \to \trunc n A$ and $r':\prd{x:\Sn^{n+1}}, P(r(x))$, we have $h(r):\trunc n A$ and $s_r :\prd{x:\Sn^{n+1}} (r(x) = h(r))$.
  Define $t:\Sn^{n+1} \to P(h(r))$ by $t(x) \defeq \trans{s_r(x)}{r'(x)}$.
  Then since $P(h(r))$ is $n$-truncated, there exists a point $u:P(h(r))$ and a contraction $v:\prd{x:\Sn^{n+1}} (t(x) = u)$.
  Define $h'(r,r') \defeq u$, giving the second datum.
  Then (recalling the definition of dependent paths), $v$ has exactly the type required of the third datum.
\end{proof}

In particular, if $E$ is some $n$-type, we can consider the constant family of types equal to $E$ for every point of $A$.
Thus, every map $f:A\to{}E$ can be extended to a map $\extend{f}:\trunc nA\to{}E$ defined by $\extend{f}(\tproj na)\defeq f(a)$.
The induction principle also implies a nondependent $\eta$-rule, which says that if $E$ is an $n$-type and $g,g':\trunc nA\to{}E$ are such
that $g(\tproj na)=g'(\tproj na)$ for every $a:A$, then $g(x)=g'(x)$ for all $x:\trunc nA$; hence $g=g'$.
This implies the following universal property.

\begin{lem}[Universal property of truncations]\label{thm:trunc-reflective}
  Let $n\ge-2$, $A:\type$ and $B:\typele{n}$. The following map is an
  equivalence:
  \[\function{(\trunc nA\to{}B)}{A\to{}B}{g}{g\circ\tprojf n}\]
\end{lem}

\begin{proof}
  Given that $B$ is $n$-truncated, any $f:A\to{}B$ can be extended to a map $\extend{f}:\trunc nA\to{}B$.
  The map $\extend{f}\circ\tprojf n$ is equal to $f$, because for every $a:A$ we have $\extend{f}(\tproj na)=f(a)$ by definition.
  And the map $\extend{g\circ\tprojf n}$ is equal to $g$, because they both send $\tproj na$ to $g(\tproj na)$.
\end{proof}

We can characterize the path spaces of a truncation using the same method that we used in \autoref{sec:compute-coprod,sec:compute-nat} for
coproducts and natural numbers (and which we will use in \autoref{cha:homotopy} to calculate homotopy groups).
Unsurprisingly, the path spaces in the $(n+1)$-truncation of $A$ are the $n$-truncations of the path spaces of $A$.
Indeed, for any $x,y:A$ there is a canonical map
\begin{equation}
  f:\ttrunc n{x=_Ay}\to \Big(\tproj {n+1}x=_{\trunc{n+1}A}\tproj {n+1}y\Big)\label{eq:path-trunc-map}
\end{equation}
defined by
\[f(\tproj n{p})\defeq \apfunc{\tproj {n+1}-}(p). \]
This definition uses the recursion principle for $\trunc n-$, which is correct because $\trunc {n+1}A$ is $(n+1)$-truncated, so that the
codomain of $f$ is $n$-truncated.

\begin{thm}
  For any $A$ and $x,y:A$ and $n\ge -2$, the map~\eqref{eq:path-trunc-map} is an equivalence; thus we have
  \[ \eqv{\ttrunc n{x=_Ay}}{\Big(\tproj {n+1}x=_{\trunc{n+1}A}\tproj {n+1}y\Big)}. \]
\end{thm}

\begin{proof}
  As in previous situations, we cannot directly define a quasi-inverse to~\eqref{eq:path-trunc-map} because there is no way to induct on an
equality between $\tproj {n+1}x$ and $\tproj {n+1}y$.
  Thus, instead we generalize its type, in order to have general elements of the type $\trunc{n+1}A$ instead of $\tproj {n+1}x$ and $\tproj
{n+1}y$.
  Define $P:\trunc {n+1}A\to\trunc {n+1}A\to\typele{n}$ by
  \[P(\tproj {n+1}x,\tproj {n+1}y)\defeq \trunc n{x=_Ay}\]
  This definition is correct because $\trunc n{x=_Ay}$ is $n$-truncated, and $\typele{n}$ is $(n+1)$-truncated by
\autoref{thm:hleveln-of-hlevelSn}.
  Now for every $u,v:\trunc{n+1}A$, there is a map
  \[\encode:P(u,v) \to \big(u=_{\trunc{n+1}A}v\big)\]
  defined for $u=\tproj {n+1}x$ and $v=\tproj {n+1}y$ and $p:x=y$ by
  \[\encode(\tproj n{p})\defeq \apfunc{\tproj{n+1}-} (p).\]
  Since the codomain of $\encode$ is $n$-truncated, it suffices to define it only for $u$ and $v$ of this form, and then it's just the same
definition as before.
  We also define a function
  \[ r : \prd{u:\trunc{n+1} A} P(u,u) \]
  by induction on $u$, where $r(\tproj{n+1} x) \defeq \tproj n {\refl x}$.

  Now we can define an inverse map
  \[\decode: (u=_{\trunc{n+1}A}v) \to P(u,v)\]
  by
  \[\decode(p) \defeq \transfib{v\mapsto P(u,v)}{p}{r(u)}. \]
  To show that the composite
  \[ (u=_{\trunc{n+1}A}v) \xrightarrow{\decode} P(u,v) \xrightarrow{\encode} (u=_{\trunc{n+1}A}v) \]
  is the identity function, by path induction it suffices to check it for $\refl u : u=u$, in which case what we need to know is that
$\decode(r(u)) = \refl{u}$.
  But since this is an $n$-type, hence also an $(n+1)$-type, we may assume $u\jdeq \tproj {n+1} x$, in which case it follows by definition
of $r$ and $\decode$.
  Finally, to show that 
  \[ P(u,v) \xrightarrow{\encode} (u=_{\trunc{n+1}A}v) \xrightarrow{\decode} P(u,v) \]
  is the identity function, since this goal is again an $n$-type, we may assume that $u=\tproj {n+1}x$ and $v=\tproj {n+1}y$ and that we are
considering $\tproj n p:P(\tproj{n+1}x,\tproj{n+1}y)$ for some $p:x=y$.
  Then we have
  \begin{align*}
    \decode(\encode(\tproj n p)) &= \decode(\apfunc{\tproj{n+1}-}(p))\\
    &= \transfib{v\mapsto P(\tproj{n+1}x,v)}{\apfunc{\tproj{n+1}-}(p)}{\tproj n {\refl x}}\\
    &= \transfib{v\mapsto \trunc n{u=v}}{p}{\tproj n {\refl x}}\\
    &= \tproj n {\transfib{v \mapsto (u=v)}{p}{\refl x}}\\
    &= \tproj n p.
  \end{align*}
  This completes the proof that \encode and \decode are quasi-inverses.
  The stated result is then the special case where $u=\tproj {n+1}x$ and $v=\tproj {n+1}y$.
\end{proof}

\begin{cor}
  Let $n\ge-2$ and $(A,a)$ be a pointed type. Then
  \[\trunc n{\Omega(A,a)}=\Omega(\trunc{n+1}{(A,a)})\]
\end{cor}
\begin{proof}
  This is a special case of the previous lemma where $x=y=a$.
\end{proof}

\begin{cor}
  Let $n\ge -2$ and $k\ge 0$ and $(A,a)$ a pointed type.  Then
  \[\trunc n{\Omega^k(A,a)} = \Omega^k(\trunc{n+k}{(A,a)}). \]
\end{cor}
\begin{proof}
  By induction on $k$, using the recursive definition of $\Omega^k$.
\end{proof}

We also observe that ``truncations are cumulative'': if we truncate to an $n$-type and then to a $k$-type with $k\le n$, then we might as
well have truncated directly to a $k$-type.

\begin{lem}
  Let $k,n\ge-2$ with $k\le{}n$ and $A:\type$. Then
  $\trunc k{\trunc nA}=\trunc kA$.
\end{lem}
\begin{proof}
  We define two maps $f:\trunc k{\trunc nA}\to\trunc kA$ and
  $g:\trunc kA\to\trunc k{\trunc nA}$ in the following way:

  \[f(\tproj k{\tproj na})=\tproj ka\]
  \[g(\tproj ka)=\tproj k{\tproj na}\]

  The map $f$ is well-defined because $\trunc kA$ is $k$-truncated and also
  $n$-truncated (because $k\le{}n$), and the map $g$ is well-defined because
  $\trunc k{\trunc nA}$ is $k$-truncated.

  The composition $f\circ{}g:\trunc kA\to\trunc kA$ satisfy
  $(f\circ{}g)(\tproj ka)=\tproj ka$ hence $f\circ{}g=\idfunc[\trunc kA]$, and
  we also have $g\circ{}f=\idfunc[\trunc k{\trunc nA}]$ in the same way.
\end{proof}

% \begin{lem}
%   We have $\trunc n{\unit}=\unit$.
% \end{lem}
% \begin{proof}
%   Indeed, $\unit$ is $n$-truncated for every $n$ hence $\trunc n{\unit}=\unit$ by
%   \autoref{reflectPequiv}.
% \end{proof}


\section{Reflective subuniverses}
\label{subsec:reflective-subuniverses}

So far, in this chapter, we have focused on $n$-types and the $n$-truncation operation.
In fact, $n$-types and their truncation are a special case of a more general notion called a \emph{reflective subuniverse}, and many of
their properties can be proven formally in this generality.

\begin{defn}
  A \textbf{subuniverse} of \type is a predicate $P:\type \to \prop$.
  We write
  \[\P \defeq \sm{A:\type} P(A).\]
\end{defn}

An inhabitant of $\P$ is a pair $(A,s)$ with $A:\type$ and $s:P(A)$, but we will often simply write it as $A$.
Thus $A:\P$ means that $A:\type$ and $P(A)$ holds.
For instance, $P$ could be \isprop, \isset, or more generally $\istype{n}$ for any $n\ge-2$, in which case \P would be \prop, \set, or
$\typele{n}$.
On the other hand, if $P(A)\defeq \unit$, then every type lies in \P, i.e.\ $\P=\type$.

\begin{defn}
  A subuniverse $\P$ of $\type$ is a \textbf{reflective subuniverse} if
  for every $A:\type$ we have a type $\reflect(A):\P$ and a map
  $\project_A:A\to\reflect(A)$ such that for every $A:\type$ and $B:\P$, the following map is an equivalence:
  \[\function{(\reflect(A)\to{}B)}{(A\to{}B)}{f}{f\circ\project_A}.\]
\end{defn}

In particular, this implies that for every $B:\P$ and $g:A\to{}B$ there is a unique map $\ext(g):\reflect(A)\to{}B$ making the following
diagram commute (up to homotopy, of course).
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
\xymatrix{A \ar^{\project_A}[r] \ar_g[rd] \druppertwocell{=} & \reflect(A)
  \ar@{-->}^{\ext(g)}[d] \\
  & B}\]

The universal property means that $\reflect$ is left adjoint to the inclusion
$\iota:\P\to\type$ with $\project_A$ as the unit, because the last $B$ in the
universal property can be replaced by $\iota(B)$ given that $B$ is in $\P$.

One example is truncations, as defined in \autoref{sec:truncations}.
\begin{lem}[Truncations are reflective]
  $\typele{n}$ is a reflective subuniverse of $\type$, with $\reflect$
  given by $\trunc{n}{-}$.
\end{lem}
\begin{proof}
  Immediate from the universal property of truncations, \autoref{thm:trunc-reflective}.
\end{proof}

\begin{lem}
  Let \P be a subuniverse of \type. The assertion that \P is reflective is \anhprop.
\end{lem}

\begin{proof}
  Let's assume that \P is reflective in two different ways
  $(\reflect,\project,\ext)$ and $(\reflect',\project',\ext')$. We need to
  construct an equivalence between $\reflect(A)$ and $\reflect'(A)$ for every
  $A:\type$, and we need to prove that the following diagram commutes:
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{A \ar^{\project_A}[r] \ar_{\project'_A}[rd] \druppertwocell{=} &
    \reflect(A) \ar@{->}^\sim[d] \\
    & \reflect'(A)}\]
  (We can ignore the components $\ext$ and $\ext'$, since they belong to mere propositions---the assertion that precomposing with $\project$
and $\project'$ are equivalences.)

  Now the type $\reflect'(A)$ is in \P, so we can define the map
  \[\ext(\project'_A):\reflect(A)\to\reflect'(A)\]
  which is exactly the map making the previous diagram commute.
  We can also define
  \[\ext'(\project_A):\reflect'(A)\to\reflect(A).\]
  In order to prove that the composite is the identity, we only need to prove
  that $\ext'(\project_A)\circ\ext(\project'_A)\circ\project_A=\project_A$,
  which is the case:
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{A \ar^{\project_A}[r] \ar_{\project'_A}[rd]
    \ar@/_5mm/_{\project_A}[rdd] &
    \reflect(A) \ar@{->}^{\ext(\project'_A)}[d] \\
    & \reflect'(A) \ar@{->}^{\ext'(\project_A)}[d] \\
    & \reflect(A)}\]
  The other composite is just as easy.
  Thus, $\ext'(\project_A)$ is a quasi-inverse of $\ext(\project'_A)$, so the latter is an equivalence as desired.
\end{proof}

For the rest of this section, we assume that $\P$ is a reflective subuniverse of
$\type$.

The following lemma says that the counit of the adjunction is an equivalence, as expected for a reflection.
\begin{lem}
  \label{reflectPequiv}
  If $A:\P$, then the map $\project_A:A\to\reflect(A)$ is an equivalence.
\end{lem}
\begin{proof}
  Given that $A$ is in $\P$, we can define $\ext(\idfunc[A]):\reflect(A)\to{}A$.

  Then we have $\ext(\idfunc[A])\circ\project_A=\idfunc[A]:A\to{}A$ by
  definition.  In order to prove that
  $\project_A\circ\ext(\idfunc[A])=\idfunc[\reflect(A)]$, we only need to prove
  that $\project_A\circ\ext(\idfunc[A])\circ\project_A=
  \idfunc[\reflect(A)]\circ\project_A$.
  This is again true:
  \[\xymatrix{
    A \ar^{\project_A}[r] \ar_{\idfunc[A]}[rd] &
    \reflect(A) \ar^>>>{\ext(\idfunc[A])}[d] \ar@/^40pt/^{\idfunc[\reflect(A)]}[dd] \\
    & A \ar_{\project_A}[d] \\
    & \reflect(A)}\]
\end{proof}

Note that the converse is always true: if $\project_A$ is an equivalence, then $A:\P$.
This is easy using univalence and the fact that $\reflect(A):\P$.

The reflector $\reflect$ is a map $\type\to\P$, which (like any map in type theory) is a functor of $\infty$-groupoids.
Using the universal property, we should be able to prove that $\reflect$ is in fact $(\infty,1)$-functorial, i.e.\ preserves composition of
(not necessarily invertible) functions up to all higher homotopies.
But we don't know how to express $(\infty,1)$-functoriality all at once, so we will only prove a few bits of it.

\begin{defn}
  If $f:A\to{}B$, there is a map $\reflect(f):\reflect(A)\to\reflect(B)$ defined
  by
  \begin{equation}
    \reflect(f)\circ\project_A=\project_B\circ{}f\label{eq:project-natural}
  \end{equation}
  (or in other words $\reflect(f)=\ext(\project_B\circ{}f)$).
\end{defn}

\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
\xymatrix{A \ar^-{\project_A}[r] \ar_-f[d] \drtwocell{=} & \reflect(A)
  \ar@{-->}^-{\reflect(f)}[d]
  \\ B \ar_-{\project_B}[r] & \reflect(B)}\]

Moreover, this operation satisfies the following functoriality conditions:
  \begin{align*}
    \reflect(\idfunc[A])=\idfunc[\reflect(A)]\\
    \reflect(f\circ{}g)=\reflect(f)\circ\reflect(g)
  \end{align*}
  In order to define these equalities, we only need to define them after
  composition by $\project(A)$, because of the universal property.
  The first is defined by
  \[\xymatrix{
    \reflect(\idfunc[A])\circ\project_A \ar@{==}[r] \ar@{=}[d] &
    \idfunc[\reflect(A)]\circ\project_A \ar@{=}[d] \\
    \project_A \ar@{=}[r] & \project_A
  }\]
  The second one is defined by
  \[\xymatrix{
    \reflect(f\circ g)\circ\project_A \ar@{==}[r] \ar@{=}[d] &
    \reflect(f)\circ\reflect(g)\circ\project_A \ar@{=}[d] \\
    \project_C\circ f\circ g \ar@{=}[r] & \reflect(f)\circ\project_B\circ g
  }\]

% \begin{proof}
%   The map $\reflect(f)$ is defined to be the unique map
%   $\reflect(A)\to\reflect(B)$ such that
%   $\reflect(f)\circ\project_A=\project_B\circ{}f$ (using the universal property
%   of $\reflect$), or in other words $\reflect(f)=\ext(\project_B\circ{}f)$.

%   \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
%   \xymatrix{A \ar^-{\project_A}[r] \ar_-f[d] \drtwocell{=} & \reflect(A)
%     \ar@{-->}^-{\reflect(f)}[d]
%     \\ B \ar_-{\project_B}[r] & \reflect(B)}\]
%   In order to prove that $\reflect(\idfunc[A])=\idfunc[\reflect(A)]$, we only
%   need to prove that
%   $\reflect(\idfunc[A])\circ\project_A=\idfunc[\reflect(A)]\circ\project_A$. But
%   both sides are equal to $\project_A$.

%   Similarly, to prove that $\reflect(f\circ{}g)=\reflect(f)\circ\reflect(g)$ we
%   only need to prove that $\reflect(f\circ{}g)\circ\project_A=
%   \reflect(f)\circ\reflect(g)\circ\project_A$ and both sides are equal to
%   $\project_C\circ{}f\circ{}g$.

%   Note that by definition, the following diagram commutes:

%   \[\xymatrix{
%     \reflect(f\circ g)\circ\project_A \ar@{=}[r] \ar@{=}[d] &
%     \reflect(f)\circ\reflect(g)\circ\project_A \ar@{=}[d] \\
%     \project_C\circ f\circ g \ar@{=}[r] & \reflect(f)\circ\project_B\circ g
%     }\]
% \end{proof}

Note also that the defining equation~\eqref{eq:project-natural} asserts the first level of $(\infty,1)$-naturality for the transformation $\project$.
This implies a generalization of \autoref{thm:h-level-retracts}.

\begin{lem}\label{thm:reflsubuniv-retract}
  A reflective subuniverse is closed under retractions.
  That is, if $B$ is in $\P$ and $A$ is a retract of $B$, then $A$ is in $\P$.
\end{lem}
\begin{proof}
  By functoriality and naturality, $\project_A$ is a retract of $\project_B$ (as functions).
  But $\project_B$ is an equivalence, hence so is $\project_A$; thus $A$ is in $\P$.
  \note{Should mention somewhere that equivalences are closed under retracts.}
\end{proof}

We also have the following ``functoriality'' property for the factorizations.

\begin{defn}
  Given types $A,B:\type$ and any $C:\P$, for any functions $f:A\to{}B$ and $i:B\to{}C$ we have
  \[\ext(i\circ{}f)=\ext(i)\circ\reflect(f)\]

  \[\xymatrix{
    A \ar^{\project_A}[r] \ar_f[d] & \reflect(A) \ar^{\reflect(f)}[d]
    \ar@/^15mm/^{\ext(i\circ f)}[dd] \\
    B \ar^{\project_B}[r] \ar_i[rd] & \reflect(B) \ar^{\ext(i)}[d] \\
    & C}\]

  This equality is defined by
  \[\xymatrix{
    \ext(i\circ f)\circ\project_A \ar@{==}[r] \ar@{=}[d] &
    \ext(i)\circ\reflect(f)\circ\project_A \ar@{=}[d] \\
    i\circ f \ar@{=}[r] & \ext(i)\circ\project_B\circ f
  }\]

\end{defn}

% \begin{proof}
%   \[\xymatrix{A \ar^{\project_A}[r] \ar_f[d] & \reflect(A) \ar^{\reflect(f)}[d]
%     \\
%     B \ar^{\project_B}[r] \ar_i[d] & \reflect(B) \ar^{\ext(i)}[ld] \\
%     C &}\]

%   We only have to prove that
%   \[\ext(i\circ{}f)\circ\project_A=\ext(i)\circ\reflect(f)\circ\project_A\]
%   which is the case, because they are both equal to $i\circ{}f$.
% \end{proof}

\section{Localizations}
\label{sec:localizations}

[Where does this go?]


\section{Limits in reflective subuniverses}
\label{sec:pullbacks}

In \autoref{sec:universal-properties} we observed that certain type forming operations have universal properties in the $(\infty,1)$-category of types.
For instance, we had an equivalence
\[ \eqvspaced{(X\to A\times B) }{(X\to A)\times (X\to B)}. \]
We can ask for objects in any subuniverse with similar universal properties, for instance:

\begin{defn}
  Let $A,B:\P$, with $\P$ any subuniverse.
  A \textbf{product} of $A$ and $B$ in $\P$ is an object $C:\P$ together with functions $p:C\to A$ and $q:C\to B$ such that for any $X:\P$, the induced map
  \[ (X\to C) \to (X\to A)\times (X\to B) \]
  is an equivalence.
\end{defn}

Of course, if the product type $A\times B$ lies in $\P$, then it is a product of $A$ and $B$ in $\P$.
As usual in category theory, if the subuniverse is reflective, then this is automatic.

\begin{thm}\label{thm:reflsubuniv-prod}
  If $\P$ is a reflective subuniverse and $A,B:\P$, then $A\times B$ is also in $\P$.
  Therefore, any pair of objects in $\P$ has a product in $\P$.
\end{thm}
\begin{proof}
  Since $A,B:\P$, the projections $\proj1:A\times B\to A$ and $\proj2:A\times B\to B$ factor uniquely through $\reflect(A\times B)$, yielding $\ext(\proj1)$ and $\ext(\proj2)$.
  But now by the universal property of $A\times B$, we have a unique map $h:\reflect(A\times B) \to A\times B$ such that $\proj1 \circ h = \ext(\proj1)$ and $\proj2\circ h = \ext(\proj2)$.
  It follows that $h$ is a retraction of $\project_{A\times B}$.
  Thus, $A\times B$ is a retract of $\reflect(A\times B)$, hence by \autoref{thm:reflsubuniv-retract} it is in $\P$.
\end{proof}

A similar argument shows that $\unit$ is in every reflective subuniverse.
Somewhat more interesting is the case of (homotopy) pullbacks, which requires some more definitions to state precisely.

\begin{defn}
  A \emph{cospan} in $\P$ is a diagram of the following form
  \[\xymatrix{& B \ar^g[d] \\ A \ar_f[r] & C}\]
  with $A,B,C:\P$.
\end{defn}

\begin{defn}
  If $\Ddiag$ is a cospan and $D:\P$, a \emph{cone over $\Ddiag$ with
    base $D$} is a triple $(i,j,h)$ such as in the following diagram:
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{D \ar^j[r] \ar_i[d] \drtwocell{^h} & B \ar^g[d] \\
    A \ar_f[r] & C
  }\]

  We denote by $\cone{\Ddiag}{D}$ the type of all such cones.
\end{defn}

The map $D\mapsto\cone{\Ddiag}{D}$ is contravariant in $D$, if $t:E\to{}D$ we
have a map
\[\function{\cone{\Ddiag}{D}}{\cone{\Ddiag}{E}}{c}{\composecone{t}{c}}\]
defined by $\composecone{t}{(i,j,h)}=(i\circ{}t,j\circ{}t,h\circ{}t)$ and this
map is (contravariantly) functorial.

\begin{defn}
  A pair $(D,c)$ where $D:\P$ and $c:\cone{\Ddiag}{D}$ is called a
  \emph{pullback} of $\Ddiag$ in \P if for all $E:\P$ the map
  \[\function{(E\to{}D)}{\cone{\Ddiag}{E}}{t}{\composecone{t}{c}}\]
  is an equivalence.
\end{defn}

As remarked earlier, pullbacks in \type can be constructed directly in the expected way.

\begin{defn}
  Let $\Ddiag$ be a cospan in $\type$. We define the following type
  \[A\times_CB=\setof{(a,b):A\times{}B | f(a) = g(b)}\]

  There is a canonical cone $c_\times=(\pi_1,\pi_2,\pi_3)$ over $\Ddiag$ with
  base $A\times_CB$ given by the following diagram
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{A\times_CB \ar^-{\pi_2}[r] \ar_{\pi_1}[d] \drtwocell{^\pi_3\ }
    & B \ar^g[d] \\ A \ar_f[r] & C}\]
  where
  \begin{align*}
    \pi_1((a,b),p)&=a\\
    \pi_2((a,b),p)&=b\\
    \pi_3((a,b),p)&=p\\
  \end{align*}
\end{defn}

\begin{lem}
  Let $\Ddiag$ be a diagram in $\type$. Then $(A\times_CB,c_\times)$ is a
  pullback of $\Ddiag$.
\end{lem}
\begin{proof}
  Given a type $E$ and a cone $c=(i,j,h):\cone{\Ddiag}{E}$ we construct a map
  $\Sn(c):E\to{}A\times_CB$ by
  \[\Sn(c)(x)=((i(x), j(x)), h(x))\]
  and we need to prove that $\composecone{\Sn(c)}{c_\times}=c$ and
  $\Sn(\composecone{t}{c_\times})=t$ for all $c:\cone{\Ddiag}{E}$ and
  $t:E\to{}A\times_CB$ and both are easy computations:
  \begin{align*}
    \composecone{\Sn(c)}{c_\times}
    &=\composecone{\Sn(c)}{(\pi_1,\pi_2,\pi_3)} \\
    &=(\pi_1\circ\Sn(c),\pi_2\circ\Sn(c),
    \pi_3\circ\Sn(c))\\
    &=(i,j,h)\\
    &=c
  \end{align*}
  \begin{align*}
    \Sn(\composecone{t}{c_\times})(x) &=
    \Sn(\pi_1\circ{}t,\pi_2\circ{}t,\pi_3\circ{}t)(x)\\
    &=(\pi_1(t(x)),\pi_2(t(x)),\pi_3(t(x)))\\
    &=t(x)\qedhere
  \end{align*}
\end{proof}

We observe in passing that pullbacks are preserved by function spaces.

\begin{defn}
  If $\Ddiag$ is a cospan and $D:\type$, then we define another
  cospan called $D\to\Ddiag$:
  \[\xymatrix{& (D\to B) \ar^{g\circ-}[d] \\ (D\to A) \ar_{f\circ-}[r] & (D\to
    C)}\]

  Similarly if $\Ddiag$ is a span and $D:\type$, then we have a
  cospan $\Ddiag\to{}D$:
  \[\xymatrix{& (B\to D) \ar^{-\circ{}g}[d] \\ (A\to D) \ar_{-\circ{}f}[r] &
    (C\to D)}\]
\end{defn}

\begin{lem}
  \label{coneispb}
  If $\Ddiag$ is a cospan and $D:\P$, then
  \[\cone{\Ddiag}{D}=(D\to{}A)\times_{(D\to{}C)}(D\to{}B)\]

  If $\Ddiag$ is a span and $D:\P$, then
  \[\cocone{\Ddiag}{D}=(A\to{}D)\times_{(C\to{}D)}(B\to{}D)\]
\end{lem}
\begin{proof}
  In both cases the map from left to right is $(i,j,h)\mapsto(i,j,\funext(h))$
  and the map from right to left is $(i,j,p)\mapsto(i,j,\happly(p))$ and they
  are inverse to each other.
\end{proof}

Finally, we have the analogous result to \autoref{thm:reflsubuniv-prod}.

\begin{thm}\label{thm:reflsubuniv-pb}
  If $A \xrightarrow{f}  C \xleftarrow{g} B$ is a cospan in a reflective $\P$, then $A\times_C B$ is also in $\P$.
\end{thm}
\begin{proof}
  Essentially just like \autoref{thm:reflsubuniv-prod}.
\end{proof}

\begin{cor}\label{thm:reflsubuniv-idtype}
  If $\P$ is reflective, then for any $A:\P$ and $x,y:A$, the identity type $(x=_A y)$ is also in $\P$.
\end{cor}
\begin{proof}
  $(x=_A y)$ is equivalent to the pullback of the diagonal function $f:A\to A\times A$, defined by $f(a)\defeq (a,a)$, and the function $g:\unit\to A\times A$, defined by $g(\ttt)\defeq (x,y)$.
\end{proof}

There is another interesting generalization of \autoref{thm:reflsubuniv-prod}.
Recall that the dependent function type $\prd{x:A} B(x)$ can also be regarded as the (possibly infinitary) cartesian product of all the types $B(x)$.

\begin{thm}\label{thm:reflsubunv-forall}
  If $B:A\to\P$ is any family of types in \P, then $\prd{x:A} B(x)$ is also in \P.
\end{thm}
\begin{proof}
  For any $x:A$, consider the function $\mathsf{ev}_x : (\prd{x:A} B(x)) \to B(x)$ defined by $\mathsf{ev}_x(f) \defeq f(x)$.
  Since $B(x)$ lies in $P$, this extends to
  \[ \ext(\mathsf{ev}_x) : \reflect(\prd{x:A} B(x)) \to B(x). \]
  Thus we can define $h:\reflect(\prd{x:A} B(x)) \to \prd{x:A} B(x)$ by $h(z)(x) \defeq \ext(\mathsf{ev}_x)(z)$.
  As before, $h$ is a retraction of $\project_{\prd{x:A} B(x)}$, so that ${\prd{x:A} B(x)}$ is in $\P$.
\end{proof}

In particular, if $B:\P$ and $A$ is any type, then $(A\to B)$ is in \P.
In categorical language, this means that any reflective subuniverse is an \textbf{exponential ideal}.
This, in turn, implies that the reflector preserves finite products.

\begin{cor}
  For any types $A$ and $B$, the induced map $\reflect(A\times B) \to \reflect(A) \times \reflect(B)$ is an equivalence.
\end{cor}
\begin{proof}
  TODO.
\end{proof}

It may seem odd that every reflective subcategory of types is automatically an exponential ideal, with a product-preserving reflector.
However, this is also the case classically in the category of \emph{sets}, for the same reasons.
It's just that this fact is not usually remarked on, since the classical category of sets---in contrast to the category of homotopy types---does not have many interesting reflective subcategories.


\section{Colimits in reflective subuniverses}
\label{sec:pushouts}

Recall that in \autoref{sec:colimits}, we used higher inductive types to define pushouts of types, and proved their universal property.
We can, of course, consider pushouts in subuniverses as well.

\begin{defn}
  A \emph{span} in $\P$ is a 5-tuple $\Ddiag=(A,B,C,f,g)$ with
  $A,B,C:\P$ and $f:C\to{}A$ and $g:C\to{}B$.
  \[\Ddiag=\xymatrix{C \ar^g[r] \ar_f[d] & B \\ A & }\]
\end{defn}

\begin{defn}
  Given a span $\Ddiag=(A,B,C,f,g)$ and a type $D:\P$, a
  \emph{cocone under $\Ddiag$ with base $D$} is a triple $(i, j, h)$ with
  $i:A\to{}D$, $j:B\to{}D$ and $h : \prod_{c:C}i(f(c))=j(g(c))$
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{C \ar^g[r] \ar_f[d] \drtwocell{^h} & B \ar^j[d] \\ A \ar_i[r] & D
  }\]

  We denote by $\cocone{\Ddiag}{D}$ the type of all such cocones.
\end{defn}

The map $D\mapsto\cocone{\Ddiag}{D}$ is $(\infty,1)$-functorial, but we don't
know how to express this internally in homotopy type theory, so we will only
prove the bits of functoriality that we need.

\begin{defn}
  Given $D,E:\P$ and a map $t:D\to{}E$, there is a map
  \[\function{\cocone{\Ddiag}{D}}{\cocone{\Ddiag}{E}}{c}{\composecocone{t}c}\]
  defined by:
  \[\composecocone{t}(i,j,h)=(t\circ{}i,t\circ{}j,\mapfunc{t}\circ{}h)\]

  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{C \ar^g[r] \ar_f[d] \drtwocell{^h} & B \ar_j[d]
    \ar@/_/^{t\circ{}j}[rdd] & \\
    A \ar^i[r] \ar@/^/_{t\circ{}i}[rrd] & D \ar[rd]|<<<<t & \\
    & & E }\]
\end{defn}

\begin{lem}
  For any types $D,E,F:\P$, functions $t:D\to{}E$, $u:E\to{}F$ and
  $c:\cocone{\Ddiag}{D}$ we have
  \[\composecocone{\idfunc[D]}c = c\]
  \[\composecocone{(u\circ{}t)}c=\composecocone{u}(\composecocone{t}c)\]
\end{lem}
\begin{proof}
  This follows easily from the unit laws and associativity of composition of
  functions and from the functoriality of $f\mapsto{}\mapfunc{f}$ which has been proved
  earlier.
\end{proof}

We can now define the notion of pushout.

\begin{defn}
  Given a span $\Ddiag$, a type $D:\P$ and a cocone
  $c:\cocone{\Ddiag}{D}$, the pair $(D,c)$ is said to be a \emph{pushout}
  of $\Ddiag$ in $\P$ if for every $E:\P$, the map
  \[\function{(D\to{}E)}{\cocone{\Ddiag}{E}}{t}{\composecocone{t}c}\]
  is an equivalence.
\end{defn}

This definition says that for every $E:\P$ and for every cocone under $\Ddiag$
with base $E$, there is an essentially unique map $D\to{}E$ such that the whole
diagram commutes, the proof of commutation being essentially unique too.

We showed in \autoref{thm:pushout-ump} that pushouts exist when $\P$ is \type itself, by giving a direct construction in terms of higher inductive types.
For a general \P, pushouts may or may not exist, but if they do, then they are unique.

\begin{lem}
  If $(D,c)$ and $(D',c')$ are two pushouts of $\Ddiag$ in $\P$, then
  $(D,c)=(D',c')$.
\end{lem}
\begin{proof}
  We first prove that the two types $D$ and $D'$ are equivalent.

  Using the universal property of $D$ with $D'$, we see that the following map is an
  equivalence
  \[\function{(D\to{}D')}{\cocone{\Ddiag}{D'}}{t}{\composecocone{t}c}\]

  In particular, there is a function $f:D\to{}D'$ satisfying $\composecocone{f}c=c'$. In the
  same way there is a function $g:D'\to{}D$ such that $\composecocone{g}c'=c$.

  In order to prove that $g\circ{}f=\idfunc[D]$ we use the universal property of
  $D$ for $D$, which says that the following map is an equivalence:
  \[\function{(D\to{}D)}{\cocone{\Ddiag}{D}}{t}{\composecocone{t}c}\]

  Using the functoriality of $t\mapsto{}\composecocone{t}c$ we see that
  \begin{align*}
    \composecocone{(g\circ{}f)}c &= \composecocone{g}(\composecocone{f}c) \\
    &= \composecocone{g}c' \\
    &= c \\
    &= \composecocone{\idfunc[D]}c
  \end{align*}
  hence
  $g\circ{}f=\idfunc[D]$, because equivalences are injective. The same argument
  with $D'$ instead of $D$ shows that $f\circ{}g=\idfunc[D']$.

  Hence $D$ and $D'$ are equal, and the fact that $(D,c)=(D',c')$ follows from
  the fact that the equivalence between $D$ and $D'$ we just defined sends $c$
  to $c'$.
\end{proof}

\begin{cor}
  The type of pushouts of $\Ddiag$ in $\P$ is \anhprop. In particular if
  pushouts merely exist then they actually exist.
\end{cor}

As in the case of pullbacks, if \P is reflective, then pushouts in \P always exist.
However, unlike the case of pullbacks, pushouts in \P are not the same as the pushouts in \type: they are obtained by applying the reflector.
Before proving this, we first need to explain how to reflect spans and cocones.
For the rest of this section, let \P be a reflective subuniverse.

\begin{defn}
  Let
  \[\Ddiag=\xymatrix{C \ar^g[r] \ar_f[d] & B \\ A & }\]
  be a span in $\type$. We note $\reflect(\Ddiag)$ the following
  span in $\P$:
  \[\reflect(\Ddiag)=\xymatrix{\reflect(C) \ar^{\reflect(g)}[r]
    \ar_{\reflect(f)}[d] & \reflect(B) \\ \reflect(A) & }\]
\end{defn}

\begin{defn}
  Let $D:\type$ and $c=(i,j,h):\cocone{\Ddiag}{D}$.
  We define
  \[\reflect(c)=(\reflect(i),\reflect(j),\reflect(h)):
  \cocone{\reflect(\Ddiag)}{\reflect(D)}\]
  where
  \[\reflect(h):\prod_{c:\reflect(C)}\reflect(i)(\reflect(f)(c))=\reflect(j)(\reflect(g)(c))\]
  is defined in the following way:

  We have \[h:\prod_{c:C}i(f(c))=j(g(c))\]
  hence
  \[\funext(h):i\circ{}f=j\circ{}g\]
  We can apply $\reflect$ and we get
  \[\mapfunc{\reflect}(\funext(h)):\reflect(i\circ{}f)=\reflect(j\circ{}g)\]
  Now we can compose with the fact that $\reflect$ commutes with composition and
  we get the following (the proofs that $\reflect$ commutes with composition are
  not written in order to keep terms readable, we will later see that they don't
  get in the way):
  \[\mapfunc{\reflect}(\funext(h)):
  \reflect(i)\circ\reflect(f)=\reflect(j)\circ\reflect(g)\]
  and then
  \[\reflect(h)\defeq\happly(\mapfunc{\reflect}(\funext(h))):
  \prod_{c:\reflect(C)}\reflect(i)(\reflect(f)(c))=\reflect(j)(\reflect(g)(c))\]
\end{defn}

\begin{lem}
  \label{reflectcommutespushout}
  Let $\Ddiag$ be a span in $\type$ and $(D,c)$ a pushout of $\Ddiag$
  in $\type$. Then $(\reflect(D),\reflect(c))$ is a pushout of
  $\reflect(\Ddiag)$ in $\P$.
\end{lem}

\begin{proof}
  Let $E:\P$ and let's consider the following diagram:

  \[\xymatrix{ (\reflect(D)\to E)
    \ar^{t\mapsto{}\composecocone{t}{\reflect(c)}}[r] \ar_{f_1}^\sim[d]
    &
    \cocone{\reflect(\Ddiag)}{E}\\
    (D\to E) \ar_{f_2}^\sim[d] &
    (\reflect(A)\to{}E)\times_{(\reflect(C)\to{}E)}(\reflect(B)\to{}E)
    \ar_{f_5}^\sim[u] \\
    \cocone{\Ddiag}{E}\ar_-{f_3}^-\sim[r] & (A\to{}E)\times_{(C\to{}E)}(B\to{}E)
    \ar_{f_4}^\sim[u] }\]

  We need to prove that the top arrow is an equivalence, we will do this by
  proving that it is a composite of five equivalences.

  The first equivalence, $f_1$, comes from the universal property of $\reflect$ and the fact
  that $E$ is in \P:
  \[f_1(t) \defeq t\circ\project_D.\]

  The second equivalence comes from the universal property of $(D,c)$, as a pushout of
  $\Ddiag$ in \type:
  \[f_2(u) \defeq (u\circ{}i,u\circ{}j,\mapfunc{u}\circ{}h).\]

  The third map comes from \autoref{coneispb}, and is defined by
  \[f_3(i,j,h) \defeq (i,j,\funext(h)).\]

  The fourth map comes from the universal property of $\reflect$ applied three
  times and the fact that pullbacks are invariant under equivalence (everything
  is invariant under equivalence anyway):
  \[f_4(i,j,p) \defeq (\ext(i),\ext(j),\mapfunc{\ext}(p)).\]

  Note that $\mapfunc{\ext}(p)$ has type $\ext(i\circ{}f)=\ext(j\circ{}g)$
  instead of $\ext(i)\circ\reflect(f)=\ext(j)\circ\reflect(g)$ but we
  (implicitely) concatenate with the proofs that
  $\ext(i\circ{}f)=\ext(i)\circ\reflect(f)$ and the same for $j$ and $g$. Again,
  we will see later that these proof do not get in the way.

  The fifth equivalence comes from \autoref{coneispb}, and is defined by
  \[f_5(a,b,q) \defeq (a,b,\happly(q)).\]

  We now need to prove that the diagram commutes, so we can conclude that the map
  $t\mapsto{}t\circ\reflect(c)$ is an equivalence.

  We have
  \begin{align*}
    f_5(f_4(f_3(f_2(f_1(t))))) &= f_5(f_4(f_3(f_2(t\circ\project_D)))) \\
    &= f_5(f_4(f_3(t\circ\project_D\circ{}i,t\circ\project_D\circ{}j,
    \mapfunc{(t\circ\project_D)}\circ{}h))) \\
    &=f_5(f_4(t\circ\project_D\circ{}i,t\circ\project_D\circ{}j,
    \funext(\mapfunc{(t\circ\project_D)}\circ{}h))) \\
    &=f_5(\ext(t\circ\project_D\circ{}i),\ext(t\circ\project_D\circ{}j),\\
    &\qquad\qquad\mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h)))
    \\
    &=f_5(\ext(t\circ\project_D)\circ\reflect(i),
    \ext(t\circ\project_D)\circ\reflect(j),\\
    &\qquad\qquad\mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h)))
    \\
    &=f_5(t\circ\reflect(i),
    t\circ\reflect(j),
    \mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h))) \\
    &=(t\circ\reflect(i),t\circ\reflect(j),
    \happly(\mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h))))
  \end{align*}

  Note that in the two steps before the last equality we are using the fact
  that if $a=a'$ and $b=b'$, then $(a,b,q)=(a',b',q)$. This is actually not
  even well typed given that the type of $q$ depends on $a$ and $b$, so we
  have to transport $q$ along the proofs $p:a=a'$ and $q:b=b'$. In the present
  case we have $q:a\circ\reflect(f)=b\circ\reflect(g)$ hence the correct
  statement is
  \[(a,b,q)=(a',b',q')\] where
  \[q'\defeq\map{(\lambda{}u.\,u\circ\reflect(f))}{\rev p} \ct q \ct
  \map{(\lambda{}u.\,u\circ\reflect(g))}{p'})\] Again we will leave this
  implicit and take care of it only when it will be needed.

  \bigskip

  In order to prove that the diagram commutes, we now only need to prove that
  \begin{align*}
    \happly(\mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h))) &=
    \mapfunc{t}\circ\reflect(h)
  \end{align*}
  This is an equality in the type
  \[(c:\reflect(C))\to{}t(\reflect(i)(\reflect(f)(c)))=
  t(\reflect(j)(\reflect(g)(c)))\]
  This type is equal to
  \[t\circ\reflect(i)\circ\reflect(f) = t\circ\reflect(j)\circ\reflect(g)\]
  via $\funext$ so we only need to prove
  \begin{align*}
    \mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h)) &=
    \funext(\mapfunc{t}\circ\reflect(h)) \\
    &: t\circ\reflect(i)\circ\reflect(f) =
    t\circ\reflect(j)\circ\reflect(g)
  \end{align*}

  Note that for any appropriately typed $t$ and $p$ we have
  \[\funext(\mapfunc{t}\circ\happly(p))=\map{(\lambda{}u.\,t\circ{}u)}p\]
  (by induction on $p$.)
  Hence the previous equality becomes the following, using the definition of
  $\reflect(h)$ and expanding $h$ to $\happly(\funext(h))$:
  \[\map{\ext}{\map{(\lambda{}u.\,t\circ\project_D\circ{}u)}{\funext(h)}}=
  \map{(\lambda{}u.\,t\circ{}u)}{\map{\reflect}{\funext(h)}}\]

  The idea is now to do an induction on the path $\funext(h):i\circ f = j\circ
  g$, which should be allowed because nothing in the previous expression seems to
  depend on the fact that $\funext(h)$ goes from a composition to another
  composition.  But let's not forget that there are implicit equalities on
  both sides of the equation and they use the fact that $i\circ f$ and
  $j\circ g$ are compositions, so first we need to deal with that.

  % After that, using the fact that for every $k:C\to{}D$ we have

  % \begin{align*}
  %   \ext(t\circ\project_D\circ{}k) &= \ext(t\circ\project_D)\circ\reflect(k) \\
  %   &= t\circ\reflect(k)
  % \end{align*}

  % We will have

  % \[\ext\circ(\lambda{}u.\,t\circ\project_D\circ{}u)=
  % (\lambda{}u.\,t\circ{}u)\circ\reflect\]

  % Hence the result, using the functoriality of $f\mapsto{}f_*$.

  \bigskip

  % Let's prove that the implicit equalities around $\mapfunc{r}$ and
  % $\mapfunc{\ext}$ cancel.
  We have the following diagram:

  \[\xymatrix{
    t\circ\reflect(i\circ f) \ar@{=}[r] \ar@{=}[d] &
      t\circ\reflect(j\circ g) \ar@{=}[d] \\
    t\circ\reflect(i)\circ\reflect(f) \ar@{=}[d] &
      t\circ\reflect(j)\circ\reflect(g) \ar@{=}[d] \\
    \extend{t\circ\project_D}\circ\reflect(i)\circ\reflect(f) \ar@{=}[d] &
      \extend{t\circ\project_D}\circ\reflect(j)\circ\reflect(g) \ar@{=}[d] \\
    \extend{t\circ\project_D\circ i}\circ\reflect(f) \ar@{=}[d] &
      \extend{t\circ\project_D\circ j}\circ\reflect(g) \ar@{=}[d] \\
    \extend{t\circ\project_D\circ i\circ f} \ar@{=}[r] &
      \extend{t\circ\project_D\circ j\circ g}\\
  }\]

  \begin{itemize}
  \item The top horizontal equality is
    $\map{(\lambda{}u.\,t\circ{}u)}{\map{\reflect}{\funext(h)}}$ without the
    implicit equalities around.
  \item The first line of vertical equalities are the implicit equalities around
    $\map{(\lambda{}u.\,t\circ{}u)}{\map{\reflect}{\funext(h)}}$ (the
    right hand side of the equality we want to prove).
  \item The next two lines of vertical equalities are around the left hand side
    of the equality we want to prove and come from the long computation a few
    pages ago.
  \item The last line of vertical equalities are the implicit equalities around
    $\mapfunc{\extendsmb}$.
  \item The bottom horizontal equality is
    $\map{\ext}{\map{(\lambda{}u.\,t\circ\project_D\circ{}u)}{\funext(h)}}$
    without the implicit equalities around.
  \end{itemize}

  The commutativity of the diagram is the equality we want to prove and
  the fact that the compositions $i\circ f$ and $j\circ g$ are being split in
  the middle of the diagram is the reason why we cannot work directly, by induction on
  $\funext(h)$.

  So we will prove that the following diagram (where the vertical part is the
  right hand side of the previous diagram) commutes. Note that on the right hand
  side of this diagram, we do no longer use the fact that $j\circ g$ is a
  composition of two functions, so induction on it will be allowed.

  \[\xymatrix{
    t\circ\reflect(j\circ g) \ar@{=}[d] & \\
    t\circ\reflect(j)\circ\reflect(g) \ar@{=}[d] & \\
    \extend{t\circ\project_D}\circ\reflect(j)\circ\reflect(g) \ar@{=}[d] &
    \extend{t\circ\project_D}\circ\reflect(j\circ g) \ar@{=}[l] \ar@{=}[luu]
    \ar@{=}[ldd] \\
    \extend{t\circ\project_D\circ j}\circ\reflect(g) \ar@{=}[d] & \\
    \extend{t\circ\project_D\circ j\circ g} & \\
  }\]

  The top square commutes because it is the concatenation of the two equalities
  $t=\extend{t\circ\project_D}$ and $\reflect(j)\circ\reflect(g)=\reflect(j\circ
  g)$ in two different orders (interchange law). In order to prove that the
  bottom square commutes, we only have to prove that it commutes after
  composition with $\project_C$ on the right. Let's write $u=t\circ\project_D$
  and let's consider the following diagram.

  \[\xymatrix@C=-30pt{
    \extend{u}\circ\reflect(j)\circ\reflect(g)\circ\project_C
      \ar@{=}[rrrr] \ar@{=}[ddd] \ar@{=}[rd] & & & &
    \extend{u}\circ\reflect(j\circ g)\circ\project_C
      \ar@{=}[ld] \ar@{=}[ddd] \\ &
    \extend{u}\circ\reflect(j)\circ\project_B\circ g
      \ar@{=}[rr] \ar@{=}[d] & {\phantom{thisisanuglyhack}} &
    \extend{u}\circ\project_D\circ j\circ g
      \ar@{=}[d] & \\ &
    \extend{u\circ j}\circ\project_B\circ g
      \ar@{=}[rr] \ar@{=}[ld] & &
    u\circ j\circ g
      \ar@{=}[rd] & \\
    \extend{u\circ j}\circ\reflect(g)\circ\project_C
      \ar@{=}[rrrr] & & & &
    \extend{u\circ j\circ g}\circ\project_C
  }\]

  We need to prove that the outer square commutes.

  \begin{itemize}
  \item The left square commutes because of the interchange law
  \item The top square commutes because of the definition of the equality
    $\reflect(j\circ g)=\reflect(j)\circ\reflect(g)$
  \item The bottom, right and interior squares commute because of the definition
    of the equality $\extend{a}\circ\reflect(b)=\extend{a\circ b}$
  \end{itemize}

  This proves that the outer square commutes, hence the previous triangular
  diagram commutes. We can do the same for the left part of the first
  rectangular diagram so we now only have to prove that the following diagram
  commutes:

  \[\xymatrix{
    t\circ\reflect(i\circ f) \ar@{=}[r] \ar@{=}[d] &
      t\circ\reflect(j\circ g) \ar@{=}[d] \\
    \extend{t\circ\project_D}\circ\reflect(i\circ f) \ar@{=}[d] &
      \extend{t\circ\project_D}\circ\reflect(j\circ g) \ar@{=}[d] \\
    \extend{t\circ\project_D\circ i\circ f} \ar@{=}[r] &
      \extend{t\circ\project_D\circ j\circ g}\\
  }\]

  And now we are finally allowed to induct on $\funext(h)$ because the diagram
  is not relying anymore on the fact that $i\circ f$ and $j\circ g$ are
  compositions.

  \bigskip

  This proves that the diagram commutes, hence the map
  $t\mapsto{}\composecocone{t}\reflect(c)$ is an equivalence which proves that
  the reflector commutes with pushouts.
\end{proof}

This proof was rather tedious, but we can hope that at some point we will
understand better what $(\infty,1)$-functoriality means in homotopy type theory, and
that we will be able to omit rigorously the equalities left implicit above and still
conclude that every coherence condition is always satisfied.

\begin{cor}
  Every span $\Ddiag$ in $\P$ has a pushout in $\P$.
\end{cor}

\begin{proof}
  According to \autoref{reflectPequiv} and to the diagram defining the action of
  $\reflect$ on functions, the diagram $\reflect(\Ddiag)$ is equivalent to
  $\Ddiag$. But we just proved that $\reflect(\Ddiag)$ has a pushout, namely the
  reflection of the pushout in \type of $\Ddiag$, hence $\Ddiag$ has a pushout
  in \P.
\end{proof}

Similar (but simpler) arguments prove that any reflective subuniverse has an initial object (namely $\reflect(\emptyt)$), coproducts (constructed as $\reflect(A+B)$), coequalizers, and so on.


\section{Modalities and factorization systems}
\label{sec:modalities}

\dots

\section*{Notes}

\autoref{thm:hedberg} is due to Hedberg~\cite{hedberg1998coherence}; for more information and generalizations see~\cite{krausgeneralizations}.

\section*{Exercises}



%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "main"
%%% End: 
