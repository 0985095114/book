\bgroup % restrict the scope of our macro definitions to this file

\newbox\pbbox
\setbox\pbbox=\hbox{\xy \POS(65,0)\ar@{-} (0,0) \ar@{-} (65,65)\endxy}
\def\pb{\save[]+<3.5mm,-3.5mm>*{\copy\pbbox} \restore}

\newcommand{\comp}[2]{\ensuremath{{#2} \circ {#1}}}
\newcommand{\contr}{\ensuremath{\mathsf{contr}}}
\newcommand{\istype}[1]{\mathsf{is}\mbox{-}{#1}\mbox{-}\mathsf{type}}
% \newcommand{\nplusone}{\ensuremath{(n\mbox{\rm{+}}1)}}
% \newcommand{\nminusone}{\ensuremath{(n\mbox{\rm{-}}1)}}
\newcommand{\nplusone}{\ensuremath{(n+1)}}
\newcommand{\nminusone}{\ensuremath{(n-1)}}

% Subuniverse
\renewcommand{\P}{\ensuremath{\mathsf{P}}\xspace}
% Reflector, projection and extension in an arbitrary reflective subuniverse
\newcommand{\reflect}{\mathsf{r}}
\newcommand{\project}{\mathsf{p}}
\newcommand{\ext}{\mathsf{ext}}


\chapter{\texorpdfstring{$n$}{n}-types and modalities}
\label{cha:hlevels}

\section{$n$-types}

In homotopy theory one often talks about $n$-types, i.e.\ spaces whose homotopy groups vanish above $n$.
We mentioned in \autoref{sec:basics-sets} that a similar notion can be defined in type theory, with the $0$-types being the sets and continuing inductively.
As mentioned in \autoref{sec:logic,sec:contractibility}, it turns out to be convenient to start two levels lower, where the $(-1)$-types being the mere propositions and the $(-2)$-types the contractible ones.
We now define these formally for all $n$.

\begin{defn}\label{def:hlevel}
  Define the predicate $\istype{n} : \type \to \type$ for $n \geq -2$ by recursion as follows:
  \[ \istype{n}(X) \defeq
  \begin{cases}
    \iscontr(X) & \text{ if } n = -2 , \\
    \prd{x,y : X} \istype{n'}(\id[X]{x}{y}) & \text{ if } n = n'+1
  \end{cases}
  \]
  We say that $X$ \emph{is an $n$-type} if $\istype{n}(X)$ is inhabited.
\end{defn}

\begin{rmk}
  The number $n$ in \autoref{def:hlevel} ranges over all integers greater than or equal to $-2$.
  We could make sense of this formally by defining a type $\Z_{{\geq}-2}$ of such integers (a type whose induction principle is identical to that of $\Nat$), or instead defining a predicate $\istype{(k-2)}$ for $k : \Nat$.
  Either way, we can prove theorems about $n$-types by induction on $n$, with $n = -2$ as the base case.
\end{rmk}

As in classical homotopy theory, a type does not have to be an $n$-type for any number $n$.
We will see some counterexamples in \autoref{sec:whitehead}.

\begin{eg}
  We saw in \autoref{thm:prop-minusonetype} that $X$ is a $(-1)$-type if and only if it is a mere proposition.
  Therefore, $X$ is a $0$-type if and only if it is a set.
\end{eg}

We start by showing $n$-types are closed under certain operations and constructors.

\begin{thm}\label{thm:h-level-retracts}
 Let $p : X \to Y$ be a retraction and suppose that $X$ is an $n$-type, for any $n\geq -2$.
 Then $Y$ is also an $n$-type.
\end{thm}

By definition, a \textbf{retraction} is a function $p : X \to Y$ such that there exists a function $s : Y \to X$, called its \textbf{section} and a homotopy $\epsilon:\prd{y:Y} (p(s(y))=y)$.

\begin{proof}
 We proceed by induction on $n$.

 For $n=-2$, assume $X$ is contractible; let $x_0 : X$ be the center of contraction.
 We claim that $y_0 \defeq p(x_0) : Y$ is a center of contraction for $Y$.
 Let $y : Y$; we need a path $y = y_0$.
 But we have $\epsilon_y : p(s(y)) = y$ and $\contr_{s(y)} : s(y) = x_0$, so by composition
 \[ \opp{\epsilon_y} \ct \ap{p}{\contr_{s(y)}} : y = p(x_0) \jdeq y_0 .\]

 For the inductive step, assume that any retract of an $n$-type is an $n$-type, and that $X$ is an $\nplusone$-type.
 Let $y, y' : Y$; we must show that $\id{y}{y'}$ is an $n$-type.
 Snce $X$ is an $\nplusone$-type, $\id[X]{s(y)}{s(y')}$ is an $n$-type.
 We claim that $\id{y}{y'}$ is a retract of $\id[X]{s(y)}{s(y')}$.
 As the section, we have
 \[ \apfunc s : (y=y') \to (s(y)=s(y')). \]
 For the retraction, we define $t:(s(y)=s(y'))\to(y=y')$ by
 \[ t(q) \defeq  \opp{\epsilon_y} \ct \ap p q \ct \epsilon_{y'}.\]
 To show that $t$ is a retraction of $\apfunc s$, we must show that
 \[ \opp{\epsilon_y} \ct \ap p {\ap sr} \ct \epsilon_{y'} = q \]
 for any $r:y=y'$.
 But this follows easily from \autoref{lem:htpy-natural}.
\end{proof}

As an immediate corollary we obtain the stability of $n$-types under equivalence:

\begin{cor}\label{cor:preservation-hlevels-weq}
 If $\eqv{X}{Y}$ and $X$ is an $n$-type, then so is $Y$.
\end{cor}

Recall also the notion of monomorphism from \autoref{sec:mono-surj}.

\begin{thm}\label{thm:isntype-mono}
  If $f:X\to Y$ is a monomorphism and $Y$ is an $n$-type for some $n\ge -1$, then so is $X$.
\end{thm}
\begin{proof}
  Let $x,x':X$; we must show that $\id[X]{x}{x'}$ is an $\nminusone$-type.
  But since $f$ is a monomorphism, we have $(\id[X]{x}{x'}) \simeq (\id[Y]{f(x)}{f(x')})$, and the latter is an $\nminusone$-type by assumption.
\end{proof}

Note that this theorem fails when $n=-2$: the map $\emptyt \to \unit$ is a monomorphism, but $\unit$ is a $(-2)$-type while $\emptyt$ is not.

\begin{thm}\label{thm:hlevel-cumulative}
 The hierarchy of $n$-types is cumulative in the following sense:
   given a number $n \geq -2$, if $X$ is an $n$-type, then it is also an $\nplusone$-type.
\end{thm}

\begin{proof}
 We proceed by induction on $n$.

 For $n = -2$, we need to show that a contractible type, say, $A$, has contractible path spaces.
       Let $a_0: A$ be the center of contraction of $A$, and let $x, y : A$. We show that $\id[A]{x}{y}$
       is contractible.
       By contractibility of $A$ we have a path $\contr_x \ct \opp{\contr_y} : x = y$, which we choose as
       the center of contraction for $\id{x}{y}$.
       Given any $p : x = y$, we need to show $p = \contr_x \ct \opp{\contr_y}$.
           By identity elimination, it suffices to show that
        $\refl{x} = \contr_x \ct \opp{\contr_x}$, which is trivial.

 For the inductive step, we need to show that $\id[X]{x}{y}$ is an $\nplusone$-type, provided
          that $X$ is an $\nplusone$-type. Applying the induction hypothesis to $\id[X]{x}{y}$
         yields the desired result.
\end{proof}

% \section{Preservation under constructors}
% \label{sec:ntype-pres}

We now show that $n$-types are preserved by most type forming operations.

\begin{thm}
 Let $n \geq -2$, and let $A : \type$ and $B : A \to \type$.
 If $A$ is an $n$-type and for all $a : A$, $B(a)$ is an $n$-type, then so is $\sm{x : A} B(x)$.
\end{thm}

\begin{proof}
 We proceed by induction on $n$.

 For $n = -2$, we choose the center of contraction for $\sm{x : A} B(x)$ to be the pair
       $(a_0, b_0)$, where $a_0 : A$ is the center of contraction of $A$ and $b_0 : B(a_0)$ is the center of contraction of $B(a_0)$.
       Given any other element $(a,b)$ of $\sm{x : A} B(x)$, we provide a path $\id{(a, b)}{(a_0,b_0)}$
       by contractibility of $A$ and $B(a_0)$, respectively.

 For the inductive step, suppose that $A$ is an $\nplusone$-type and
         for any $a : A$, $B(a)$ is an $\nplusone$-type. We show that $\sm{x : A} B(x)$ is an $\nplusone$-type:
      fix $(a_1, b_1)$ and $(a_2,b_2)$ in $\sm{x : A} B(x)$,
     we show that $\id{(a_1, b_1)}{(a_2,b_2)}$ is an $n$-type.
      By \autoref{thm:path-sigma} we have
      \[ \eqvspaced{(\id{(a_1, b_1)}{(a_2,b_2)})}{\sm{p : \id{a_1}{a_2}} (\id[B(a_2)]{\trans{p}{b_1}}{b_2})} \]
   and by preservation of $n$-types under equivalences (\autoref{cor:preservation-hlevels-weq})
   it suffices to prove that the latter is an $n$-type. This follows from the
   induction hypothesis.
\end{proof}


\begin{thm}\label{thm:hlevel-prod}
 Let $n\geq -2$, and let $A : \type$ and $B : A \to \type$.
 If for all $a : A$, $B(a)$ is an $n$-type, then so is $\prd{x : A} B(x)$.
\end{thm}

\begin{proof}
  We proceed by induction on $n$.
  For $n = -2$, the result is simply \autoref{thm:contr-forall}.

  For the inductive step, let $f, g : \prd{a:A}B(a)$.
  We need to show that $\id{f}{g}$ is an $n$-type.
  By function extensionality and closure of $n$-types under equivalence, it suffices to show that $\prd{a : A} (\id[B(a)]{f(a)}{g(a)})$ is an $n$-type.
  But this follows from the inductive hypothesis.
\end{proof}

As a special case of the above theorem, the function space $A \to B$ is an $n$-type provided that $B$ is an $n$-type.
We can now generalize our observations in \autoref{cha:basics} that $\isset(A)$ and $\isprop(A)$ are mere propositions.

\begin{thm}\label{thm:isaprop-isofhlevel}
 For any $n \geq -2$ and any type $X$, the type $\istype{n}(X)$ is a mere proposition.
\end{thm}
\begin{proof}
  We proceed by induction with respect to $n$.

 For the base case, we need to show that for any $X$, the type $\iscontr(X)$ is a mere proposition.
 By \autoref{thm:contr-unit}, it suffices to show that if $X$ is contractible, then $\iscontr(X)$ is a mere proposition.
 But this follows from \autoref{thm:contr-contr}.

For the inductive step we need to show
\[\prd{X : \type} \isprop (\istype{n}(X)) \to \prd{X : \type} \isprop (\istype{\nplusone}(X)) \]
To show the conclusion of this implication, we need to show that for any type $X$, the type
\[\prd{x, x' : X}\istype{n}(x = x')\]
is a mere proposition. By \autoref{thm:hlevel-prod} it suffices to show that for any $x, x' : X$, the type $\istype{n}(x =_X x')$ is a mere
proposition.
But this follows from the induction hypothesis applied to the type $(x =_X x')$.
\end{proof}

Finally, we show that the type of $n$-types is itself an $\nplusone$-type.
We define this to be:
\[\ntype{n} \defeq \sm{X : \type} \istype{n}(X) \]
In particular, we have $\prop \defeq \ntype{(-1)}$ and $\set \defeq \ntype{0}$, as defined in \autoref{cha:basics}.
Note that just as for \prop and \set, because $\istype{n}(X)$ is a mere proposition, for any $(X,p), (X',p'):\ntype{n}$ we have
\[ (\id[\ntype{n}]{(X, p)}{(X', p')}) \;\simeq\; (\id[\type] X X') \;\simeq\; (\eqv{X}{X'}).\]
by \autoref{thm:path-subset}.

\begin{thm}\label{thm:hleveln-of-hlevelSn}
 For any $n \geq -2$, the type $\ntype{n}$ is an $\nplusone$-type.
\end{thm}
\begin{proof}[Proof of \autoref{thm:hleveln-of-hlevelSn}]
  Let $(X, p), (X', p') : \ntype{n}$; we need to show that $\id{(X, p)}{(X', p')}$ is an $n$-type.
  By the above observation, this type is equivalent to $\eqv{X}{X'}$.
  Next, we observe that the projection
  \[(\eqv{X}{X'}) \hookrightarrow (X \rightarrow X').\]
  is a monomorphism, so that if $n\geq -1$, then by \autoref{thm:isntype-mono} it suffices to show that $X \rightarrow X'$ is an $n$-type.
  But since $n$-types are preserved under the arrow type, this reduces to an assumption that $X'$ is an $n$-type.

  In the case $n=-2$, this argument shows that $\eqv{X}{X'}$ is a $(-1)$-type --- but it is also inhabited, since any two contractible types
are equivalent to \unit, and hence to each other.
  Thus, $\eqv{X}{X'}$ it is also a $(-2)$-type.
\end{proof}

\section{UIP and Hedberg's theorem}
\label{sec:hedberg}

In \autoref{sec:basics-sets} we defined a type $X$ to be a \emph{set} if for all $x, y : X$ and $p, q : x =_X y$ we have $p = q$.
In conventional type theory, this property goes by the name of \emph{uniqueness of identity proofs (UIP)}.
We have seen also that it is equivalent to being a $0$-type in the sense of the previous section.
Here is another equivalent characterization, involving Streicher's ``axiom K" \cite{StreicherK}:

\begin{thm}\label{thm:h-set-uip-K}
 A type $X$ is a set if and only if it satisfies \emph{Axiom K}: for all $x : X$ and $p : (x =_A x)$ we have $p = \refl{x}$.
\end{thm}

\begin{proof}
  Clearly Axiom K is a special case of UIP.
  Conversely, if $X$ satisfies Axiom K, let $x, y : X$ and $p, q : (\id{x}{y})$; we want to show $p=q$.
  But induction on $q$ reduces this goal precisely to Axiom K.
\end{proof}

We stress that \emph{we} are not assuming the K principle as an axiom!

The following theorem is another useful way to show that types are sets.

\begin{thm}\label{thm:h-set-refrel-in-paths-sets}
  Suppose $R$ is a reflexive mere relation on a type $X$ implying identity.
  Then $X$ is a set, and $R(x,y)$ is equivalent to $\id[X]{x}{y}$ for all $x,y:X$.
\end{thm}

\begin{proof}
  Let $\rho : \prd{x:X} R(x,x)$ witness the reflexivity of $R$, and let $f : \prd{x,y:X} R(x,y) \to (\id[X]{x}{y})$ be a witness that $R$
implies identity.
  Note first that the two statements in the theorem are equivalent.
  For on one hand, if $X$ is a set, then $\id[X]xy$ is a mere proposition, and since it is logically equivalent to the mere proposition
$R(x,y)$ by hypothesis, it must also be equivalent to it.
  On the othre hand, if $\id[X]xy$ is equivalent to $R(x,y)$, then like the latter it is a mere proposition for all $x,y:X$, and hence $X$
is a set.

  We give two proofs of this theorem.
  The first shows directly that $X$ is a set; the second shows directly that $R(x,y)\simeq (x=y)$.

  \textbf{First proof:} we show that $X$ is a set.
  The idea is the same as that of \autoref{thm:prop-set}: the function $f$ must be continuous in its arguments $x$ and $y$.
  However, it is slightly more notationally complicated because we have to deal with the additional argument of type $R(x,y)$.

  Firstly, for any $x:X$ and $p:\id[X]xx$, consider $\apdfunc{f(x)}(p)$.
  This is a dependent path from $f(x,x)$ to itself.
  Since $f(x,x)$ is still a function $R(x,x) \to (\id[X]xy)$, by \autoref{thm:dpath-arrow} this yields a path
  \[\trans{p}{f(x,x,r)} = f(x,x,\trans{p}r).
  \]
  On the left-hand side, we have transport in an identity type, which is concatenation.
  And on the right-hand side, we have $\trans{p}r = r$, since both lie in the mere proposition $R(x,x)$.
  Thus, substituting $r\defeq \rho(x)$, we obtain
  \[ f(x,x,\rho(x)) \ct p = f(x,x,\rho(x)). \]
  By cancellation, $p=\refl{x}$.
  So $X$ satisfies Axiom K, and hence is a set.

  \textbf{Second proof:} we show that each $f(x,y) : R(x,y) \to \id[X]{x}{y}$ is an equivalence.
  By \autoref{thm:total-fiber-equiv}, it suffices to show that $f$ induces an equivalence of total spaces:
  \begin{equation*}
    \eqv{\big(\sm{y:X}R(x,y)\big)}{\big(\sm{y:X}\id[X]{x}{y}\big)}.
  \end{equation*}
  By \autoref{thm:contr-paths}, the type on the right is contractible, so it
  suffices to show that the type on the left is contractible. As the center of
  contraction we take the pair $\pairr{x,\rho(x)}$.  It remains to show, for
  every ${y:X}$ and every ${H:R(x,y)}$ that
  \begin{equation*}
    \id{\pairr{x,\rho(x)}}{\pairr{y,H}}.
  \end{equation*}
  But since $R(x,y)$ is a mere proposition, by \autoref{thm:path-sigma} it suffices to show that
  $\id[X]{x}{y}$, which we get from $f(H)$.
\end{proof}

\begin{cor}\label{notnotstable-equality-to-set}
  If a type $X$ has the property that $\neg\neg(x=y)\to(x=y)$ for any $x,y:X$, then $X$ is a set.
\end{cor}

Another convenient way to show that a type is a set is by way of the following property.

\begin{defn}\label{defn:decidable-equality}
 A type $X$ has \textbf{decidable equality} if for all $x, y : X$ we have
 \[(x =_X y) + \neg (x =_X y).\]
\end{defn}

In the propositions-as-types language, we can say that $X$ has decidable equality if for every $x,y:X$, either $x=y$ or $x\neq y$.
Note that this is a very constructive form of ``or''.
LEM implies (using \autoref{thm:isprop-forall}) that \emph{any} type $X$ has \emph{decidable mere equality}, meaning
\[\prd{x,y:X} \big(\brck{x=y} + \brck{x\neq y}\big).\]
\autoref{defn:decidable-equality} asserts moreover that a path $x=y$ can be chosen, when it exists, continuously (or computably, or
functorially) in $x$ and $y$.
This turns out to imply that $X$ is a set, by way of \autoref{thm:h-set-refrel-in-paths-sets} and the following lemma.

\begin{lem}
For any type $A$ we have $(A+\neg A)\to(\neg\neg A\to A)$.
\end{lem}

\begin{proof}
Suppose $x:A+\neg A$. We have two cases to consider.
If $x\defeq\inl{a}$ for some $a:A$, then we have the constant function $\neg\neg A
\to A$ which maps everything to $a$. If $x\defeq\inr{f}$ for some $f:\neg A$,
we have the term $g(f):\emptyt$ for any $g:\neg\neg A$. Hence we may use
ex falso quodlibet to get a term of $A$ for any $g:\neg\neg A$.
\end{proof}

\begin{thm}[Hedberg]\label{thm:hedberg}
  If $X$ has decidable equality, then $X$ is a set.
\end{thm}

\begin{proof}
If $X$ has decidable equality, it follows that $\neg\neg(x=y)\to(x=y)$ for any
$x,y:X$. Therefore, Hedbergs theorem follows from 
\autoref{notnotstable-equality-to-set}.
\end{proof}

There is, of course, a strong connection between this theorem and \autoref{thm:not-lem}.
The form of LEM denied by \autoref{thm:not-lem} clearly implies that every type has decidable equality, and hence is a set; which we know is
not the case.

Recall that in \autoref{thm:nat-set} we observe that $\nat$ is a set, using our characterization of its equality types in
\autoref{sec:compute-nat}.
A more traditional proof of this theorem uses only~\eqref{eq:zero-not-succ} and~\eqref{eq:suc-injective}, rather than the full
characterization of \autoref{thm:path-nat}, with \autoref{thm:hedberg} to fill in the blanks.

\begin{thm}\label{prop:nat-is-set}
 The type $\Nat$ of natural numbers has decidable equality, and hence is a set.
\end{thm}

\begin{proof}
  Let $x, y : \Nat$ be given; we proceed by induction on $x$ and case analysis on $y$ to prove $(x=y)+\neg(x=y)$.
  If $x \jdeq 0$ and $y \jdeq 0$, we take $\inl(\refl{}(0))$.
  If $x \jdeq 0$ and $y \jdeq \suc(n)$, then by~\eqref{eq:zero-not-succ} we get $\neg (0 = \suc (n))$.

  For the inductive step, let $x \jdeq \suc (n)$.
  If $y \jdeq 0$, we use~\eqref{eq:zero-not-succ} again.
  Finally, if $y \jdeq \suc (m)$, the induction hypothesis gives $(m = n)+\neg(m = n)$.
  In the first case, if $p:m=n$, then $\ap \suc p:\suc(m)=\suc(n)$.
  And in the second case,~\eqref{eq:suc-injective} yields $\neg(\suc(m)=\suc(n))$.
\end{proof}

Although Hedberg's theorem appears rather special to sets ($0$-types), Axiom K generalizes naturally to $n$-types.
Note that the ordinary Axiom K states that for all $x:X$, the loop space $\Omega(X,x)$ (see \cref{def:loopspace}) is contractible.
Since $\Omega(X,x)$ is always inhabited (by $\refl{x}$), this is equivalent to its being a mere proposition (a $(-1)$-type).
Since $0 = (-1)+1$, this suggests the following generalization.

\begin{thm}\label{thm:hlevel-loops}
  For any $n\geq -1$, a type $X$ type is an $\nplusone$-type if and only if for all $x : X$, the type $\Omega(X, x)$ is an $n$-type.
\end{thm}

Before proving this, we prove an auxiliary lemma:

\begin{lem}\label{lem:hlevel-if-inhab-hlevel}
  Given $n \geq -1$ and $X : \type$.
  If, given any inhabitant of $X$ it follows that $X$ is an $n$-type, then $X$ is an $n$-type.
\end{lem}
\begin{proof}
  Let $f : X \to \istype{n}(X)$ be the given map.
  We need to show that for any $x, x' : X$, the type $\id{x}{x'}$ is an $\nminusone$-type.
  But then $f(x)$ shows that $X$ is an $n$-type, hence all its path spaces are $\nminusone$-types.
\end{proof}

\begin{proof}[Proof of \autoref{thm:hlevel-loops}]
  The ``only if'' direction is obvious, since $\Omega(X,x)\defeq (\id[X]xx)$.
  Conversely, in order to show that $X$ is an $\nplusone$-type, we need to show that for any $x, x' : X$, the type $\id{x}{x'}$ is an
$n$-type.
  Following \autoref{lem:hlevel-if-inhab-hlevel} it suffices to give a map
  \[ (\id{x}{x'}) \to \istype{n}(\id{x}{x'})  .\]
  By path induction, it suffices to do this when $x\jdeq x'$, in which case it follows from the assumption that $\Omega(X, x)$ is an
$n$-type.
\end{proof}

The following theorem will see how we may detect the homotopy level of a type using spheres.
The basic idea is that if $A$ is an $n$-type, then all the maps from $\Sn^{n+1}$ to $A$ are null-homotopic.

\begin{defn}
  A function $f:X\to A$ is said to be \emph{null-homotopic} if there is an $a:A$ such that $f=(\lam{x} a)$.
  In other words, we define
  \begin{equation*}
    \mathsf{hNull}(f)\defeq\sm{a:A} (f=(\lam{x} a)) .
  \end{equation*}
\end{defn}

\begin{lem}\label{lem:hnull_to_map_hnull}
If a function $f:X\to A$ is null-homotopic, then so is
\[\apfunc f : (x= y)\to (f(x)= f(y)).\]
\end{lem}

\begin{proof}
Suppose $H:\sm{a:A} (f=\lam{x} a)$.  A proof by path induction on $p:x= y$ reveals that there is a homotopy
\begin{equation*}
\apfunc{f} = \lam{p} (\pi_2 H(y))^{-1}\ct (\pi_2 H(x)).\qedhere
\end{equation*}
\end{proof}

Recall from \autoref{sec:suspension} that we can define the $n$-sphere $\Sn^n$ inductively as the suspension of the $(n-1)$-sphere, starting
with $\Sn^{-1}\defeq \emptyt$.

\begin{thm}\label{thm:sphere_n_hnull_to_hlevel_sn}
For every $n:\N$, a type $A$ is an $n$-type if all the functions from $\Sn^{n+1}$ to $A$ are null-homotopic.
\end{thm}

\begin{proof}
The exact statement which we will prove is
\begin{equation*}
\prd{n:\N}{A:\type} \big(\prd{f:\Sn^n\to A} \mathsf{hNull}(f)\big)\to\istype{\nminusone}(A).
\end{equation*}
The proof is by induction on $n$.  In the case $n\jdeq 0$ we have that
\begin{equation*}
\big(\prd{f:\Sn^{0}\to A} \mathsf{hNull}(f)\big)\simeq\prd{x,y:A} (x= y),
\end{equation*}
so we see immediately that a type $A$ is a proposition whenever every function $f:\Sn^0\to A$ is null-homotopic.

Now suppose that we have a function of type
\begin{equation*}
\prd{A:\type}{f:\Sn^n\to A}{t:\Sn^n} (f(t)= f(\north^n)\big)\to\istype{\nminusone}(A).
\end{equation*}
and let $A$ be a type and let 
\begin{equation*}
H:\prd{f:\Sn^{n+1}\to A}{t:\Sn^{n+1}} (f(t)= f(\north^{n+1})).
\end{equation*}
We wish to show that $A$ is an $n$-type, which we will do by showing that $x= y$ is an $\nminusone$-type for each $x,y:A$.
Suppose that $x,y:A$; then by the induction hypothesis it suffices to show that every function $\Sn^n\to (x= y)$ is null-homotopic.
We have that $\Sn^n\to(x= y)$ is equivalent to
\[\sm{f:S^{n+1}\to A} (f(\north^{n+1})= x)\times(f(\south^{n+1})= y).\]
Suppose that $f:\Sn^n\to A$ is a function and suppose that $\tilde{f}$ corresponds to $f$ via the indicated equivalence. Then $\tilde{f}$ is
null-homotopic, and hence $\lam{t} \tilde{f}(\merid^n(t))$ is null-homotopic (by \autoref{lem:hnull_to_map_hnull}).
It follows that $f$ is null-homotopic.
\end{proof}

We conclude that:
\begin{thm}\label{thm:ntype-nloop}
  For any $n\ge -1$, a type $X$ is an $n$-type if and only if $\Omega^{n+1}(X,x)$ is contractible for all $x:X$.
\end{thm}

\section{Truncations}
\label{sec:truncations}

In \autoref{subsec:prop-trunc} we introduced the propositional truncation, which makes the ``best approximation'' of a type that is a mere
proposition, i.e.\ a $(-1)$-type.
In \autoref{sec:hittruncations} we constructed this truncation as a higher inductive type, and gave one way to generalize it to a
0-truncation.
We now explain a better generalization of this, which truncates any type into an $n$-type for any $n\geq -2$.

The idea is to make use of \autoref{thm:ntype-nloop}, which states that $A$ is an $n$-type just when $\Omega^{n+1}(A,a)$ is contractible for
all $a:A$, and \autoref{lem:susp-loop-adj}, which implies that $\Omega^{n+1}(A,a) \simeq \Map_*(\Sn^{n+1},(A,a))$, where $\Sn^{n+1}$ is
equipped with some basepoint which we may as well call \base.
However, contractibility of $\Map_*(\Sn^{n+1},(A,a))$ is something that we can ensure directly by giving path constructors.

We might first of all try to define $\trunc nA$ to be generated by a function $\tproj n- : A \to \trunc n A$, together with for each
$r:\Sn^{n+1} \to \trunc n A$ and each $x:\Sn^{n+1}$, a path $s_r(x):r(x) = r(\base)$.

But this does not quite work, for the same reason that \autoref{rmk:spokes-no-hub} fails.
Instead, we use the full ``hub and spoke'' construction.

Thus, we take $\trunc nA$ to be the higher inductive type generated by:
\begin{itemize}
\item a function $\tproj n- : A \to \trunc n A$,
\item for each $r:\Sn^{n+1} \to \trunc n A$, a \emph{hub} point $h(r):\trunc n A$, and
\item for each $r:\Sn^{n+1} \to \trunc n A$ and each $x:\Sn^{n+1}$, a \emph{spoke} path $s_r(x):r(x) = h(r)$.
\end{itemize}

The existence of these constructors is now enough to show:

\begin{lem}
  $\trunc n A$ is an $n$-type.
\end{lem}
\begin{proof}
  By \autoref{thm:ntype-nloop}, it suffices to show that $\Omega ^{n+1}(\trunc nA,b)$ is contractible for all $b:\trunc nA$, which by
\autoref{lem:susp-loop-adj} is equivalent to $\Map_*(\Sn^{n+1},(\trunc nA,b))$.
  As center of contraction for the latter, we choose the function $c_b:\Sn^{n+1} \to \trunc nA$ which is constant at $b$, together with
$\refl b : c_b(\base) = b$.

  Now, an arbitrary element of $\Map_*(\Sn^{n+1},(\trunc nA,b))$ consists of a map $r:\Sn^{n+1} \to \trunc n A$ together with a path
$p:r(\base)=b$.
  By function extensionality, to show $r = c_b$ it suffices to give, for each $x:\Sn^{n+1}$, a path $r(x)=c_b(x) \jdeq b$.
  We choose this to be the composite $s_r(x) \ct \opp{s_r(\base)} \ct p$, where $s_r(x)$ is the spoke at $x$.


  Finally, we must show that when transported along this equality $r=c_b$, the path $p$ becomes $\refl b$.
  By transport in path types, this means we need
  \[\opp{(s_r(\base) \ct \opp{s_r(\base)} \ct p)} \ct p = \refl b.\]
  But this is immediate from path operations.
\end{proof}

To show the desired universal property of the $n$-truncation, we need the induction principle.
We extract this from the constructors in the usual way; it says that given $P:\trunc nA\to\type$ together with
\begin{itemize}
\item For each $a:A$, an element $g(a) : P(\tproj na)$,
\item For each $r:\Sn^{n+1} \to \trunc n A$ and $r':\prd{x:\Sn^{n+1}}, P(r(x))$, an element $h'(r,r'):P(h(r))$.
\item For each $r:\Sn^{n+1} \to \trunc n A$ and $r':\prd{x:\Sn^{n+1}}, P(r(x))$, and each $x:\Sn^{n+1}$, a dependent path
$\dpath{P}{s_r(x)}{r'(x)}{h'(r,r')}$.
\end{itemize}

\begin{thm}\label{thm:truncn-ind}
  For any type family $P:\trunc n A \to \type$ such that each $P(x)$ is an $n$-type, and any function $g : \prd{a:A} P(\tproj n a)$, there
exists a section $f:\prd{x:\trunc n A} P(x)$ such that $f(\tproj n a)\defeq g(a)$ for all $a:A$.
\end{thm}
\begin{proof}
  It will suffice to construct the second and third data listed above, since $g$ has exactly the type of the first datum.
  Given $r:\Sn^{n+1} \to \trunc n A$ and $r':\prd{x:\Sn^{n+1}}, P(r(x))$, we have $h(r):\trunc n A$ and $s_r :\prd{x:\Sn^{n+1}} (r(x) =
h(r))$.
  Define $t:\Sn^{n+1} \to P(h(r))$ by $t(x) \defeq \trans{s_r(x)}{r'(x)}$.
  Then since $P(h(r))$ is $n$-truncated, there exists a point $u:P(h(r))$ and a contraction $v:\prd{x:\Sn^{n+1}} (t(x) = u)$.
  Define $h'(r,r') \defeq u$, giving the second datum.
  Then (recalling the definition of dependent paths), $v$ has exactly the type required of the third datum.
\end{proof}

In particular, if $E$ is some $n$-type, we can consider the constant family of types equal to $E$ for every point of $A$.
Thus, every map $f:A\to{}E$ can be extended to a map $\extend{f}:\trunc nA\to{}E$ defined by $\extend{f}(\tproj na)\defeq f(a)$.
The induction principle also implies a nondependent $\eta$-rule, which says that if $E$ is an $n$-type and $g,g':\trunc nA\to{}E$ are such
that $g(\tproj na)=g'(\tproj na)$ for every $a:A$, then $g(x)=g'(x)$ for all $x:\trunc nA$; hence $g=g'$.
This implies the following universal property.

\begin{lem}[Universal property of truncations]\label{thm:trunc-reflective}
  Let $n\ge-2$, $A:\type$ and $B:\typele{n}$. The following map is an
  equivalence:
  \[\function{(\trunc nA\to{}B)}{A\to{}B}{g}{g\circ\tprojf n}\]
\end{lem}

\begin{proof}
  Given that $B$ is $n$-truncated, any $f:A\to{}B$ can be extended to a map $\extend{f}:\trunc nA\to{}B$.
  The map $\extend{f}\circ\tprojf n$ is equal to $f$, because for every $a:A$ we have $\extend{f}(\tproj na)=f(a)$ by definition.
  And the map $\extend{g\circ\tprojf n}$ is equal to $g$, because they both send $\tproj na$ to $g(\tproj na)$.
\end{proof}

We can characterize the path spaces of a truncation using the same method that we used in \autoref{sec:compute-coprod,sec:compute-nat} for
coproducts and natural numbers (and which we will use in \autoref{cha:homotopy} to calculate homotopy groups).
Unsurprisingly, the path spaces in the $(n+1)$-truncation of $A$ are the $n$-truncations of the path spaces of $A$.
Indeed, for any $x,y:A$ there is a canonical map
\begin{equation}
  f:\ttrunc n{x=_Ay}\to \Big(\tproj {n+1}x=_{\trunc{n+1}A}\tproj {n+1}y\Big)\label{eq:path-trunc-map}
\end{equation}
defined by
\[f(\tproj n{p})\defeq \apfunc{\tproj {n+1}-}(p). \]
This definition uses the recursion principle for $\trunc n-$, which is correct because $\trunc {n+1}A$ is $(n+1)$-truncated, so that the
codomain of $f$ is $n$-truncated.

\begin{thm} \label{thm:path-truncation}
  For any $A$ and $x,y:A$ and $n\ge -2$, the map~\eqref{eq:path-trunc-map} is an equivalence; thus we have
  \[ \eqv{\ttrunc n{x=_Ay}}{\Big(\tproj {n+1}x=_{\trunc{n+1}A}\tproj {n+1}y\Big)}. \]
\end{thm}

\begin{proof}
  As in previous situations, we cannot directly define a quasi-inverse to~\eqref{eq:path-trunc-map} because there is no way to induct on an
equality between $\tproj {n+1}x$ and $\tproj {n+1}y$.
  Thus, instead we generalize its type, in order to have general elements of the type $\trunc{n+1}A$ instead of $\tproj {n+1}x$ and $\tproj
{n+1}y$.
  Define $P:\trunc {n+1}A\to\trunc {n+1}A\to\typele{n}$ by
  \[P(\tproj {n+1}x,\tproj {n+1}y)\defeq \trunc n{x=_Ay}\]
  This definition is correct because $\trunc n{x=_Ay}$ is $n$-truncated, and $\typele{n}$ is $(n+1)$-truncated by
\autoref{thm:hleveln-of-hlevelSn}.
  Now for every $u,v:\trunc{n+1}A$, there is a map
  \[\encode:P(u,v) \to \big(u=_{\trunc{n+1}A}v\big)\]
  defined for $u=\tproj {n+1}x$ and $v=\tproj {n+1}y$ and $p:x=y$ by
  \[\encode(\tproj n{p})\defeq \apfunc{\tproj{n+1}-} (p).\]
  Since the codomain of $\encode$ is $n$-truncated, it suffices to define it only for $u$ and $v$ of this form, and then it's just the same
definition as before.
  We also define a function
  \[ r : \prd{u:\trunc{n+1} A} P(u,u) \]
  by induction on $u$, where $r(\tproj{n+1} x) \defeq \tproj n {\refl x}$.

  Now we can define an inverse map
  \[\decode: (u=_{\trunc{n+1}A}v) \to P(u,v)\]
  by
  \[\decode(p) \defeq \transfib{v\mapsto P(u,v)}{p}{r(u)}. \]
  To show that the composite
  \[ (u=_{\trunc{n+1}A}v) \xrightarrow{\decode} P(u,v) \xrightarrow{\encode} (u=_{\trunc{n+1}A}v) \]
  is the identity function, by path induction it suffices to check it for $\refl u : u=u$, in which case what we need to know is that
$\decode(r(u)) = \refl{u}$.
  But since this is an $n$-type, hence also an $(n+1)$-type, we may assume $u\jdeq \tproj {n+1} x$, in which case it follows by definition
of $r$ and $\decode$.
  Finally, to show that 
  \[ P(u,v) \xrightarrow{\encode} (u=_{\trunc{n+1}A}v) \xrightarrow{\decode} P(u,v) \]
  is the identity function, since this goal is again an $n$-type, we may assume that $u=\tproj {n+1}x$ and $v=\tproj {n+1}y$ and that we are
considering $\tproj n p:P(\tproj{n+1}x,\tproj{n+1}y)$ for some $p:x=y$.
  Then we have
  \begin{align*}
    \decode(\encode(\tproj n p)) &= \decode(\apfunc{\tproj{n+1}-}(p))\\
    &= \transfib{v\mapsto P(\tproj{n+1}x,v)}{\apfunc{\tproj{n+1}-}(p)}{\tproj n {\refl x}}\\
    &= \transfib{v\mapsto \trunc n{u=v}}{p}{\tproj n {\refl x}}\\
    &= \tproj n {\transfib{v \mapsto (u=v)}{p}{\refl x}}\\
    &= \tproj n p.
  \end{align*}
  This completes the proof that \encode and \decode are quasi-inverses.
  The stated result is then the special case where $u=\tproj {n+1}x$ and $v=\tproj {n+1}y$.
\end{proof}

\begin{cor}
  Let $n\ge-2$ and $(A,a)$ be a pointed type. Then
  \[\trunc n{\Omega(A,a)}=\Omega(\trunc{n+1}{(A,a)})\]
\end{cor}
\begin{proof}
  This is a special case of the previous lemma where $x=y=a$.
\end{proof}

\begin{cor}
  Let $n\ge -2$ and $k\ge 0$ and $(A,a)$ a pointed type.  Then
  \[\trunc n{\Omega^k(A,a)} = \Omega^k(\trunc{n+k}{(A,a)}). \]
\end{cor}
\begin{proof}
  By induction on $k$, using the recursive definition of $\Omega^k$.
\end{proof}

We also observe that ``truncations are cumulative'': if we truncate to an $n$-type and then to a $k$-type with $k\le n$, then we might as
well have truncated directly to a $k$-type.

\begin{lem}
  Let $k,n\ge-2$ with $k\le{}n$ and $A:\type$. Then
  $\trunc k{\trunc nA}=\trunc kA$.
\end{lem}
\begin{proof}
  We define two maps $f:\trunc k{\trunc nA}\to\trunc kA$ and
  $g:\trunc kA\to\trunc k{\trunc nA}$ in the following way:

  \[f(\tproj k{\tproj na})=\tproj ka\]
  \[g(\tproj ka)=\tproj k{\tproj na}\]

  The map $f$ is well-defined because $\trunc kA$ is $k$-truncated and also
  $n$-truncated (because $k\le{}n$), and the map $g$ is well-defined because
  $\trunc k{\trunc nA}$ is $k$-truncated.

  The composition $f\circ{}g:\trunc kA\to\trunc kA$ satisfy
  $(f\circ{}g)(\tproj ka)=\tproj ka$ hence $f\circ{}g=\idfunc[\trunc kA]$, and
  we also have $g\circ{}f=\idfunc[\trunc k{\trunc nA}]$ in the same way.
\end{proof}

% \begin{lem}
%   We have $\trunc n{\unit}=\unit$.
% \end{lem}
% \begin{proof}
%   Indeed, $\unit$ is $n$-truncated for every $n$ hence $\trunc n{\unit}=\unit$ by
%   \autoref{reflectPequiv}.
% \end{proof}


\section{Reflective subuniverses}
\label{subsec:reflective-subuniverses}

So far, in this chapter, we have focused on $n$-types and the $n$-truncation operation.
In fact, $n$-types and their truncation are a special case of a more general notion called a \emph{reflective subuniverse}, and many of
their properties can be proven formally in this generality.

\begin{defn}
  A \textbf{subuniverse} of \type is a predicate $P:\type \to \prop$.
  We write
  \[\P \defeq \sm{A:\type} P(A).\]
\end{defn}

An inhabitant of $\P$ is a pair $(A,s)$ with $A:\type$ and $s:P(A)$, but we will often simply write it as $A$.
Thus $A:\P$ means that $A:\type$ and $P(A)$ holds.
For instance, $P$ could be \isprop, \isset, or more generally $\istype{n}$ for any $n\ge-2$, in which case \P would be \prop, \set, or
$\typele{n}$.
On the other hand, if $P(A)\defeq \unit$, then every type lies in \P, i.e.\ $\P=\type$.

\begin{defn}
  A subuniverse $\P$ of $\type$ is a \textbf{reflective subuniverse} if
  for every $A:\type$ we have a type $\reflect(A):\P$ and a map
  $\project_A:A\to\reflect(A)$ such that for every $A:\type$ and $B:\P$, the following map is an equivalence:
  \[\function{(\reflect(A)\to{}B)}{(A\to{}B)}{f}{f\circ\project_A}.\]
\end{defn}

In particular, this implies that for every $B:\P$ and $g:A\to{}B$ there is a unique map $\ext(g):\reflect(A)\to{}B$ making the following
diagram commute (up to homotopy, of course).
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
\xymatrix{A \ar^{\project_A}[r] \ar_g[rd] \druppertwocell{=} & \reflect(A)
  \ar@{-->}^{\ext(g)}[d] \\
  & B}\]

The universal property means that $\reflect$ is left adjoint to the inclusion
$\iota:\P\to\type$ with $\project_A$ as the unit, because the last $B$ in the
universal property can be replaced by $\iota(B)$ given that $B$ is in $\P$.

One example is truncations, as defined in \autoref{sec:truncations}.
\begin{lem}[Truncations are reflective]
  $\typele{n}$ is a reflective subuniverse of $\type$, with $\reflect$
  given by $\trunc{n}{-}$.
\end{lem}
\begin{proof}
  Immediate from the universal property of truncations, \autoref{thm:trunc-reflective}.
\end{proof}

\begin{lem}
  Let \P be a subuniverse of \type. The assertion that \P is reflective is \anhprop.
\end{lem}

\begin{proof}
  Let's assume that \P is reflective in two different ways
  $(\reflect,\project,\ext)$ and $(\reflect',\project',\ext')$. We need to
  construct an equivalence between $\reflect(A)$ and $\reflect'(A)$ for every
  $A:\type$, and we need to prove that the following diagram commutes:
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{A \ar^{\project_A}[r] \ar_{\project'_A}[rd] \druppertwocell{=} &
    \reflect(A) \ar@{->}^\sim[d] \\
    & \reflect'(A)}\]
  (We can ignore the components $\ext$ and $\ext'$, since they belong to mere propositions---the assertion that precomposing with $\project$
and $\project'$ are equivalences.)

  Now the type $\reflect'(A)$ is in \P, so we can define the map
  \[\ext(\project'_A):\reflect(A)\to\reflect'(A)\]
  which is exactly the map making the previous diagram commute.
  We can also define
  \[\ext'(\project_A):\reflect'(A)\to\reflect(A).\]
  In order to prove that the composite is the identity, we only need to prove
  that $\ext'(\project_A)\circ\ext(\project'_A)\circ\project_A=\project_A$,
  which is the case:
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{A \ar^{\project_A}[r] \ar_{\project'_A}[rd]
    \ar@/_5mm/_{\project_A}[rdd] &
    \reflect(A) \ar@{->}^{\ext(\project'_A)}[d] \\
    & \reflect'(A) \ar@{->}^{\ext'(\project_A)}[d] \\
    & \reflect(A)}\]
  The other composite is just as easy.
  Thus, $\ext'(\project_A)$ is a quasi-inverse of $\ext(\project'_A)$, so the latter is an equivalence as desired.
\end{proof}

For the rest of this section, we assume that $\P$ is a reflective subuniverse of
$\type$.

The following lemma says that the counit of the adjunction is an equivalence, as expected for a reflection.
\begin{lem}
  \label{reflectPequiv}
  If $A:\P$, then the map $\project_A:A\to\reflect(A)$ is an equivalence.
\end{lem}
\begin{proof}
  Given that $A$ is in $\P$, we can define $\ext(\idfunc[A]):\reflect(A)\to{}A$.

  Then we have $\ext(\idfunc[A])\circ\project_A=\idfunc[A]:A\to{}A$ by
  definition.  In order to prove that
  $\project_A\circ\ext(\idfunc[A])=\idfunc[\reflect(A)]$, we only need to prove
  that $\project_A\circ\ext(\idfunc[A])\circ\project_A=
  \idfunc[\reflect(A)]\circ\project_A$.
  This is again true:
  \[\xymatrix{
    A \ar^{\project_A}[r] \ar_{\idfunc[A]}[rd] &
    \reflect(A) \ar^>>>{\ext(\idfunc[A])}[d] \ar@/^40pt/^{\idfunc[\reflect(A)]}[dd] \\
    & A \ar_{\project_A}[d] \\
    & \reflect(A)}\]
\end{proof}

Note that the converse is always true: if $\project_A$ is an equivalence, then $A:\P$.
This is easy using univalence and the fact that $\reflect(A):\P$.

The reflector $\reflect$ is a map $\type\to\P$, which (like any map in type theory) is a functor of $\infty$-groupoids.
Using the universal property, we should be able to prove that $\reflect$ is in fact $(\infty,1)$-functorial, i.e.\ preserves composition of
(not necessarily invertible) functions up to all higher homotopies.
But we don't know how to express $(\infty,1)$-functoriality all at once, so we will only prove a few bits of it.

\begin{defn}
  If $f:A\to{}B$, there is a map $\reflect(f):\reflect(A)\to\reflect(B)$ defined
  by
  \begin{equation}
    \reflect(f)\circ\project_A=\project_B\circ{}f\label{eq:project-natural}
  \end{equation}
  (or in other words $\reflect(f)=\ext(\project_B\circ{}f)$).
\end{defn}

\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
\xymatrix{A \ar^-{\project_A}[r] \ar_-f[d] \drtwocell{=} & \reflect(A)
  \ar@{-->}^-{\reflect(f)}[d]
  \\ B \ar_-{\project_B}[r] & \reflect(B)}\]

Moreover, this operation satisfies the following functoriality conditions:
  \begin{align*}
    \reflect(\idfunc[A])=\idfunc[\reflect(A)]\\
    \reflect(f\circ{}g)=\reflect(f)\circ\reflect(g)
  \end{align*}
  In order to define these equalities, we only need to define them after
  composition by $\project(A)$, because of the universal property.
  The first is defined by
  \[\xymatrix{
    \reflect(\idfunc[A])\circ\project_A \ar@{==}[r] \ar@{=}[d] &
    \idfunc[\reflect(A)]\circ\project_A \ar@{=}[d] \\
    \project_A \ar@{=}[r] & \project_A
  }\]
  The second one is defined by
  \[\xymatrix{
    \reflect(f\circ g)\circ\project_A \ar@{==}[r] \ar@{=}[d] &
    \reflect(f)\circ\reflect(g)\circ\project_A \ar@{=}[d] \\
    \project_C\circ f\circ g \ar@{=}[r] & \reflect(f)\circ\project_B\circ g
  }\]

% \begin{proof}
%   The map $\reflect(f)$ is defined to be the unique map
%   $\reflect(A)\to\reflect(B)$ such that
%   $\reflect(f)\circ\project_A=\project_B\circ{}f$ (using the universal property
%   of $\reflect$), or in other words $\reflect(f)=\ext(\project_B\circ{}f)$.

%   \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
%   \xymatrix{A \ar^-{\project_A}[r] \ar_-f[d] \drtwocell{=} & \reflect(A)
%     \ar@{-->}^-{\reflect(f)}[d]
%     \\ B \ar_-{\project_B}[r] & \reflect(B)}\]
%   In order to prove that $\reflect(\idfunc[A])=\idfunc[\reflect(A)]$, we only
%   need to prove that
%   $\reflect(\idfunc[A])\circ\project_A=\idfunc[\reflect(A)]\circ\project_A$. But
%   both sides are equal to $\project_A$.

%   Similarly, to prove that $\reflect(f\circ{}g)=\reflect(f)\circ\reflect(g)$ we
%   only need to prove that $\reflect(f\circ{}g)\circ\project_A=
%   \reflect(f)\circ\reflect(g)\circ\project_A$ and both sides are equal to
%   $\project_C\circ{}f\circ{}g$.

%   Note that by definition, the following diagram commutes:

%   \[\xymatrix{
%     \reflect(f\circ g)\circ\project_A \ar@{=}[r] \ar@{=}[d] &
%     \reflect(f)\circ\reflect(g)\circ\project_A \ar@{=}[d] \\
%     \project_C\circ f\circ g \ar@{=}[r] & \reflect(f)\circ\project_B\circ g
%     }\]
% \end{proof}

Note also that the defining equation~\eqref{eq:project-natural} asserts the first level of $(\infty,1)$-naturality for the transformation
$\project$.
This implies a generalization of \autoref{thm:h-level-retracts}.

\begin{lem}\label{thm:reflsubuniv-retract}
  A reflective subuniverse is closed under retractions.
  That is, if $B$ is in $\P$ and $A$ is a retract of $B$, then $A$ is in $\P$.
\end{lem}
\begin{proof}
  By functoriality and naturality, $\project_A$ is a retract of $\project_B$ (as functions).
  But $\project_B$ is an equivalence, hence so is $\project_A$; thus $A$ is in $\P$.
  \note{Should mention somewhere that equivalences are closed under retracts.}
\end{proof}

We also have the following ``functoriality'' property for the factorizations.

\begin{defn}
  Given types $A,B:\type$ and any $C:\P$, for any functions $f:A\to{}B$ and $i:B\to{}C$ we have
  \[\ext(i\circ{}f)=\ext(i)\circ\reflect(f)\]

  \[\xymatrix{
    A \ar^{\project_A}[r] \ar_f[d] & \reflect(A) \ar^{\reflect(f)}[d]
    \ar@/^15mm/^{\ext(i\circ f)}[dd] \\
    B \ar^{\project_B}[r] \ar_i[rd] & \reflect(B) \ar^{\ext(i)}[d] \\
    & C}\]

  This equality is defined by
  \[\xymatrix{
    \ext(i\circ f)\circ\project_A \ar@{==}[r] \ar@{=}[d] &
    \ext(i)\circ\reflect(f)\circ\project_A \ar@{=}[d] \\
    i\circ f \ar@{=}[r] & \ext(i)\circ\project_B\circ f
  }\]

\end{defn}

% \begin{proof}
%   \[\xymatrix{A \ar^{\project_A}[r] \ar_f[d] & \reflect(A) \ar^{\reflect(f)}[d]
%     \\
%     B \ar^{\project_B}[r] \ar_i[d] & \reflect(B) \ar^{\ext(i)}[ld] \\
%     C &}\]

%   We only have to prove that
%   \[\ext(i\circ{}f)\circ\project_A=\ext(i)\circ\reflect(f)\circ\project_A\]
%   which is the case, because they are both equal to $i\circ{}f$.
% \end{proof}

\section{Localizations}
\label{sec:localizations}

[Where does this go?]


\section{Limits in reflective subuniverses}
\label{sec:pullbacks}

In \autoref{sec:universal-properties} we observed that certain type forming operations have universal properties in the
$(\infty,1)$-category of types.
For instance, we had an equivalence
\[ \eqvspaced{(X\to A\times B) }{(X\to A)\times (X\to B)}. \]
We can ask for objects in any subuniverse with similar universal properties, for instance:

\begin{defn}
  Let $A,B:\P$, with $\P$ any subuniverse.
  A \textbf{product} of $A$ and $B$ in $\P$ is an object $C:\P$ together with functions $p:C\to A$ and $q:C\to B$ such that for any $X:\P$,
the induced map
  \[ (X\to C) \to (X\to A)\times (X\to B) \]
  is an equivalence.
\end{defn}

Of course, if the product type $A\times B$ lies in $\P$, then it is a product of $A$ and $B$ in $\P$.
As usual in category theory, if the subuniverse is reflective, then this is automatic.

\begin{thm}\label{thm:reflsubuniv-prod}
  If $\P$ is a reflective subuniverse and $A,B:\P$, then $A\times B$ is also in $\P$.
  Therefore, any pair of objects in $\P$ has a product in $\P$.
\end{thm}
\begin{proof}
  Since $A,B:\P$, the projections $\proj1:A\times B\to A$ and $\proj2:A\times B\to B$ factor uniquely through $\reflect(A\times B)$,
yielding $\ext(\proj1)$ and $\ext(\proj2)$.
  But now by the universal property of $A\times B$, we have a unique map $h:\reflect(A\times B) \to A\times B$ such that $\proj1 \circ h =
\ext(\proj1)$ and $\proj2\circ h = \ext(\proj2)$.
  It follows that $h$ is a retraction of $\project_{A\times B}$.
  Thus, $A\times B$ is a retract of $\reflect(A\times B)$, hence by \autoref{thm:reflsubuniv-retract} it is in $\P$.
\end{proof}

A similar argument shows that $\unit$ is in every reflective subuniverse.
Somewhat more interesting is the case of (homotopy) pullbacks, which requires some more definitions to state precisely.

\begin{defn}
  A \emph{cospan} in $\P$ is a diagram of the following form
  \[\xymatrix{& B \ar^g[d] \\ A \ar_f[r] & C}\]
  with $A,B,C:\P$.
\end{defn}

\begin{defn}
  If $\Ddiag$ is a cospan and $D:\P$, a \emph{cone over $\Ddiag$ with
    base $D$} is a triple $(i,j,h)$ such as in the following diagram:
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{D \ar^j[r] \ar_i[d] \drtwocell{^h} & B \ar^g[d] \\
    A \ar_f[r] & C
  }\]

  We denote by $\cone{\Ddiag}{D}$ the type of all such cones.
\end{defn}

The map $D\mapsto\cone{\Ddiag}{D}$ is contravariant in $D$, if $t:E\to{}D$ we
have a map
\[\function{\cone{\Ddiag}{D}}{\cone{\Ddiag}{E}}{c}{\composecone{t}{c}}\]
defined by $\composecone{t}{(i,j,h)}=(i\circ{}t,j\circ{}t,h\circ{}t)$ and this
map is (contravariantly) functorial.

\begin{defn}
  A pair $(D,c)$ where $D:\P$ and $c:\cone{\Ddiag}{D}$ is called a
  \emph{pullback} of $\Ddiag$ in \P if for all $E:\P$ the map
  \[\function{(E\to{}D)}{\cone{\Ddiag}{E}}{t}{\composecone{t}{c}}\]
  is an equivalence.
\end{defn}

As remarked earlier, pullbacks in \type can be constructed directly in the expected way.

\begin{defn}
  Let $\Ddiag$ be a cospan in $\type$. We define the following type
  \[A\times_CB=\setof{(a,b):A\times{}B | f(a) = g(b)}\]

  There is a canonical cone $c_\times=(\pi_1,\pi_2,\pi_3)$ over $\Ddiag$ with
  base $A\times_CB$ given by the following diagram
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{A\times_CB \ar^-{\pi_2}[r] \ar_{\pi_1}[d] \drtwocell{^\pi_3\ }
    & B \ar^g[d] \\ A \ar_f[r] & C}\]
  where
  \begin{align*}
    \pi_1((a,b),p)&=a\\
    \pi_2((a,b),p)&=b\\
    \pi_3((a,b),p)&=p\\
  \end{align*}
\end{defn}

\begin{lem}
  Let $\Ddiag$ be a diagram in $\type$. Then $(A\times_CB,c_\times)$ is a
  pullback of $\Ddiag$.
\end{lem}
\begin{proof}
  Given a type $E$ and a cone $c=(i,j,h):\cone{\Ddiag}{E}$ we construct a map
  $\Sn(c):E\to{}A\times_CB$ by
  \[\Sn(c)(x)=((i(x), j(x)), h(x))\]
  and we need to prove that $\composecone{\Sn(c)}{c_\times}=c$ and
  $\Sn(\composecone{t}{c_\times})=t$ for all $c:\cone{\Ddiag}{E}$ and
  $t:E\to{}A\times_CB$ and both are easy computations:
  \begin{align*}
    \composecone{\Sn(c)}{c_\times}
    &=\composecone{\Sn(c)}{(\pi_1,\pi_2,\pi_3)} \\
    &=(\pi_1\circ\Sn(c),\pi_2\circ\Sn(c),
    \pi_3\circ\Sn(c))\\
    &=(i,j,h)\\
    &=c
  \end{align*}
  \begin{align*}
    \Sn(\composecone{t}{c_\times})(x) &=
    \Sn(\pi_1\circ{}t,\pi_2\circ{}t,\pi_3\circ{}t)(x)\\
    &=(\pi_1(t(x)),\pi_2(t(x)),\pi_3(t(x)))\\
    &=t(x)\qedhere
  \end{align*}
\end{proof}

We observe in passing that pullbacks are preserved by function spaces.

\begin{defn}
  If $\Ddiag$ is a cospan and $D:\type$, then we define another
  cospan called $D\to\Ddiag$:
  \[\xymatrix{& (D\to B) \ar^{g\circ-}[d] \\ (D\to A) \ar_{f\circ-}[r] & (D\to
    C)}\]

  Similarly if $\Ddiag$ is a span and $D:\type$, then we have a
  cospan $\Ddiag\to{}D$:
  \[\xymatrix{& (B\to D) \ar^{-\circ{}g}[d] \\ (A\to D) \ar_{-\circ{}f}[r] &
    (C\to D)}\]
\end{defn}

\begin{lem}
  \label{coneispb}
  If $\Ddiag$ is a cospan and $D:\P$, then
  \[\cone{\Ddiag}{D}=(D\to{}A)\times_{(D\to{}C)}(D\to{}B)\]

  If $\Ddiag$ is a span and $D:\P$, then
  \[\cocone{\Ddiag}{D}=(A\to{}D)\times_{(C\to{}D)}(B\to{}D)\]
\end{lem}
\begin{proof}
  In both cases the map from left to right is $(i,j,h)\mapsto(i,j,\funext(h))$
  and the map from right to left is $(i,j,p)\mapsto(i,j,\happly(p))$ and they
  are inverse to each other.
\end{proof}

Finally, we have the analogous result to \autoref{thm:reflsubuniv-prod}.

\begin{thm}\label{thm:reflsubuniv-pb}
  If $A \xrightarrow{f}  C \xleftarrow{g} B$ is a cospan in a reflective $\P$, then $A\times_C B$ is also in $\P$.
\end{thm}
\begin{proof}
  Essentially just like \autoref{thm:reflsubuniv-prod}.
\end{proof}

\begin{cor}\label{thm:reflsubuniv-idtype}
  If $\P$ is reflective, then for any $A:\P$ and $x,y:A$, the identity type $(x=_A y)$ is also in $\P$.
\end{cor}
\begin{proof}
  $(x=_A y)$ is equivalent to the pullback of the diagonal function $f:A\to A\times A$, defined by $f(a)\defeq (a,a)$, and the function
$g:\unit\to A\times A$, defined by $g(\ttt)\defeq (x,y)$.
\end{proof}

There is another interesting generalization of \autoref{thm:reflsubuniv-prod}.
Recall that the dependent function type $\prd{x:A} B(x)$ can also be regarded as the (possibly infinitary) cartesian product of all the
types $B(x)$.

\begin{thm}\label{thm:reflsubunv-forall}
  If $B:A\to\P$ is any family of types in \P, then $\prd{x:A} B(x)$ is also in \P.
\end{thm}
\begin{proof}
  For any $x:A$, consider the function $\mathsf{ev}_x : (\prd{x:A} B(x)) \to B(x)$ defined by $\mathsf{ev}_x(f) \defeq f(x)$.
  Since $B(x)$ lies in $P$, this extends to
  \[ \ext(\mathsf{ev}_x) : \reflect(\prd{x:A} B(x)) \to B(x). \]
  Thus we can define $h:\reflect(\prd{x:A} B(x)) \to \prd{x:A} B(x)$ by $h(z)(x) \defeq \ext(\mathsf{ev}_x)(z)$.
  As before, $h$ is a retraction of $\project_{\prd{x:A} B(x)}$, so that ${\prd{x:A} B(x)}$ is in $\P$.
\end{proof}

In particular, if $B:\P$ and $A$ is any type, then $(A\to B)$ is in \P.
In categorical language, this means that any reflective subuniverse is an \textbf{exponential ideal}.
This, in turn, implies that the reflector preserves finite products.

\begin{cor}
  For any types $A$ and $B$, the induced map $\reflect(A\times B) \to \reflect(A) \times \reflect(B)$ is an equivalence.
\end{cor}
\begin{proof}
  TODO.
\end{proof}

It may seem odd that every reflective subcategory of types is automatically an exponential ideal, with a product-preserving reflector.
However, this is also the case classically in the category of \emph{sets}, for the same reasons.
It's just that this fact is not usually remarked on, since the classical category of sets---in contrast to the category of homotopy
types---does not have many interesting reflective subcategories.


\section{Colimits in reflective subuniverses}
\label{sec:pushouts}

Recall that in \autoref{sec:colimits}, we used higher inductive types to define pushouts of types, and proved their universal property.
We can, of course, consider pushouts in subuniverses as well.

\begin{defn}
  A \emph{span} in $\P$ is a 5-tuple $\Ddiag=(A,B,C,f,g)$ with
  $A,B,C:\P$ and $f:C\to{}A$ and $g:C\to{}B$.
  \[\Ddiag=\xymatrix{C \ar^g[r] \ar_f[d] & B \\ A & }\]
\end{defn}

\begin{defn}
  Given a span $\Ddiag=(A,B,C,f,g)$ and a type $D:\P$, a
  \emph{cocone under $\Ddiag$ with base $D$} is a triple $(i, j, h)$ with
  $i:A\to{}D$, $j:B\to{}D$ and $h : \prd{c:C}i(f(c))=j(g(c))$
  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{C \ar^g[r] \ar_f[d] \drtwocell{^h} & B \ar^j[d] \\ A \ar_i[r] & D
  }\]

  We denote by $\cocone{\Ddiag}{D}$ the type of all such cocones.
\end{defn}

The map $D\mapsto\cocone{\Ddiag}{D}$ is $(\infty,1)$-functorial, but we don't
know how to express this internally in homotopy type theory, so we will only
prove the bits of functoriality that we need.

\begin{defn}
  Given $D,E:\P$ and a map $t:D\to{}E$, there is a map
  \[\function{\cocone{\Ddiag}{D}}{\cocone{\Ddiag}{E}}{c}{\composecocone{t}c}\]
  defined by:
  \[\composecocone{t}(i,j,h)=(t\circ{}i,t\circ{}j,\mapfunc{t}\circ{}h)\]

  \[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{C \ar^g[r] \ar_f[d] \drtwocell{^h} & B \ar_j[d]
    \ar@/_/^{t\circ{}j}[rdd] & \\
    A \ar^i[r] \ar@/^/_{t\circ{}i}[rrd] & D \ar[rd]|<<<<t & \\
    & & E }\]
\end{defn}

\begin{lem}
  For any types $D,E,F:\P$, functions $t:D\to{}E$, $u:E\to{}F$ and
  $c:\cocone{\Ddiag}{D}$ we have
  \[\composecocone{\idfunc[D]}c = c\]
  \[\composecocone{(u\circ{}t)}c=\composecocone{u}(\composecocone{t}c)\]
\end{lem}
\begin{proof}
  This follows easily from the unit laws and associativity of composition of
  functions and from the functoriality of $f\mapsto{}\mapfunc{f}$ which has been proved
  earlier.
\end{proof}

We can now define the notion of pushout.

\begin{defn}
  Given a span $\Ddiag$, a type $D:\P$ and a cocone
  $c:\cocone{\Ddiag}{D}$, the pair $(D,c)$ is said to be a \emph{pushout}
  of $\Ddiag$ in $\P$ if for every $E:\P$, the map
  \[\function{(D\to{}E)}{\cocone{\Ddiag}{E}}{t}{\composecocone{t}c}\]
  is an equivalence.
\end{defn}

This definition says that for every $E:\P$ and for every cocone under $\Ddiag$
with base $E$, there is an essentially unique map $D\to{}E$ such that the whole
diagram commutes, the proof of commutation being essentially unique too.

We showed in \autoref{thm:pushout-ump} that pushouts exist when $\P$ is \type itself, by giving a direct construction in terms of higher
inductive types.
For a general \P, pushouts may or may not exist, but if they do, then they are unique.

\begin{lem}
  If $(D,c)$ and $(D',c')$ are two pushouts of $\Ddiag$ in $\P$, then
  $(D,c)=(D',c')$.
\end{lem}
\begin{proof}
  We first prove that the two types $D$ and $D'$ are equivalent.

  Using the universal property of $D$ with $D'$, we see that the following map is an
  equivalence
  \[\function{(D\to{}D')}{\cocone{\Ddiag}{D'}}{t}{\composecocone{t}c}\]

  In particular, there is a function $f:D\to{}D'$ satisfying $\composecocone{f}c=c'$. In the
  same way there is a function $g:D'\to{}D$ such that $\composecocone{g}c'=c$.

  In order to prove that $g\circ{}f=\idfunc[D]$ we use the universal property of
  $D$ for $D$, which says that the following map is an equivalence:
  \[\function{(D\to{}D)}{\cocone{\Ddiag}{D}}{t}{\composecocone{t}c}\]

  Using the functoriality of $t\mapsto{}\composecocone{t}c$ we see that
  \begin{align*}
    \composecocone{(g\circ{}f)}c &= \composecocone{g}(\composecocone{f}c) \\
    &= \composecocone{g}c' \\
    &= c \\
    &= \composecocone{\idfunc[D]}c
  \end{align*}
  hence
  $g\circ{}f=\idfunc[D]$, because equivalences are injective. The same argument
  with $D'$ instead of $D$ shows that $f\circ{}g=\idfunc[D']$.

  Hence $D$ and $D'$ are equal, and the fact that $(D,c)=(D',c')$ follows from
  the fact that the equivalence between $D$ and $D'$ we just defined sends $c$
  to $c'$.
\end{proof}

\begin{cor}
  The type of pushouts of $\Ddiag$ in $\P$ is \anhprop. In particular if
  pushouts merely exist then they actually exist.
\end{cor}

As in the case of pullbacks, if \P is reflective, then pushouts in \P always exist.
However, unlike the case of pullbacks, pushouts in \P are not the same as the pushouts in \type: they are obtained by applying the
reflector.
Before proving this, we first need to explain how to reflect spans and cocones.
For the rest of this section, let \P be a reflective subuniverse.

\begin{defn}
  Let
  \[\Ddiag=\xymatrix{C \ar^g[r] \ar_f[d] & B \\ A & }\]
  be a span in $\type$. We note $\reflect(\Ddiag)$ the following
  span in $\P$:
  \[\reflect(\Ddiag)=\xymatrix{\reflect(C) \ar^{\reflect(g)}[r]
    \ar_{\reflect(f)}[d] & \reflect(B) \\ \reflect(A) & }\]
\end{defn}

\begin{defn}
  Let $D:\type$ and $c=(i,j,h):\cocone{\Ddiag}{D}$.
  We define
  \[\reflect(c)=(\reflect(i),\reflect(j),\reflect(h)):
  \cocone{\reflect(\Ddiag)}{\reflect(D)}\]
  where
  \[\reflect(h):\prd{c:\reflect(C)}\reflect(i)(\reflect(f)(c))=\reflect(j)(\reflect(g)(c))\]
  is defined in the following way:

  We have \[h:\prd{c:C}i(f(c))=j(g(c))\]
  hence
  \[\funext(h):i\circ{}f=j\circ{}g\]
  We can apply $\reflect$ and we get
  \[\mapfunc{\reflect}(\funext(h)):\reflect(i\circ{}f)=\reflect(j\circ{}g)\]
  Now we can compose with the fact that $\reflect$ commutes with composition and
  we get the following (the proofs that $\reflect$ commutes with composition are
  not written in order to keep terms readable, we will later see that they don't
  get in the way):
  \[\mapfunc{\reflect}(\funext(h)):
  \reflect(i)\circ\reflect(f)=\reflect(j)\circ\reflect(g)\]
  and then
  \[\reflect(h)\defeq\happly(\mapfunc{\reflect}(\funext(h))):
  \prd{c:\reflect(C)}\reflect(i)(\reflect(f)(c))=\reflect(j)(\reflect(g)(c))\]
\end{defn}

\begin{lem}
  \label{reflectcommutespushout}
  Let $\Ddiag$ be a span in $\type$ and $(D,c)$ a pushout of $\Ddiag$
  in $\type$. Then $(\reflect(D),\reflect(c))$ is a pushout of
  $\reflect(\Ddiag)$ in $\P$.
\end{lem}

\begin{proof}
  Let $E:\P$ and let's consider the following diagram:

  \[\xymatrix{ (\reflect(D)\to E)
    \ar^{t\mapsto{}\composecocone{t}{\reflect(c)}}[r] \ar_{f_1}^\sim[d]
    &
    \cocone{\reflect(\Ddiag)}{E}\\
    (D\to E) \ar_{f_2}^\sim[d] &
    (\reflect(A)\to{}E)\times_{(\reflect(C)\to{}E)}(\reflect(B)\to{}E)
    \ar_{f_5}^\sim[u] \\
    \cocone{\Ddiag}{E}\ar_-{f_3}^-\sim[r] & (A\to{}E)\times_{(C\to{}E)}(B\to{}E)
    \ar_{f_4}^\sim[u] }\]

  We need to prove that the top arrow is an equivalence, we will do this by
  proving that it is a composite of five equivalences.

  The first equivalence, $f_1$, comes from the universal property of $\reflect$ and the fact
  that $E$ is in \P:
  \[f_1(t) \defeq t\circ\project_D.\]

  The second equivalence comes from the universal property of $(D,c)$, as a pushout of
  $\Ddiag$ in \type:
  \[f_2(u) \defeq (u\circ{}i,u\circ{}j,\mapfunc{u}\circ{}h).\]

  The third map comes from \autoref{coneispb}, and is defined by
  \[f_3(i,j,h) \defeq (i,j,\funext(h)).\]

  The fourth map comes from the universal property of $\reflect$ applied three
  times and the fact that pullbacks are invariant under equivalence (everything
  is invariant under equivalence anyway):
  \[f_4(i,j,p) \defeq (\ext(i),\ext(j),\mapfunc{\ext}(p)).\]

  Note that $\mapfunc{\ext}(p)$ has type $\ext(i\circ{}f)=\ext(j\circ{}g)$
  instead of $\ext(i)\circ\reflect(f)=\ext(j)\circ\reflect(g)$ but we
  (implicitely) concatenate with the proofs that
  $\ext(i\circ{}f)=\ext(i)\circ\reflect(f)$ and the same for $j$ and $g$. Again,
  we will see later that these proof do not get in the way.

  The fifth equivalence comes from \autoref{coneispb}, and is defined by
  \[f_5(a,b,q) \defeq (a,b,\happly(q)).\]

  We now need to prove that the diagram commutes, so we can conclude that the map
  $t\mapsto{}t\circ\reflect(c)$ is an equivalence.

  We have
  \begin{align*}
    f_5(f_4(f_3(f_2(f_1(t))))) &= f_5(f_4(f_3(f_2(t\circ\project_D)))) \\
    &= f_5(f_4(f_3(t\circ\project_D\circ{}i,t\circ\project_D\circ{}j,
    \mapfunc{(t\circ\project_D)}\circ{}h))) \\
    &=f_5(f_4(t\circ\project_D\circ{}i,t\circ\project_D\circ{}j,
    \funext(\mapfunc{(t\circ\project_D)}\circ{}h))) \\
    &=f_5(\ext(t\circ\project_D\circ{}i),\ext(t\circ\project_D\circ{}j),\\
    &\qquad\qquad\mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h)))
    \\
    &=f_5(\ext(t\circ\project_D)\circ\reflect(i),
    \ext(t\circ\project_D)\circ\reflect(j),\\
    &\qquad\qquad\mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h)))
    \\
    &=f_5(t\circ\reflect(i),
    t\circ\reflect(j),
    \mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h))) \\
    &=(t\circ\reflect(i),t\circ\reflect(j),
    \happly(\mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h))))
  \end{align*}

  Note that in the two steps before the last equality we are using the fact
  that if $a=a'$ and $b=b'$, then $(a,b,q)=(a',b',q)$. This is actually not
  even well typed given that the type of $q$ depends on $a$ and $b$, so we
  have to transport $q$ along the proofs $p:a=a'$ and $q:b=b'$. In the present
  case we have $q:a\circ\reflect(f)=b\circ\reflect(g)$ hence the correct
  statement is
  \[(a,b,q)=(a',b',q')\] where
  \[q'\defeq\map{(\lam{u} u\circ\reflect(f))}{\rev p} \ct q \ct
  \map{(\lam{u} u\circ\reflect(g))}{p'})\] Again we will leave this
  implicit and take care of it only when it will be needed.

  \bigskip

  In order to prove that the diagram commutes, we now only need to prove that
  \begin{align*}
    \happly(\mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h))) &=
    \mapfunc{t}\circ\reflect(h)
  \end{align*}
  This is an equality in the type
  \[(c:\reflect(C))\to{}t(\reflect(i)(\reflect(f)(c)))=
  t(\reflect(j)(\reflect(g)(c)))\]
  This type is equal to
  \[t\circ\reflect(i)\circ\reflect(f) = t\circ\reflect(j)\circ\reflect(g)\]
  via $\funext$ so we only need to prove
  \begin{align*}
    \mapfunc{\ext}(\funext(\mapfunc{(t\circ\project_D)}\circ{}h)) &=
    \funext(\mapfunc{t}\circ\reflect(h)) \\
    &: t\circ\reflect(i)\circ\reflect(f) =
    t\circ\reflect(j)\circ\reflect(g)
  \end{align*}

  Note that for any appropriately typed $t$ and $p$ we have
  \[\funext(\mapfunc{t}\circ\happly(p))=\map{(\lam{u} t\circ{}u)}p\]
  (by induction on $p$.)
  Hence the previous equality becomes the following, using the definition of
  $\reflect(h)$ and expanding $h$ to $\happly(\funext(h))$:
  \[\map{\ext}{\map{(\lam{u} t\circ\project_D\circ{}u)}{\funext(h)}}=
  \map{(\lam{u} t\circ{}u)}{\map{\reflect}{\funext(h)}}\]

  The idea is now to do an induction on the path $\funext(h):i\circ f = j\circ
  g$, which should be allowed because nothing in the previous expression seems to
  depend on the fact that $\funext(h)$ goes from a composition to another
  composition.  But let's not forget that there are implicit equalities on
  both sides of the equation and they use the fact that $i\circ f$ and
  $j\circ g$ are compositions, so first we need to deal with that.

  % After that, using the fact that for every $k:C\to{}D$ we have

  % \begin{align*}
  %   \ext(t\circ\project_D\circ{}k) &= \ext(t\circ\project_D)\circ\reflect(k) \\
  %   &= t\circ\reflect(k)
  % \end{align*}

  % We will have

  % \[\ext\circ(\lam{u} t\circ\project_D\circ{}u)=
  % (\lam{u} t\circ{}u)\circ\reflect\]

  % Hence the result, using the functoriality of $f\mapsto{}f_*$.

  \bigskip

  % Let's prove that the implicit equalities around $\mapfunc{r}$ and
  % $\mapfunc{\ext}$ cancel.
  We have the following diagram:

  \[\xymatrix{
    t\circ\reflect(i\circ f) \ar@{=}[r] \ar@{=}[d] &
      t\circ\reflect(j\circ g) \ar@{=}[d] \\
    t\circ\reflect(i)\circ\reflect(f) \ar@{=}[d] &
      t\circ\reflect(j)\circ\reflect(g) \ar@{=}[d] \\
    \extend{t\circ\project_D}\circ\reflect(i)\circ\reflect(f) \ar@{=}[d] &
      \extend{t\circ\project_D}\circ\reflect(j)\circ\reflect(g) \ar@{=}[d] \\
    \extend{t\circ\project_D\circ i}\circ\reflect(f) \ar@{=}[d] &
      \extend{t\circ\project_D\circ j}\circ\reflect(g) \ar@{=}[d] \\
    \extend{t\circ\project_D\circ i\circ f} \ar@{=}[r] &
      \extend{t\circ\project_D\circ j\circ g}\\
  }\]

  \begin{itemize}
  \item The top horizontal equality is
    $\map{(\lam{u} t\circ{}u)}{\map{\reflect}{\funext(h)}}$ without the
    implicit equalities around.
  \item The first line of vertical equalities are the implicit equalities around
    $\map{(\lam{u} t\circ{}u)}{\map{\reflect}{\funext(h)}}$ (the
    right hand side of the equality we want to prove).
  \item The next two lines of vertical equalities are around the left hand side
    of the equality we want to prove and come from the long computation a few
    pages ago.
  \item The last line of vertical equalities are the implicit equalities around
    $\mapfunc{\extendsmb}$.
  \item The bottom horizontal equality is
    $\map{\ext}{\map{(\lam{u} t\circ\project_D\circ{}u)}{\funext(h)}}$
    without the implicit equalities around.
  \end{itemize}

  The commutativity of the diagram is the equality we want to prove and
  the fact that the compositions $i\circ f$ and $j\circ g$ are being split in
  the middle of the diagram is the reason why we cannot work directly, by induction on
  $\funext(h)$.

  So we will prove that the following diagram (where the vertical part is the
  right hand side of the previous diagram) commutes. Note that on the right hand
  side of this diagram, we do no longer use the fact that $j\circ g$ is a
  composition of two functions, so induction on it will be allowed.

  \[\xymatrix{
    t\circ\reflect(j\circ g) \ar@{=}[d] & \\
    t\circ\reflect(j)\circ\reflect(g) \ar@{=}[d] & \\
    \extend{t\circ\project_D}\circ\reflect(j)\circ\reflect(g) \ar@{=}[d] &
    \extend{t\circ\project_D}\circ\reflect(j\circ g) \ar@{=}[l] \ar@{=}[luu]
    \ar@{=}[ldd] \\
    \extend{t\circ\project_D\circ j}\circ\reflect(g) \ar@{=}[d] & \\
    \extend{t\circ\project_D\circ j\circ g} & \\
  }\]

  The top square commutes because it is the concatenation of the two equalities
  $t=\extend{t\circ\project_D}$ and $\reflect(j)\circ\reflect(g)=\reflect(j\circ
  g)$ in two different orders (interchange law). In order to prove that the
  bottom square commutes, we only have to prove that it commutes after
  composition with $\project_C$ on the right. Let's write $u=t\circ\project_D$
  and let's consider the following diagram.

  \[\xymatrix@C=-30pt{
    \extend{u}\circ\reflect(j)\circ\reflect(g)\circ\project_C
      \ar@{=}[rrrr] \ar@{=}[ddd] \ar@{=}[rd] & & & &
    \extend{u}\circ\reflect(j\circ g)\circ\project_C
      \ar@{=}[ld] \ar@{=}[ddd] \\ &
    \extend{u}\circ\reflect(j)\circ\project_B\circ g
      \ar@{=}[rr] \ar@{=}[d] & {\phantom{thisisanuglyhack}} &
    \extend{u}\circ\project_D\circ j\circ g
      \ar@{=}[d] & \\ &
    \extend{u\circ j}\circ\project_B\circ g
      \ar@{=}[rr] \ar@{=}[ld] & &
    u\circ j\circ g
      \ar@{=}[rd] & \\
    \extend{u\circ j}\circ\reflect(g)\circ\project_C
      \ar@{=}[rrrr] & & & &
    \extend{u\circ j\circ g}\circ\project_C
  }\]

  We need to prove that the outer square commutes.

  \begin{itemize}
  \item The left square commutes because of the interchange law
  \item The top square commutes because of the definition of the equality
    $\reflect(j\circ g)=\reflect(j)\circ\reflect(g)$
  \item The bottom, right and interior squares commute because of the definition
    of the equality $\extend{a}\circ\reflect(b)=\extend{a\circ b}$
  \end{itemize}

  This proves that the outer square commutes, hence the previous triangular
  diagram commutes. We can do the same for the left part of the first
  rectangular diagram so we now only have to prove that the following diagram
  commutes:

  \[\xymatrix{
    t\circ\reflect(i\circ f) \ar@{=}[r] \ar@{=}[d] &
      t\circ\reflect(j\circ g) \ar@{=}[d] \\
    \extend{t\circ\project_D}\circ\reflect(i\circ f) \ar@{=}[d] &
      \extend{t\circ\project_D}\circ\reflect(j\circ g) \ar@{=}[d] \\
    \extend{t\circ\project_D\circ i\circ f} \ar@{=}[r] &
      \extend{t\circ\project_D\circ j\circ g}\\
  }\]

  And now we are finally allowed to induct on $\funext(h)$ because the diagram
  is not relying anymore on the fact that $i\circ f$ and $j\circ g$ are
  compositions.

  \bigskip

  This proves that the diagram commutes, hence the map
  $t\mapsto{}\composecocone{t}\reflect(c)$ is an equivalence which proves that
  the reflector commutes with pushouts.
\end{proof}

This proof was rather tedious, but we can hope that at some point we will
understand better what $(\infty,1)$-functoriality means in homotopy type theory, and
that we will be able to omit rigorously the equalities left implicit above and still
conclude that every coherence condition is always satisfied.

\begin{cor}
  Every span $\Ddiag$ in $\P$ has a pushout in $\P$.
\end{cor}

\begin{proof}
  According to \autoref{reflectPequiv} and to the diagram defining the action of
  $\reflect$ on functions, the diagram $\reflect(\Ddiag)$ is equivalent to
  $\Ddiag$. But we just proved that $\reflect(\Ddiag)$ has a pushout, namely the
  reflection of the pushout in \type of $\Ddiag$, hence $\Ddiag$ has a pushout
  in \P.
\end{proof}

Similar (but simpler) arguments prove that any reflective subuniverse has an initial object (namely $\reflect(\emptyt)$), coproducts
(constructed as $\reflect(A+B)$), coequalizers, and so on.


\section{Modalities and factorization systems}
\label{sec:modalities}

\subsection{Definition and basic properties of modalities}

\begin{defn}
A modality is an operation $\modal:\type\to\type$ for which there are
\begin{enumerate}
\item functions $\mreturn^\modal_A:A\to\modal(A)$ for every type $A$.
\item for every $A:\type$ and every dependent type $P:\modal(A)\to\type$, a function
\begin{equation*}
R^\modal_A:\big(\prd{a:A}\modal(P(\mreturn^\modal_A(a)))\big)\to\prd{z:\modal(A)}\modal(P(z)).
\end{equation*}
\item A path $R^\modal_A(f)(\mreturn^\modal_A(a))= f(a)$ for each $f:\prd{a:A}\modal(P(\mreturn^\modal_A(a)))$.
\item For any $z,z':\modal(A)$ the type $\mreturn^\modal_{z=z'}$ is an equivalence.
\end{enumerate}
\end{defn}

From the definition we see that a modality $\modal$ is an idempotent monad on $\type$.

\begin{defn}
  We say that $A$ is \emph{modal} if the type $\ismodal A\defeq \mathsf{isEquiv}(\mreturn^\modal_A)$ is inhabited.
\end{defn}

\begin{defn}
  We define $\modaltype:=\sm{X:\type}\ismodal X$. 
\end{defn}

\begin{thm}\label{prop:lv_n_deptype_sec_equiv_by_precomp}
Let $A$ be a type and let $P:\modal(A)\to\modaltype$. Then the function
\begin{equation*}
\prd{z:\modal(A)}P(z)\to\prd{a:A}P(\mreturn^\modal_A(a))
\end{equation*}
given by $\lambda s.s\circ \mreturn^\modal_A$ is an equivalence.
\end{thm}

\begin{proof}
We only need to find a homotopy
\begin{equation*}
\prd{z:\modal(A)}s(z)= R^\modal_X(s\circ \mreturn^\modal_A)(z)
\end{equation*}
for each $s:\prd{z:\modal(A)}P(z)$. By assumption we have that $P(z)$ is
modal for each $z:\modal(A)$ and hence it follows that $s(z)= R^\modal_X(s\circ \mreturn^\modal_A)(z)$
is modal for each $z$. Hence it suffices to find a function of type
\begin{equation*}
\prd{a:A}s(\mreturn^\modal_A(a))= R^\modal_X(s\circ \mreturn^\modal_A)(\mreturn^\modal_A(a)),
\end{equation*}
which follows straight from the definition of modalities.
\end{proof}

In particular, for every type $A$ and every modal type $B$, we have an equivalence $(\modal A\to B)\simeq (A\to B)$.

\subsection*{Modal colimits}
The colimit of a diagram of modal types is in general not modal. For instance,
the suspension of $\varnothing$ is not a proposition but a set.
Moreover, the suspension of the circle is the sphere, which has no finite 
homotopy level in the classical theory. Therefore we need to define a notion of 
modal colimit, which is a colimit in the subcategory of modal types.

\begin{defn}
Let $\pairr{P,Q}$ be a diagram of shape $\pairr{I,J}$ with the property that each
$P(i)$ is modal. Then there is a cocone $\pairr{\alpha^\modal,\beta^\modal}$
 with vertex $\modal(\mathsf{colim}(P,Q))$ given by
\begin{align*}
\alpha^\modal & := \mreturn\circ\alpha\\
\beta^\modal & := \mreturn\circ\beta,
\end{align*}
where $\pairr{\alpha,\beta}$ is the colimiting cocone with vertex
$\mathsf{colim}(P,Q)$ and where $\mreturn:\mathsf{colim}(P,Q)\to\modal(\mathsf{colim}(P,Q))$
is the unit of the modality.
\end{defn}

\begin{lem}
The cocone $\pairr{\alpha^\modal,\beta^\modal}$ has the property that
\begin{equation*}
\mathsf{isEquiv}(\mathsf{coconeMap}(X,\pairr{\alpha^\modal,\beta^\modal}))
\end{equation*}
for every modal type $X$. In other words, $\modal(\mathsf{colim}(P,Q))$ is the
colimit in $\modaltype$. 
\end{lem}

\begin{proof}
Recall that $\modal(\mathsf{colim}(P,Q))$ has the property that for any modal
type $X$ the function $\lambda s.s\circ \mreturn$ is an equivalence
\begin{equation*}
(\modal(\mathsf{colim}(P,Q))\to X)\simeq (\mathsf{colim}(P,Q)\to X).
\end{equation*}
Since $\mathsf{colim}(P,Q)$ is colimiting, it follows that
\begin{equation*}
(\mathsf{colim}(P,Q)\to X)\simeq\mathsf{cocone}(X)
\end{equation*}
by $\mathsf{coconeMap}(X,\pairr{\alpha,\beta})$. Composing these two equivalences
gives the function $\mathsf{coconeMap}(X,\pairr{\alpha^\circ,\beta^\circ})$,
which is therefore an equivalence.
\end{proof}

\subsection{Localization}
The localization will make all the maps $B a \to
\mathcal{L}_P(X)$ constant in a free way.
\begin{defn}\label{defn:localization_as_hit}
Let $P:B\to\type$ be a dependent type. The localization $\mathcal{L}_P$ with
respect to $P$ is an operator of type $\type\to\type$, where
for each $X:\type$, the type $\mathcal{L}_P(X)$ is constructed as a higher
inductive type. The basic constructors of $\mathcal{L}_P(X)$ are
\begin{align*}
i & : X\to\mathcal{L}_P(X)
\intertext{and terms}
\alpha(f) & : \mathcal{L}_P(X)\\
\beta(f) & : \prd{u:P(b)}f(u)=\alpha(f)\\
\gamma(f) & : \prd{w:\mathcal{L}_P(X)}(H:f\sim\lambda u.w),\ w=\alpha(f)\\
\delta(f) & : \prd{w:\mathcal{L}_P(X)}(H:f\sim\lambda u.w)(u:P(b)),\ \gamma(f,H)
\bullet H(u)=\beta(f,u)
\end{align*}
for every $b:B$ and $f:P(b)\to\mathcal{L}_P(X)$. The induction principle for
$\mathcal{L}_P(X)$ is that for every dependent type $\Lambda:\mathcal{L}_P(X)
\to\type$ over $\mathcal{L}_P(X)$, if there are
\begin{align*}
I & : \prd{x:X}\Lambda(i(x))
\intertext{and for every $b:B$, $f:P(b)\to\mathcal{L}_P(X)$ and $F:\prd{u:P(b)}\Lambda(f(u))$}
\epsilon(F) & : \Lambda(\alpha(f))\\
\zeta(F) & : \prd{u:P(b)}\beta(f,u)\cdot F(f(u))= \epsilon(F)
\intertext{and for every $w_0:\mathcal{L}_P(X)$, $w_1:\Lambda(w_0)$, 
$H_0:f\sim\lambda u.w$ and $H_1:\prd{u:P(b)}H_0(u)\cdot F(f(u))= w_1$
a path}
\mreturn(F,H_1) & : \gamma(f,H_0)\cdot w_1= \epsilon(F)
\end{align*}
a path $\theta(F,H_1,u)$ witnessing the commutativity of the diagram
\begin{equation*}
\begin{tikzpicture}
\matrix (m) [std] {\beta(f,u)\cdot F(f(u)) & & \varepsilon(F) \\
\gamma(f,H_0)\cdot H_0(u)\cdot F(f(u)) & & \gamma(f,H_0)\cdot w_1 \\};
\draw[patharrow] (m-2-3) -- node[below] {$(\gamma(f,H_0)\cdot H_1(u))^{-1}$} (m-2-1);
\draw[patharrow] (m-2-1) -- node[left]  {$\delta(f,H_0,u)\cdot F(f(u))$} (m-1-1);
\draw[patharrow] (m-1-1) -- node[above] {$\zeta(f,u)$} (m-1-3);
\draw[patharrow] (m-2-3) -- node[right] {$\mreturn(F,H_1)$} (m-1-3);
\end{tikzpicture}
\end{equation*}
(note that in this diagram, we have not taken the canonical path
\begin{equation*}
\gamma(f,H_0)\cdot (H_0(u)\cdot F(f(u)))=(\gamma(f,H_0)\bullet H_0(u))\cdot F(f(u)),
\end{equation*}
but it should obviously be there), then there is a section $s:\prd{w:\mathcal{L}P}(X))$
with the property that there is a term
\begin{align*}
\kappa & : \prd{x:X}s(i(x))= I(x)
\intertext{and for every $b:B$ and $f:P(b)\to\mathcal{L}_P(X)$ there are terms}
\mu(f) & : s(\alpha(f))= \epsilon(s\circ f)\\
\nu(f) & : \prd{u:P(b)}\mu(f)\bullet s(\beta(f,u))=\zeta(s\circ f,\beta(f))\\
\xi(f) & : \prd{w:\mathcal{L}_P}(X)(H:f\sim\lambda u.w),\ \mu(f)\bullet s(\gamma(f,H))=\mreturn(s\circ f,s\circ H)
\end{align*}
and a term $o(f,H,u)$ witnessing the commutativity of the diagram
\begin{equation}
\begin{tikzpicture}
\matrix (m) [std] {\mu(f)\bullet s(\beta(f,u))\bullet (\delta(f,h,u)\cdot s(f(u)))\bullet (\gamma(f,H)\cdot s(H(u)))^{-1} & & \mu(f)\circ
s(\gamma(f,H)) \\ \zeta(s\circ f,s\circ\beta(f))\bullet (\delta(f,h,u)\cdot s(f(u)))\bullet (\gamma(f,H)\cdot s(H(u)))^{-1} & &
\mreturn(f,H)\\};
\draw[patharrow] (m-2-1) -- node[below] {$\theta(s\circ f,s\circ H,u)$} (m-2-3);
\draw[patharrow] (m-1-3) -- node[right] {$\xi(f)$} (m-2-3);
\draw[patharrow] (m-1-1) -- node[right]  {$\nu(f)^{-1}\rightwhisker ((\delta(f,H,u)\cdot s(f(u)))\bullet(\gamma(f,H)\cdot s(H(u)))$}(m-2-1);
\draw[patharrow] (m-1-1) -- node[above,yshift=1ex] {$s(\gamma(f,H))^{-1}\leftwhisker s(\delta(f,H,u))\rightwhisker s(\beta(f,u))$}(m-1-3);
\end{tikzpicture}
\end{equation}
\end{defn}

\section{Orthogonal factorization in type theory}
Every modality $\modal$ defines 
a stable factorization system $(\mathcal{E}_\modal,\mathcal{M}_\modal)$ with:
\begin{equation*}
\mathcal{E}_\modal(f)\equiv \prd{b:B}
\iscontr(\modal\hfiber{f}b).
\end{equation*}
and \Mcirc\ the class of functions all of which fibers are
modal, \emph{modal functions} for short. Specializing to the $n$-truncation, we show that there is a stable orthogonal
factorization
system $(\mathcal{E},\mathcal{M})$ where $\mathcal{E}$ is the
class of $n$-connected functions and $\mathcal{M}$ is the
class of $n$-truncated functions.

\subsection{Connectivity}
\begin{defn}
A function $f:A\to B$ is said to be $\modal$-connected if there is a term of type
\begin{equation*}
\mathsf{conn}_\modal(f):=\prd{b:B}\iscontr(\modal\hfiber{f}b). 
\end{equation*}
A type $A$ is said to be \modal-connected if the unique function
$A_!:A\to\unit$ is \modal-connected. Likewise, a dependent type
$P:A\to\type$ is said to be \modal-connected if $P(x)$ is \modal-connected for
every $x:A$. 
\end{defn}

A type $A$ is \modal-connected precisely when there is a term of type $\iscontr\modal A$. Thus, a function $f:A\to B$ is
$\modal$-connected if and only if $\hfib{f}b$ is \modal-connected for every $b:B$. 
A dependent type $P:A\to\type$ is \modal-connected
precisely when $\proj1:\sm{x:A} P(x)\to A$ is an \modal-connected function.

Every function is $(-2)$-connected and that a function is $(-1)$-connected precisely when it is surjective.

\begin{defn}\label{defn:retract}
A function $g:A\to B$ is said to be a retract of a function $f:X\to Y$ if there is a diagram
\begin{equation*}
\begin{tikzpicture}
\matrix (m) [std] {A & X & A \\ B & Y & B \\};
\draw[ar] (m-1-1) -- node[above] {$s$} (m-1-2);
\draw[ar] (m-1-2) -- node[above] {$r$} (m-1-3);
\draw[ar] (m-1-3) -- node[right] {$g$} (m-2-3);
\draw[ar] (m-1-2) -- node[left] {$f$} (m-2-2);
\draw[ar] (m-1-1) -- node[left] {$g$} (m-2-1);
\draw[ar] (m-2-1) -- node[below] {$s^\prime$} (m-2-2);
\draw[ar] (m-2-2) -- node[below] {$r^\prime$} (m-2-3);
\end{tikzpicture}
\end{equation*}
for which there are
\begin{enumerate}
\item a homotopy $R:r\circ s=\idfunc{A}$.
\item a homotopy $R^\prime:r^\prime\circ s^\prime=\idfunc{B}$.
\item a homotopy $L:f\circ s\sim s^=\circ g$.
\item a homotopy $K:g\circ r\sim r^=\circ f$.
\item paths $H(a)$ witnessing the commutativity of the square
\begin{equation*}
\begin{tikzpicture}
\matrix (m) [std] {g(r(s(a))) & r^\prime(f(s(a))) \\ g(a) & r^\prime(s^\prime(g(a))) \\};
\draw[patharrow] (m-1-1) -- node[left] {$g(R(a)))$} (m-2-1);
\draw[patharrow] (m-1-1) -- node[above] {$K(s(a))$} (m-1-2);
\draw[patharrow] (m-2-2) -- node[below] {$R^\prime(g(a))$} (m-2-1);
\draw[patharrow] (m-1-2) -- node[right] {$r^\prime(L(a))$} (m-2-2);
\end{tikzpicture}
\end{equation*}
for every $a:A$. 
\end{enumerate}
\end{defn}


\begin{lem}\label{lem:func_retract_to_fiber_retract}
If a function $g:A\to B$ is a retract of a function $f:X\to Y$, then $\hfib{g}b$ is a retract of $\hfib{f}{s^\prime(b)}$
for every $b:B$, where $s':B\to Y$ is as in definition \ref{defn:retract}. 
\end{lem}

\begin{proof}
Suppose that $g:A\to B$ is a retract of $f:X\to Y$. Then we have the functions
\begin{align*}
\varphi & :=\lambda\pairr{a,p}.\pairr{s(a),s^\prime(p)\bullet L(a)} & & :\hfiber{g}b\to\hfib{f}{s^\prime(b)}\\
\psi & := \lambda\pairr{x,q}.\pairr{r(x),R^\prime(b)\bullet r^\prime(q)\bullet K(x)} & &
:\hfib{f}{s^\prime(b)}\to\hfib{g}b
\end{align*}
Then we have $\psi(\varphi(\pairr{a,p}))\equiv\pairr{r(s(a)),R^\prime(b)\bullet r^\prime(s^\prime(p)\bullet L(a))\bullet K(s(a))}$. Our goal
is to show that
\begin{equation*}
\prd{b:B}(\pairr{a,p}:\hfib{g}b),\ \psi(\varphi(\pairr{a,p}))= \pairr{a,p},
\end{equation*}
which is of course equivalent to the type
\begin{equation*}
\prd{a:A}\psi(\varphi(\pairr{a,\idfunc{g(a)}})=\pairr{a,\idfunc{g(a)}}
\end{equation*}
By assumption, we have the path $R(a):r(s(a))= a$. So it is left to show that there is a path
\begin{equation*}
R(a)\cdot (R^\prime(g(a))\bullet r^\prime(L(a))\bullet K(s(a)))= \idfunc{g(a)}.
\end{equation*}
This transportation computes as $R^\prime(g(a))\bullet r^\prime(L(a))\bullet K(s(a))\bullet g(R(a))$, so the required path is given by
$H(a)$. This finishes the proof that $\hfib{g}b$ is a retract of $\hfib{f}{s^\prime(b)}$ for every $b:B$.
\end{proof}


\begin{lem}
Suppose that $g$ is a retract of a $\modal$-connected function $f$, then $g$ is
$\modal$-connected.
\end{lem}

\begin{proof}
This is a direct consequence of lemma \ref{lem:func_retract_to_fiber_retract}.
\end{proof}

\begin{cor}
If $g$ is homotopic to an $\modal$-connected function $f$, then $g$ is $\modal$-connected.
\end{cor}

\begin{lem}\label{lem:nconnected_postcomp}
Suppose that $f:A\to B$ is $\modal$-connected. Then $g:B\to C$ is $\modal$-connected if and only if $g\circ f$ is
$\modal$-connected.
\end{lem}

\begin{proof}
Let $c:C$. We have the equivalences
\begin{align*}
\modal\hfib{g\circ f}c& \simeq \modal \sm{w:\hfib{g}c}\hfib{f}{\proj1 w}\\
& \simeq \modal\sm{w:\hfib{g}c}\modal\hfib{f}{\proj1 w}\\
& \simeq \modal\hfib{g}c.
\end{align*}
It follows that $\modal\hfib{g}c$ is contractible if and only if $\modal\hfib{g\circ f}c$ is
contractible.
\end{proof}

The function $\mreturn:A\to\modal A$ is an example of a \modal-connected function is. Another prime example is the
canonical function $A\to\im_\modal(f)$ to the image of a function $f:A\to B$; see section \ref{sec:image_factorization}.

The fact that $\mreturn:A\to\modal A$ is \modal-connected is an immediate corollary of the following proposition.

\begin{lem}\label{prop:nconnected_tested_by_lv_n_dependent types}
A function $f:A\to B$ is \modal-connected if and only if for every $P:B\to\type_\modal$, the function
\begin{equation*}
\varphi :\big(\prd{b:B} P(b)\big)\to\big(\prd{a:A}P(f(a))\big)
\end{equation*}
defined by $\varphi(s):=s\circ f$ is an equivalence.
\end{lem}

\begin{proof}
Suppose that $f$ is \modal-connected and let $P:B\to\type$ be a dependent type over $B$. Then we have the equivalences
\begin{align*}
\prd{b:B} P(b) & \simeq \prd{b:B} \modal\hfib{f}b\to P(b)\\
& \simeq \prd{b:B} \hfib{f}b\to P(b)\\
& \simeq \prd{b:B}(a:A)(p:f(a)= b),\ P(b)\\
& \simeq \prd{a:A} P(f(a)).
\end{align*}
We omit the proof that this equivalence is indeed given by $\lambda s.s\circ f$. 

For the other direction, suppose that the function $\lambda s.s\circ f$ from $(\prd{b:B} P(b))$ to $(\prd{a:A} P(f(a)))$ is an
equivalence for each dependent type $P:B\to\type$ of homotopy level $n$. Considering the dependent type 
\begin{equation*}
b:B\vdash\modal\hfib{f}b:\modaltype,
\end{equation*}
we obtain from the assumed equivalence a term $c$ of type $\prd{b:B} \modal\hfib{f}b$ with
$c(f(a))\equiv\mreturn(\pair{a,\idfunc{f(a)}})$. To show that each $\modal\hfib{f}b$ is contractible 
we will find a function of type
\begin{equation*}
\prd{b:B}(w:\modal\hfib{f}b),\ w= c(b).
\end{equation*}
By the universal property of \modal\ the above type is equivalent to
\begin{equation*}
\prd{b:B}(a:A)(p:f(a)= b),\ \mreturn(\pairr{a,p})= c(b),
\end{equation*}
which is furthermore equivalent to the type
\begin{equation*}
\prd{a:A} \mreturn(\pairr{a,\idfunc{f(a)}})= c(f(a)).
\end{equation*}
This property holds by our choice of $c(f(a))$. 
\end{proof}

\begin{cor}\label{cor:totrunc_is_connected}
The canonical function $\mreturn:A\to\modal A$ is \modal-connected.
\end{cor}

\begin{proof}
For every dependent type $P:\modal A\to\modaltype$, the requested equivalence exists by proposition
\ref{prop:lv_n_deptype_sec_equiv_by_precomp}.
\end{proof}

The following two corollaries are mere reformulations of proposition \ref{prop:nconnected_tested_by_lv_n_dependent types}:

\begin{cor}
A function $f:A\to B$ is \modal-connected if and only if for every modal function $g:X\to B$, the function
\begin{equation*}
\varphi:\big(\prd{b:B}\hfib{g}b\big)\to\big(\prd{a:A} \hfib{g}{f(a)}\big)
\end{equation*}
defined by $\varphi(s):=s\circ f$ is an equivalence.
\end{cor}

\begin{cor}
A function $f:A\to B$ is \modal-connected if and only if for every modal function $g:X\to B$, the function
\begin{equation*}
\varphi :\big(\sm{h:B\to X} g\circ h\sim \idfunc{B}\big)\to\big(\sm{k:A\to X} g\circ k\sim f\big)
\end{equation*}
defined by $\varphi(h,H):=\pairr{h\circ f,H\circ f}$ is an equivalence.
\end{cor}

When we apply the above proposition to functions with codomain $\unit$ we obtain an assertion which is not very
interesting by itself, but it gives some intuition on how we should look at proposition \ref{prop:nconnected_tested_by_lv_n_dependent
types}:

\begin{cor}
A type $A$ is \modal-connected if and only if there is an equivalence
\begin{equation*}
(A\to B)\simeq B
\end{equation*}
for every modal type $B$.
\end{cor}

\begin{lem}\label{lem:nconnected_to_leveln_to_equiv}
Let $B$ be a modal type and let $f:A\to B$ be a function. Then the induced function $g:\modal A\to B$ is an
equivalence if and only if $f$ is \modal-connected.
\end{lem}

\begin{proof}
Note that $f$ is homotopic to $g\circ\mreturn$. By corollary \ref{cor:totrunc_is_connected} we know that $\mreturn$ is \modal-connected, so
by
lemma \ref{lem:nconnected_postcomp} $f$ is \modal-connected if and only if $g$ is \modal-connected. Since $g$ is a function between
modal types, the homotopy fibers of $g$ are modal. Hence it follows that $g$ is \modal-connected if and only if $g$ is an equivalence.
\end{proof}

A useful variation to lemma \ref{lem:nconnected_postcomp} is:
\begin{lem}\label{lem:nconnected_postcomp_variation}
Let $f:A\to B$ be a function and $P:A\to\type$ and $Q:B\to\type$ be dependent types. Suppose that $g:\prd{a:A},\ P(a)\to Q(f(a))$
is a fiberwise \modal-connected function, i.e.\ each $g(a)$ is assumed to be \modal-connected. Then the function
\begin{equation*}
\varphi\equiv\lambda\pairr{a,u}.\pairr{f(a),g(u)}:\big(\sm{a:A} P(a)\big)\to\big(\sm{b:B} Q(b)\big)
\end{equation*}
is \modal-connected if and only if $f$ is \modal-connected.
\end{lem}

\begin{proof}
For $b:B$ and $v:Q(b)$ we have
\begin{align*}
\modal\hfib{\varphi}{\pairr{b,v}} & \simeq \modal\sm{a:A}(u:P(a))(p:f(a)= b),\ f(p)\cdot g(u)= v\\
& \simeq \modal\sm{w:\hfib{f}b}(u:P(\proj1(w))),\ g(u)= f(p)^{-1}\cdot v\\
& \simeq \modal\sm{w:\hfib{f}b}\modal\hfib{g(\proj1 w}{f(p)^{-1}\cdot v}\\
& \simeq \modal\hfib{f}b
\end{align*}
where the transportations along $f(p)$ and $f(p)^{-1}$ are taken with respect to the dependent type $Q$. Therefore, both of them are
contractible whenever either of them is contractible.
\end{proof}

\begin{lem}\label{cor:trunc_prod}
For any two types $A,B$ we have an equivalence $\modal (A\times B) \simeq
\modal A \times \modal B$.
\end{lem}
\begin{proof}
 We show that $\modal A \times \modal B$ satisfies the universal property of $\modal (A\times B)$.
 Indeed, for each modal $C$ we have equivalences:
 \begin{align*}
&\modal A \times \modal B \to C\\
&\modal A \to C^{\modal B}\simeq C^B\\
&A\to C^B\\
&A\times B \to C
 \end{align*}
\end{proof}

\subsection{Orthogonal factorization through the \modal-image.}\label{sec:image_factorization}
\begin{defn}\label{def:modal_image}
Let $f:A\to B$ be a function. The \emph{\modal-image} of $f$ is defined as
\begin{equation*}
\im_\modal(f):=\sm{b:B} \modal\hfib{f}b
\end{equation*}
We also define $\im(f)$ for $\im_{-1}(f)$. 
\end{defn}


\begin{lem}
Let $P:A\to\type$ be defined by $P(x):=\unit$. Then
$\brck{A}\simeq\im(P)$.
\end{lem}

\begin{proof}
First we have to show that $\im(P)$ is a proposition. Suppose that $\pairr{X,u}:\im(P)$, we are essentially done showing
that
$\im(P)$ is a proposition if we show that $X\simeq \unit$. Note that $X\simeq\unit$ is a proposition, so there is an
equivalence
\begin{equation*}
\brck{\hfib{P}X}\to (X\simeq\unit))\simeq(\hfib{P}X\to(X\simeq\unit)).
\end{equation*}
The latter type is clearly inhabited and the type $\brck{\hfib{P}X}$ is inhabited by assumption. Therefore, there is a term
of $X\simeq\unit$.

Note that for any proposition $B$, there is an equivalence
\begin{equation*}
(\im(P)\to B)\simeq \big(\big(\sm{X:\type}(a:A),\ X\simeq P(a)\big)\to B\big) \simeq A\to B,
\end{equation*}
so $\im(P)$ satisfies the same universal property as $\brck{A}$. 
Therefore they are equivalent.
\end{proof}

\begin{lem}\label{prop:nconn_fiber_to_total}
Let $P,Q:A\to\type$ be dependent types and consider a fiberwise transformation
\begin{equation*}
f:\prd{a:A} P(a)\to Q(a)
\end{equation*}
from $P$ to $Q$. Then $\Sigma_A f$ is \modal-connected if and only if each $f(a)$ is \modal-connected. 
\end{lem}

\begin{proof}
Recall that we have the equivalence
\begin{equation*}
\hfib{\Sigma_A f}\pairr{x,v}\simeq\hfib{f(x)}v
\end{equation*}
for each $x:A$ and $v:Q(x)$. Hence $\modal\hfib{\Sigma_A f}\pairr{x,v}$ is contractible if and only if
$\modal\hfib{f(x)}v$ is contractible.
\end{proof}

\begin{lem}\label{prop:to_image_is_connected}
For any function $f:A\to B$, the canonical function $\tilde{f}:A\to\im_\modal(f)$ is \modal-connected. 
Consequently, any function factors as an \modal-connected function followed by a modal function.
\end{lem}

\begin{proof}
Note that $A\simeq\sm{b:B}\hfib{f}b$. The function $\tilde{f}$ is the function on total spaces induced by the fiberwise
transformation
\begin{equation*}
\lambda b.\eta^{\hfib{f}b}:\prd{b:B} \hfib{f}b\to\modal\hfib{f}b.
\end{equation*}
Since each $\eta$ is \modal-connected by corollary \ref{cor:totrunc_is_connected}, the statement follows from
proposition \ref{prop:nconn_fiber_to_total}.
\end{proof}

In the following proposition we set up some machinery to prove the unique factorization theorem.

\begin{thm}\label{prop:factor_equiv_fiber}
Suppose we have a commutative diagram of functions
\begin{equation*}
\begin{tikzpicture}
\node (A) at (-3em,0) {$A$};
\node (B) at (3em,0) {$B$};
\node (X1) at (0,1.5em) {$X_1$};
\node (X2) at (0,-1.5em) {$X_2$};
\draw[ar] (A) -- node[auto] {$g_1$} (X1);
\draw[ar] (X1) -- node[auto] {$h_1$} (B);
\draw[ar] (A) -- node[auto,swap] {$g_2$} (X2);
\draw[ar] (X2) -- node[auto,swap] {$h_2$} (B);
\end{tikzpicture}
\end{equation*}
with $H:h_1\circ g_1\sim h_2\circ g_2$, where $g_1$ and $g_2$ are \modal-connected and where $h_1$ and $h_2$ are modal.
Then there is an equivalence
\begin{equation*}
E(H,b):\hfib{h_1}b\simeq\hfib{h_2}b
\end{equation*}
for any $b:B$ such that the underlying map $\underline{E}(H,h_1(g_1(a)))$ of $E(H,h_1(g_1(a))$ maps $\pairr{g_1(a),\idfunc{h_1(g_1(a))}}$ to
$\pairr{g_2(a),H(a)^{-1}}$ for any $a:A$.
\end{thm}

\begin{proof}
Let $b:B$. Then we have the following equivalences:
\begin{align*}
\hfib{h_1}b & \simeq \sm{w:\hfib{h_1}b} \modal \hfib{g_1}{\proj1 w}\\
& \simeq \modal\sm{w:\hfib{h_1}b}\hfib{g_1}{\proj1 w}\\
& \simeq \modal\hfib{h_1\circ g_1}b
\end{align*}
and likewise for $h_2$ and $g_2$. Here, the first equivalence holds because $g_1$ is assumed to be \modal-connected; the second equivalence
holds because $h_1$ is assumed to be modal and the third equivalence holds by lemma \ref{lem:hfiber_basics}. Also, since we have a
homotopy $H:h_1\circ g_1\sim h_2\circ g_2$, there is an obvious equivalence $\hfib{h_1\circ g_1}b\simeq\hfib{h_2\circ g_2}b$. Hence we
obtain
\begin{equation*}
\hfib{h_1}b\simeq\hfib{h_2}b
\end{equation*}
               
for any $b:B$. By analyzing the underlying functions, we get the following representation of what happens to the term
$\pairr{g_1(a),\idfunc{h_1(g_1(a))}}$ after applying each of the equivalences of which $E$ is composed:
\begin{align*}
\pairr{g_1(a),\idfunc{h_1(g_1(a))}} & 
    \mapsto \pairr{\pairr{g_1(a),\idfunc{h_1(g_1(a))}}, \eta( \pairr{a,\idfunc{g_1(a)}} )}\\
  & \mapsto \eta( \pairr{\pairr{g_1(a),\idfunc{h_1(g_1(a))}}, \pairr{a,\idfunc{g_1(a)}} }\\
  & \mapsto \eta( \pairr{a,\idfunc{h_1(g_1(a))}})\\
  & \mapsto \eta( \pairr{a,H(a)^{-1}})\\
  & \mapsto \eta( \pairr{\pairr{g_2(a),H(a)^{-1}},\pairr{a,\idfunc{g_2(a)}}}\\
  & \mapsto \pairr{\pairr{g_2(a),H(a)^{-1}}, \eta(\pairr{a,\idfunc{g_2(a)}}) }\\
  & \mapsto \pairr{g_2(a),H(a)^{-1}}
\end{align*}
\end{proof}

The equivalences $E(H,b)$ are such that $E(H^{-1},b)= E(H,b)^{-1}$.

From propositions \ref{prop:to_image_is_connected} and \ref{prop:factor_equiv_fiber} we get the following unique factorization result:

\begin{thm}
For each $f:A\to B$, the space $\mathsf{factorizations}_\modal(f)$ defined by
\begin{equation*}
\sm{X:\type}(g:A\to X)(h:X\to B),\ (h\circ g\sim f)\times\mathsf{conn}_\modal(g)\times\ismodal\ h.
\end{equation*}
is contractible. By proposition \ref{prop:to_image_is_connected} we know that there is the term
\begin{equation*}
\pairr{\im(f),\tilde{f},\proj1,\theta,\varphi,\psi}:\mathsf{factorizations}_\modal(f)
\end{equation*}
where $\theta:\proj1\circ\tilde{f}\sim f$ is the canonical homotopy, where $\varphi$ is the proof of proposition
\ref{prop:to_image_is_connected}, and where $\psi$ is the obvious proof that $\proj1:\im(f)\to B$ has modal fibers.
\end{thm}

In the following proof we use the symbols $\leftwhisker$ and $\rightwhisker$ to denote the whisker operations. Recall that if we have paths
$p,p^\prime:x= y$, $s:p= p^\prime$ and $q:y= z$, then left whisker operation provides a path $q\bullet p=
q\bullet p^\prime$, wich is denoted by $q\leftwhisker s$. Likewise, if $f,f^\prime:X\to Y$ and $g:Y\to X$ are functions and if $H:f\sim
f^\prime$ is a homotopy, then there is a homotopy $g\leftwhisker H:g\circ f\sim g\circ f^\prime$.

\begin{proof}
By proposition \ref{prop:to_image_is_connected} we know that there is a term of $\mathsf{factorizations}_\modal(f)$, hence it is enough to
show that $\mathsf{factorizations}_\modal(f)$ is a proposition. Suppose we have two \modal-factorizations
\begin{equation*}
\pairr{X_1,g_1,h_1,H_1,\varphi_1,\psi_1}\qquad\text{and}\qquad\pairr{X_2,g_2,h_2,H_2,\varphi_2,\psi_2}
\end{equation*}
of $f$. Then we have the homotopy $H:=H_2^{-1}\circ H_1:h_1\circ g_1\sim h_2\circ g_2$. By the univalence axiom, it suffices to show that
\begin{enumerate}
\item there is an equivalence $e:X_1\simeq X_2$,
\item there is a homotopy $\zeta:\underline{e}\circ g_1\sim g_2$,
% \note{Is it easy enough to see that these terms are the various transports?}
\item there is a homotopy $\eta:h_2\circ\underline{e}\sim h_1$,
\item there is a homotopy $H_1 \circ(h_1\leftwhisker\zeta)^{-1}\circ(\eta\rightwhisker g_2)\sim H_2$.
\end{enumerate}
where $\underline{e}$ is the function underlying the equivalence. We prove these four assertions in that order.
\begin{enumerate}
\item By proposition \ref{prop:factor_equiv_fiber}, we have a fiberwise equivalence
% \note{It could be a nice exercise for the book to show
% that if $f_1:A_1\to B$ and $f_2:A_2\to B$ have equivalent fibers, then $A_1\simeq A_2$}.
\begin{equation*}
\prd{b:B} \hfib{h_1}b\to\hfib{h_2}b.
\end{equation*}
This induces an equivalence of total spaces, i.e.\ we have
\begin{equation*}
\sm{b:B} \hfib{h_1}b\simeq\sm{b:B}\hfib{h_2}b
\end{equation*}
Of course, we also have the familiar equivalences $X_1\simeq\sm{b:B}\hfib{h_1}b$ and $X_2\simeq\sm{b:B}
\hfib{h_2}b$. This gives us our equivalence $e(H):X_1\simeq X_2$. The reader may verify that the underlying function
$\underline{e}(H)$ of $e(H)$ is defined by
\begin{equation*}
\underline{e}(H,x):=\proj1\underline{E}(H^{-1},h_1(x))(\pairr{x,\idfunc{h_1(x)}})
\end{equation*}
\item By proposition \ref{prop:factor_equiv_fiber} we have $\underline{e}(H,g_1(a))=g_2(a)$. Thus we get $\zeta(a):=\idfunc{g_2(a)}$. 
\item For every $x:X_1$, we have
\begin{equation*}
\proj2\underline{E}(H^{-1},h_1(x))(\pairr{x,\idfunc{h_1(x)}}):h_2(\underline{e}(H,x))= h_1(x),
\end{equation*}
giving us a homotopy $\eta:h_2\circ \underline{e}\sim h_1$.
\item By proposition \ref{prop:factor_equiv_fiber} we have $\eta(g_1(a))=H(a)^{-1}$ and by {\it ii.} we have
$h_2(\zeta(a))=\idfunc{h_2(g_2(a))}$. Thus we have
\begin{align*}
(H_1 \circ(h_2\leftwhisker\zeta)^{-1}\circ(\eta\rightwhisker g_1))(a) & = H_1(a)\bullet h_2(\zeta(a))^{-1}\bullet \eta(g_1(a))\\
& = H_1(a)\bullet H(a)^{-1}\\
& = H_2(a).
\end{align*}
\end{enumerate}
\end{proof}

\begin{cor}
A function $f:A\to B$ is \modal-connected if and only if there is a term of type
\begin{equation*}
\prd C\prd{g:\modalfunc(B\to C)} \iscontr\big(\sm{h:\modalfunc(B\to C)}\underline{h}\circ
f\sim\underline{g}\circ f\big).
\end{equation*}
\end{cor}

\subsection{The principle of modal choice}\label{sec:ac_truncated}

In this section generalize the principle of unique choice to a lemma we call the principle of modal
choice, or simply $\mathsf{AC}_{\modal}$. We also introduce various degrees of surjectivity and see how they interact with modal choice.
We will derive
the principle of unique choice from the following more general discussion in corollary \ref{cor:auc}.

\begin{defn}
Suppose $P:A\to\type$ is a dependent type over a type $A$. We write $\{A\mid P\}\defeq\sm{A}{\brck{P}}$ and define:
\begin{align*}
\existsmodal(x:A),\ P(x) & \equiv \modal\sm{A}P\\
\existsmodalunique(P) & \equiv  (\existsmodal(x:A),\ P(x))\times\ismodal(\{A\mid P\}).
\end{align*}
\end{defn}

\begin{lem}\label{lem:modal_Sigma}
 Suppose that $A$ is modal and for each $a:A$, $B a$ is modal. Then $\sm{A}B$ is modal.
\end{lem}
\begin{proof}
We first define a map $\modal \sm{A}B\to \sm{A}B$ and then show that it is inverse to $\eta$. Consider $\hat{\proj1}:\modal \sm{A}B
\to \modal A$. Because $A$ is modal, this gives us an element $a:A$. Combining this with $\hat{\proj2^a}:\modal \sm{A}B \to \modal (B
a)$ and the modality of $B a$, we obtain an element of $\sm{A}B$. It is easy to check that this is in fact an inverse.
\end{proof}

\begin{lem}\label{lem:hlevel_sum_destructed}
Let $P:A\to\modaltype$. If $\ismodal(\{A\mid P\})$, then the total space $\sm{x:A}{P(x)}$ is modal. 
\end{lem}
\begin{proof}
Define $\tilde{P}:\{A\mid P\}\to \type$ by $\tilde{P}(a;p)\defeq P(a)$.
Then $\sm{A}P\simeq \sm{\{A\mid P\}}{\tilde{P}}$. The latter is a sum of modal types and hence itself modal by lemma~\ref{lem:modal_Sigma}.
\end{proof}

\begin{lem}[Iota]\label{lem:iota}
For every dependent type $P:A\to\modaltype$, there is a function
\begin{equation*}
\exists!_\modal(P)\to\sm{x:A}{P(x)}.
\end{equation*}
\end{lem}

\begin{proof}
Since $\ismodal(\{A\mid P\})$, by lemma \ref{lem:hlevel_sum_destructed}, 
it follows that $\sm{x:A}{P(x)}$ is modal, so there is
an equivalence $\existsmodal(x:A),\ P(x)\simeq\sm{x:A}{P(x)}$.
\end{proof}

\begin{thm}[The principle of modal choice]
Let $P:X\to\type$ and $R:\prd{x:X}(P(x)\to\modaltype)$. Then there is a function of type
\begin{equation*}
\prd{x:X} \existsmodalunique(R(x))\to\sum\big(f:\prd{x:X} P(x)\big)\prd{x:X} R(x,f(x)).
\end{equation*}
\end{thm}

\begin{proof}
Suppose that $\prd{x:X} \existsmodalunique(R(x))$. By lemma \ref{lem:iota}, 
we can find a term of type $\sm{u:P(x)}{R(x,u)}$
for every $x:X$. The statement now follows from the usual principle of choice.
\end{proof}

For truncation we obtain the principle of unique choice. 
However, the of principle of unique choice is usually stated quite differently:
the type $\ismodal(\{A\mid P\})$ may be replaced by the type
\begin{equation*}
\mathsf{atMostOne}(P) \equiv  \prd{x,y:A} P(x)\to P(y)\to(x= y)
\end{equation*}
However, a term of $\ismodal_{-1}(P)$ can be deduced from a term of $\mathsf{atMostOne}(P)$. This is the content of the following
lemma. In order to prove this, we will use that there is an equivalence
\begin{equation*}
\mathsf{isprop}(P)\simeq \prd{x,y:A} P(x)\to P(y)\to\iscontr(x= y)
\end{equation*}
This is not hard to verify, and a proof relies on the fact that $\pairr{x,u}=\pairr{x^\prime,u^\prime}$ is equivalent to the type
$x= x^\prime$ for any two terms $\pairr{x,u},\pairr{x^\prime,u^\prime}:\sm{x:A}{\brck{P(x)}}$.

% The following lemma will be used later on in the proof that images are strict coequalizers, see
% proposition\ref{prop:images_are_coequalizers}.

\begin{lem}\label{lem:atmostone_to_atlevel}
For any $P:A\to\type$, there is a function of type
\begin{equation*}
\mathsf{atMostOne}(P)\to\ismodal_{-1}(P).
\end{equation*}
\end{lem}

\begin{proof}
We will show that there is a function of type
\begin{equation*}
\mathsf{atMostOne}(P)\to\prd{x,y:A} P(x)\to P(y)\to\iscontr(x= y).
\end{equation*}
Let $H$ be a term of type $\mathsf{atMostOne}(P)$ and let $x,y:A$, $u:P(x)$ and $v:P(y)$. Our goal is to show that $x= y$ is
contractible by showing that for any $p:x= y$ there is a path $p= H(x,y,u,v)$. The idea is that we apply $H$ to the paths $p$ and
$H(x,y,u,v)$ to obtain a path between them. The following general statement is useful to compute the terms $H(p,z,u,w)$:

\begin{lem}
Suppose that $H:\prd{x,y:A} P(x)\to P(y)\to (x= y)$. Then for any $p:x= x^\prime$ and $q:y= y^\prime$ there are paths
\begin{align*}
(p\cdot H(x))(y,u^\prime,v) & = H(x,y,p^{-1}\cdot u^\prime,v)\bullet p^{-1} & & [u^\prime:P(x^\prime),\ v:P(y)]\\
(q\cdot H(x,y))(u,v^\prime) & = q\bullet H(x,y,u,p^{-1}\cdot v^\prime) & & [u : P(x),\ v^\prime :P(y^\prime)].
\end{align*} 
\end{lem}
The proof of this statement is by path induction. We see from the above that the path $H(p,H(x,y,u,v))$ induces a witness of the
commutativity of the diagram
\begin{equation*}
\begin{tikzpicture}
\matrix (m) [std] {x & y \\ x & y \\};
\draw[patharrow] (m-2-2) -- node[below] {$p^{-1}$} (m-2-1);
\draw[patharrow] (m-2-1) -- node[left]  {$H(x,x,u,u)$} (m-1-1);
\draw[patharrow] (m-1-1) -- node[above] {$H(x,y,u,v)$} (m-1-2);
\draw[patharrow] (m-2-2) -- node[right] {$H(y,y,v,v)$} (m-1-2);
\end{tikzpicture}
\end{equation*}
Therefore, the assertion would follow if there is a function of type
\begin{equation*}
\mathsf{atMostOne}(P)\to\sm{H^\prime:\mathsf{atMostOne}(P)}{\prd{x:X}{u:P(x)}}H^\prime(x,x,u,u)=\idfunc{x}.
\end{equation*}
This is easy, since we can define the function $H^\prime:\prd{x,y:X} P(x)\to P(y)\to(x= y)$ by
\begin{equation*}
H^\prime(x,y,u,v)\equiv H(x,y,u,v)\bullet H(x,x,u,u)^{-1}.
\end{equation*}
\end{proof}

\begin{defn}
Suppose $P:A\to\type$ is a dependent type over $A$. We define
\begin{equation*}
\exists!(x:A),\ P(x)\equiv \brck{\sm{x:A}P(x)}\times\mathsf{atMostOne}(P).
\end{equation*}
\end{defn}

\begin{cor}[The principle of unique choice]\label{cor:auc}
Let $P:X\to\type$ and $R:\prd{x:X} (P(x)\to\mathsf{hProp})$. Then there is a function
\begin{equation*}
\big(\prd{x:X} \exists !(u:P(x)),\ R(x,u)\big) \to
\sum \big(f:\prd{x:X} P(x)\big) \prd{x:X} R(x,f(x)).
\end{equation*}
\end{cor}

\subsection{Images are stable under pullbacks}
In this section we will show that pullbacks and images commute.

\begin{lem}\label{lem:hfiber_wrt_pullback}
Suppose that the square
\begin{equation*}
\begin{tikzpicture}
\matrix (m) [std] {A & C \\ B & D \\};
\draw[ar] (m-1-1) -- (m-1-2);
\draw[ar] (m-1-2) -- node[right] {$g$} (m-2-2);
\draw[ar] (m-1-1) -- node[left] {$f$} (m-2-1);
\draw[ar] (m-2-1) -- node[below] {$h$} (m-2-2);
\end{tikzpicture}
\end{equation*}
is a pullback square and let $b:B$. Then $\hfib{f}b\simeq\hfib{g}{h(b)}$.
\end{lem}

\begin{proof}
This follows from pasting of pullbacks, since the type $X$ in the diagram
\begin{equation*}
\begin{tikzpicture}
\matrix (m) [std] {X & A & C \\ \unit & B & D \\};
\draw[ar] (m-1-1) -- (m-1-2);
\draw[ar] (m-1-2) -- (m-1-3);
\draw[ar] (m-1-3) -- node[right] {$g$} (m-2-3);
\draw[ar] (m-1-2) -- node[left] {$f$} (m-2-2);
\draw[ar] (m-1-1) -- (m-2-1);
\draw[ar] (m-2-1) -- node[below] {$b$} (m-2-2);
\draw[ar] (m-2-2) -- node[below] {$h$} (m-2-3);
\end{tikzpicture}
\end{equation*}
is the pullback of the left square if and only if it is the pullback of the outer rectangle: $\hfib{f}b$ is the pullback of the
square on the left and $\hfib{g}{h(b)}$ is the pullback of the outer rectangle.
\end{proof}

\begin{thm}
Consider functions $f:A\to B$, $g:C\to D$ and the diagram
\begin{equation*}
\begin{tikzpicture}
\matrix (m) [std] {A & C \\ \im_\modal(f) & \im_\modal(g) \\ B & D \\};
\draw[ar] (m-1-1) -- (m-1-2);
\draw[ar] (m-1-2) -- node[right] {$\tilde{g}_n$} (m-2-2);
\draw[ar] (m-2-2) -- node[right] {$\proj1$} (m-3-2);
\draw[ar] (m-1-1) -- node[left] {$\tilde{f}_n$} (m-2-1);
\draw[ar] (m-2-1) -- (m-2-2);
\draw[ar] (m-2-1) -- node[left] {$\proj1$} (m-3-1);
\draw[ar] (m-3-1) -- node[below] {$h$} (m-3-2);
\end{tikzpicture}
\end{equation*}
Then the outer rectangle is a pullback if and only if the bottom square is a pullback. In either of these equivalent cases, the top square
is also a pullback. Consequently, images are stable under pullbacks.
\end{thm}

\begin{proof}
Suppose first that the outer square is a pullback. Note that we have the equivalences
\begin{align*}
B\times_D\im_\modal(g) & \equiv\sm{b:B}(w:\im_\modal(g)),\ h(b)=\proj1 w\\
& \simeq \sm{b:B}(d:D)(w:\modal\hfib{g}d),\ h(b)= d\\
& \simeq \sm{b:B} \modal\hfib{g}{h(b)}.\\
& \simeq \sm{b:B} \modal\hfib{f}b\\
& \equiv \im_\modal(f).
\end{align*}
In the last equivalence we have used lemma \ref{lem:hfiber_wrt_pullback}.

Now suppose that the bottom square is a pullback, of which we denote the top arrow by $\psi$. By the pasting lemma for pullbacks, it
suffices to show that the top square is a pullback. We have the equivalences
\begin{align*}
\im(f)\times_{\im(g)} C & \equiv \sm{w:\im(f)}(c:C),\ \psi(w)=\tilde{g}_n(c)\\
& \simeq \sm{b:B}(w:\im(g))(p:h(b)=\proj1 w)(c:C),\ w=\tilde{g}_n(c)\\
& \simeq \sm{b:B}(c:C),\ h(b)= g(c)\\
& \simeq \sm{b:B}\hfib{f}b\\
& \simeq A.
\end{align*}
\end{proof}

\section*{Notes}

\autoref{thm:hedberg} is due to Hedberg~\cite{hedberg1998coherence}; for more information and generalizations see~\cite{krausgeneralizations}.

\section*{Exercises}

\begin{ex}
  \begin{enumerate}
    \item Use \autoref{thm:h-set-refrel-in-paths-sets} to show 
    that if $\brck{A}\to A$ for every type $A$, 
    then every type is a set.
    \item Show that if every surjective function splits, 
    i.e.~if $\prd{b:B}\brck{\hfib{f}{b}}\to\prd{b:B}\hfib{f}{b}$
    for every $f:A\to B$, then every type is a set.
  \end{enumerate}
\end{ex}

\egroup

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "main"
%%% End: 
