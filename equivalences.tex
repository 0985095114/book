\chapter{Equivalences}
\label{cha:equivalences}

\section{Equivalences and Homotopies}

\begin{defn}\label{defn:contractible}
  A type $A$ is \textbf{contractible}, or a \textbf{singleton}, if there is $a:A$, called the \textbf{center of contraction}, such that $a=x$ for all $x:A$.
\end{defn}

\begin{defn}\label{defn:equivalence}
  A map $f:A\ra B$ is an {\em equivalence} if, for $y:B$, its {\em fiber}, $\setof{x:A | fx = y}$, is contractible.
  We write $\eqv A B$ for the type of equivalences $A\ra B$.
\end{defn}

\begin{lem}\label{lem:eq-rel}
The relation $\eqv A B$ is an equivalence relation on any universe $\bbU$:
\begin{enumerate}
\item For any type $A : \bbU$, we have $\eqv A A$
\item For any types $A, B : \bbU$, we have $\eqv A B \to \eqv B A$.
\item For any types $A, B, C : \bbU$, we have $\eqv A B \times \eqv B C \to \eqv A C$.
\end{enumerate}
\end{lem}
\begin{proof}
We can obtain a very concise proof using univalence. For example, in order to show symmetry we observe that by univalence, $\eqv {(\eqv A B)} {(A = B)}$ and of course also $\eqv {(\eqv B A)} {(B = A)}$. Thus it suffices to exhibit a function of type $A = B \to B = A$. However, this is trivial since we have already shown that equality is symmetric.
\end{proof}
We remark that univalence is not necessary to prove the above lemma but it simplifies the proof considerably. For comparison, we have the following direct proof of reflexivity:
\begin{lem}\label{lem:id-map}
For each type $A$, the identity map $\idfunc[A]\defeq \lambda_{x:A}x :A\ra A$ is an equivalence.
\end{lem}
\begin{proof}
  Let $a:A$ and let $\{a\}_A\defeq \setof{ x:A | x=a }$ be its fiber with respect to $\idfunc[A]$.
  We show that $\{ a\}_A$ is contractible.
  Then, discharging $a:A$, we get that $\fall{x:A} (\{ x\}_A$ is contractible); i.e.\ $\idfunc[A]$ is an equivalence.

  Let $\oa \defeq (a,\refl{a}):\{ a\}_A$.  As $(a,\refl{a}) = \oa$ we can use Id-induction \`{a} la Christine-Paulin to get
  \[\fall{x:A}{z:x=a} ((x,z)=\oa).\]
  Hence, by $\Sigma$-folding, $\fall{u:\{ a\}_A} (u=\oa)$.
  Thus $\{ a\}_A$ is contractible, as desired.
\end{proof}

\begin{defn}\label{defn:homotopy-between-functions}
  A \textbf{homotopy, $f\sim f'$} between maps $f,f':A\ra B$ is a function $h:\prd{x:A} (f(x)=f'(x))$.
\end{defn}

\begin{lem}\label{lem:homotopy-props}\ 
\begin{enumerate}
\item $\sim$ is an equivalence relation on each function type $A\ra B$.
  That is, we have terms of types
  \begin{gather*}
    \prd{f:A\to B} (f\sim f)\\
    \prd{f,g:A\to B} (f\sim g) \to (g\sim f)\\
    \prd{f,g,h:A\to B} (f\sim g) \to (g\sim h) \to (f\sim h).
  \end{gather*}
\item If $f:A\ra B$ then $f\circ \idfunc[A]\sim f\sim \idfunc[B]\circ f$.
\item If $f:A\ra B, g:B\ra C$ and $h:C\ra D$ then $h\circ (g\circ f)\;\sim\; (h\circ g)\circ f$.
\end{enumerate}
\end{lem}

%% TODO: This should probably be folded into wherever we discuss function extensionality, so that $(f\sim g)\eqv (f=g)$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Bijections and Isomorphisms}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{defn} \label{defn:isos}
Let $f:A\ra B$.
\begin{enumerate}
\item $f$ is a {\em bijection} if it is both injective and surjective, where
\begin{itemize}
\item $f$ is {\em injective} if $\forall_{x,x':A}\; \; fx=fx'\;\ra\; x=x'$,
\item $f$ is {\em surjective} if $\forall_{y:B}\exists_{x:A}\;\; fx=y$,
\end{itemize}
\item $f$ is {\em an isomorphism} if it has $g:B\ra A$ that is both a left and a right
inverse where,
\begin{itemize} \item $g:B\ra A$ is a {\em left/right inverse} to $f$ if 
$g\circ f\sim \idfunc[A]$/$f\circ g\sim \idfunc[B]$.
\end{itemize}
\item $f$ is {\em (left/right)-invertible} if it has a (left/right) inverse.
\item $f$ is a {\em weak isomorphism} if it is both left invertible and right invertible.
\item We write $A\cong B$ if there is an isomorphism $A\ra B$, and $A\cong_w B$ if there is a weak isomorphism $A\to B$.
\end{enumerate}
\end{defn}


\begin{thm}\label{thm:isos-id-and-composition} $\;$
\begin{enumerate}
\item $f:A\ra B$ is a surjection iff it is right-invertible.
\item If $f:A\ra B$ is left-invertible then it is injective.
\item $\idfunc[A]:A\ra A$ is an isomorphism.
\item If $f:A\ra B$ and $g:B\ra C$ are isomorphisms then so is $g\circ f:A\ra C$.
\end{enumerate}
\end{thm}
\begin{proof} Routine
\end{proof}
\begin{thm}\label{thm:bijections-isos}
The following are logically equivalent for $f:A\ra B$.
\begin{enumerate}
\item $f$ is a bijection.
\item $\forall_{y:B}\exists_{x:A}\;\; (fx=y\;\wedge \forall_{x':A}\;\; (fx'=y\;\ra\; x=x'))$.
\item $f$ is an isomorphism.
\item $f$ is a weak isomorphism.
\end{enumerate}
\end{thm}
\begin{proof}
The proof of this proposition in type theory can be done by proving the implications $(i)\ra (ii)\ra (iii)\ra (iv)\ra (i)$.  $(i)\ra (ii)$ and $(iii)\ra (i)$ are the same as in set theory.  The proof that $(ii)\ra (iii)$ requires, given $(ii)$, the proof of the existence of a function $g$ inverse to $f$.  In set theory this uses the fact that functions are defined to be total single-valued relations.  Instead, in type theory the proof of the existence of $g$
uses the non-dependent version of the type theoretic axiom of choice.  This axiom holds in the propositions as types interpretation of logic because of the strong form of the existential quantifier.  For $(iv)\ra (i)$ let $f$ be both left and right invertible.  By (i) and (ii) of Theorem~\ref{thm:isos-id-and-composition}, $f$ is both injective and surjective and hence a bijection.  
\end{proof}
\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Adjoint  Isomorphisms}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\comment{%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
In order to define the notion of an adjoint isomorphism we need the following definition.
\begin{defn} $\;$
If $f:A\ra B$ define, by Id-induction, $fz:fx=fx'$ for $x,x':A, z:x=x'$ such that $f\refl{x} = \refl{fx}$ for $x:A$.
\end{defn}
}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{defn} A function $f:A\ra B$ is an {\em adjoint isomorphism} if there are $g:B\ra A$, $\eta:\forall_{x:A}\; [x=g(fx)]$ and $\epsilon:\forall_{y:B}\; [f(gy)=y]$ such that 
  \[\forall_{x:A}\;[(\map{f}{\eta x}\; \ct\;\epsilon(fx))=\refl{fx}].\]
We write $A\cong_a B$ if there is an adjoint isomorphism $A\ra B$.
\end{defn}
We note that in the above definition, the coherence condition relating $\eta$ and $\epsilon$ only involves $f$. There is an analogous coherence condition involving $g$:
  \[\forall_{y:B}\;[(\eta(gy) \; \ct\;\map{g}{\epsilon y})=\refl{gy}].\]
It turns out each of these conditions implies the other, as shown in Lemma $\ref{lem:coh-equiv}$ below. First we need a couple of auxiliary lemmas:

\begin{lem}\label{lem:natur}
Let us have an endofunctor $P : A \to A$ such that $\eta : \forall_{x:A}\; [x=g(fx)]$, i.e., $\eta : \idfunc[A] \sim g \circ f$. Then for any path $p : x = x'$ in $A$, the following square commutes:

\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{x \ar^p[r] \ar_{\eta x}[d] & x' \ar^{\eta x'}[d] \\ gfx \ar_{gfp}[r] & gfx'
  }\]
We call this property the naturality of $\eta$.
\end{lem}
\begin{proof}
Induction on $p$.
\end{proof}

\begin{cor}\label{cor:nat-equiv}
Let $f:A\ra B$, $g:B\ra A$, $\eta:\forall_{x:A}\; [x=g(fx)]$, and $\epsilon:\forall_{y:B}\; [f(gy)=y]$ be given. Then for any $p : \id[A]{x}{x'}$ and $q : \id[B]{y}{y'}$ the following diagrams commute:

\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{x \ar^{p}[r] \ar_{\eta x}[d] & x' \ar^{\eta x'}[d] \\ gfx \ar_{gf(p)}[r] & gfx'
  }\]
 
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{fgy \ar^{fg(q)}[r] \ar_{\epsilon y}[d] & fgy' \ar^{\epsilon y'}[d] \\ y \ar_{q}[r] & y'
  }\]
\end{cor}
\begin{proof}
The first diagram is obtained by applying Lemma \ref{lem:natur} with $P \defeq g \circ f$ and $\eta \defeq \eta$. The second one is obtained by the same lemma, with $P \defeq f \circ g$ and $\eta \defeq \epsilon^{-1}$, with $\epsilon^{-1} : \forall_{y:B}\; [y=f(gy)]$ the opposite homotopy of $\epsilon$. 
\end{proof}

\begin{cor}\label{cor:fg}
Let $f:A\ra B$, $g:B\ra A$, $\eta:\forall_{x:A}\; [x=g(fx)]$, and $\epsilon:\forall_{y:B}\; [f(gy)=y]$ be given. Then for any $x:A$, $y : B$ we have 
\begin{itemize}
\item $gf(\eta x) = \eta(gfx)$
\item $fg(\epsilon y) = \epsilon (fgy)$
\end{itemize}
\end{cor}
\begin{proof}
Use Lemma \ref{cor:nat-equiv} with $p \defeq \eta x$ and $q \defeq \epsilon y$.
\end{proof}

\begin{lem}\label{lem:coh-equiv}
Let $f:A\ra B$, $g:B\ra A$, $\eta:\forall_{x:A}\; [x=g(fx)]$, and $\epsilon:\forall_{y:B}\; [f(gy)=y]$ be given. Then the following coherence conditions are logically equivalent:
\begin{enumerate}
\item $\forall_{x:A}\;[(\map{f}{\eta x}\; \ct\;\epsilon(fx))=\refl{fx}].$
\item $\forall_{y:B}\;[(\eta(gy) \; \ct\;\map{g}{\epsilon y})=\refl{gy}].$
\end{enumerate}
\end{lem}
\begin{proof}
We show $(i)\ra (ii)$; the other direction is analogous. Using Corollary \ref{cor:nat-equiv} and applying $g$, the following diagram commutes:
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{gfgfgy \ar^{gfg(\epsilon y)}[r] \ar_{g(\epsilon (fgy))}[d] & gfgy \ar^{g(\epsilon y)}[d] \\ gfgy \ar_{g(\epsilon y)}[r] & gy
  }\]
By assumption $i)$ we have $\epsilon (fgy) = \opp{f (\eta (gy))}$, thus
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{gfgfgy \ar^{gfg(\epsilon y)}[r] & gfgy \ar^{g(\epsilon y)}[d] \\ gfgy \ar_{g(\epsilon y)}[r] \ar^{gf(\eta (gy))}[u] & gy
  }\]
By Corollary \ref{cor:fg} we have $gf(\eta(gy)) = \eta(gfgy)$, thus
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{gfgfgy \ar^{gfg(\epsilon y)}[r] & gfgy \ar^{g(\epsilon y)}[d] \\ gfgy \ar_{g(\epsilon y)}[r] \ar^{\eta (gfgy)}[u] & gy
  }\]
However, by Lemma \ref{cor:nat-equiv} we also have
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{gfgfgy \ar^{gfg(\epsilon y)}[r] & gfgy  \\ gfgy \ar_{g(\epsilon y)}[r] \ar^{\eta (gfgy)}[u] & gy \ar_{\eta(gy)}[u]
  }\]
Thus we have $g(\epsilon y) = \opp{\eta(g y)}$ as desired.
\end{proof}

\begin{lem}\label{lem:hfib}
Let $f : A \to B$ and $y : B$. For any $(x,p), (x',p') : \mathtt{hfiber} \; f \;y$, giving a path $(x,p) = (x',p')$ is equivalent to giving a path $\gamma : x = x'$ such that $p = f\gamma \ct p' $. 
\end{lem}
\begin{proof}
Use the known interactions between $\Sigma$-types, identity types, and transports.
\end{proof}

\begin{thm}\label{thm:equiv-iso-adj} The following are logically equivalent for $f:A\ra B$.
\begin{enumerate}
\item $f$ is an equivalence.
\item $f$ is a weak isomorphism
\item $f$ is an adjoint isomorphism
\end{enumerate}
\end{thm}
\begin{proof} $\;$

\begin{description}
\item[$(i)\ra (ii)$] 
Let $f:A\ra B$ be an equivalence.  So each type $Cy$ is contractible, where for $y:B$, $Cy \defeq \Sigma_{x:A}\; fx=y$.  This means that
  \[ \forall_{y:B}\exists_{u:Cy}\forall_{u':Cy}\; u'=u.\]
By $\Sigma$-unfolding we get
  \[ \forall_{y:B}\exists_{x:A}\exists_{z:(fx=y)}
                            \forall_{x':A}\forall_{z':(fx'=y)}\; (x,z)=(x',z').
  \]
It follows that
  \[ \forall_{y:B}\exists_{x:A}[fx=y\wedge\forall_{x':A}(fx'=y\ra  x=x')].
  \]
Hence, by $(ii)\ra (iv)$ of \autoref{thm:bijections-isos} , $f$ is a weak isomorphism.
\item[$(ii)\ra (iii)$] By Theorem \ref{thm:bijections-isos}, $f$ is an isomorphism. Thus by Theorem ?? (in section Basics, does not have a label) it is an adjoint isomorphism.

\item[$(iii)\ra (i)$] Let $(f,g,\eta,\epsilon,\theta)$ be an ajoint isomorphism. We intend to show that every homotopy fiber of $f$ is contractible. Fix $y : B$.
As our center of contraction for $\mathtt{hfiber} \; f \;y$ we put $c \defeq (gy, \epsilon y)$. Now take any $c' \defeq (x, p)$ in $\mathtt{hfiber} \; f \;y$. We want to show that $c = c'$. According to Lemma \ref{lem:hfib}, it suffices to give a path $\gamma : \id{gy}{x}$ such that $\epsilon y = f(\gamma) \ct p$. We put $\gamma \defeq {\opp{gp}} \ct {\eta x}$. Then we have 
\begin{align*}
f(\gamma) \ct p & = \opp{fgp} \ct {f (\eta x)} \ct p \\
& = \opp{fgp} \ct {\epsilon(f x)} \ct p \\
& = \epsilon y
\end{align*}
where the last equality follows by the naturality of $\epsilon$.

\end{description}
\end{proof}
\begin{cor}\label{cor:equivs-equiv}
For types $A,B$ we have the following sequence of two equivalences and a logical equivalence
between our four equivalence relations.
  \[ (\eqv A B) \simeq (A\cong_a B) \simeq (A\cong_w B) \leftrightarrow (A\cong B).\]
\end{cor}
\begin{proof} ??

\end{proof}

\section{Identity Systems on a Type Universe}
\newcommand{\sfr}[1]{{{\sf r}_{#1}}}
Let $\bbU$ be a type universe.

\begin{defn} An {\em identity system $(R,\sfr{})$ on $\bbU$} consists of a type $R_{A,B}$ for $A,B:\bbU$, together with $\sfr{A}:R_{A,A}$ for $A:\bbU$, such that the following holds.  
\begin{quote}
If $D_{A,B}(e)$ is a type for $A,B:\bbU$ and $e:R_{A,B}$ then there is   
  \[ J_{A,B}(e):D_{A,B}(e)\mbox{ for } A,B:\bbU \mbox{ and } e:R_{A,B},\] 
such that
  \[ J_{A,A}(\sfr{A})=d_A\mbox{ for } A:\bbU.\]
\end{quote}
\end{defn}
\begin{eg}
$(Id_\bbU,\refl{\bbU})$ is an identity system on $\bbU$.
\end{eg}
\begin{thm}
If $(R,\sfr{})$ is an identity system on $\bbU$ then
\begin{enumerate}
\item $R_{A,B}\ra \eqv{A}{B}$ for $A,B:\bbU$
\item If $f_e:A\ra B$ and $g_e:B\ra A$ for $A,B:\bbU$ and $e:R_{A,B}$ such that 
  \[ f_{\sfr{A}} = g_{\sfr{A}}=\idfunc[A]\mbox{ for } A:\bbU\] 
then
  \[ g_e\circ f_e =\idfunc[A]\mbox{ and } f_e\circ g_e = \idfunc[B]
      \mbox{ for }  A,B:\bbU \mbox{ and } e:R_{A,B} \]
\end{enumerate}
\end{thm}
\newcommand{\sfequiv}[1]{{\sf reflequiv}^\bbU_{#1}}
\begin{rmk} Once we have the notion of a univalent type universe we can get the following result. 
\end{rmk}
\begin{thm}
$\bbU$ is a univalent type universe iff $(Equiv^\bbU,\sfequiv{})$ is an identity system on $\bbU$, where
  \[ Equiv^\bbU_{A,B}\defeq (\eqv{A}{B})\mbox{ for } A,B:\bbU\]
and, if $s_A: (\idfunc[A]\mbox{ is an equivalence }A\ra A)$,
  \[ \sfequiv{A}\defeq (\idfunc[A],s_A):\eqv{A}{A}\mbox{ for } A:\bbU.\]
\end{thm}


Using the two theorems I believe (from a still mysterious coq proof of Assia and Cyril) that we can get a quick proof of function extensionality on a univalent universe.
% Local Variables:
% TeX-master: "main"
% End:
