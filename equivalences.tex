\newcommand{\com}[3]{\mathtt{swap}_{#1,#2}(#3)}
\newcommand{\coh}[3]{\mathtt{coh} \; #1 \; #2 \; #3}

\chapter{Equivalences}
\label{cha:equivalences}

\section{Equivalences and Homotopies}

\begin{defn}\label{defn:contractible}
  A type $A$ is \textbf{contractible}, or a \textbf{singleton}, if there is $a:A$, called the \textbf{center of contraction}, such that $a=x$ for all $x:A$.
\end{defn}

\begin{defn}\label{defn:equivalence}
  A map $f:A\ra B$ is an {\em equivalence} if, for $y:B$, its {\em fiber}, $\setof{x:A | fx = y}$, is contractible.
  We write $\eqv A B$ for the type of equivalences $A\ra B$.
\end{defn}

\begin{lem}\label{lem:eq-rel}
The relation $\eqv A B$ is an equivalence relation on any universe $\bbU$:
\begin{enumerate}
\item For any type $A : \bbU$, we have $\eqv A A$
\item For any types $A, B : \bbU$, we have $(\eqv A B) \to (\eqv B A)$.
\item For any types $A, B, C : \bbU$, we have $(\eqv A B) \times (\eqv B C) \to (\eqv A C)$.
\end{enumerate}
\end{lem}
\begin{proof}
We can obtain a very concise proof using univalence. For example, in order to show symmetry we observe that by univalence, $\eqv {(\eqv A B)} {(A = B)}$ and of course also $\eqv {(\eqv B A)} {(B = A)}$. Thus it suffices to exhibit a function of type $(A = B) \to (B = A)$. However, this is trivial since we have already shown that equality is symmetric.
\end{proof}
We remark that univalence is not necessary to prove the above lemma but it simplifies the proof considerably. For comparison, we have the following direct proof of reflexivity:
\begin{lem}\label{lem:id-map}
For each type $A$, the identity map $\idfunc[A]\defeq \lambda_{x:A}x :A\ra A$ is an equivalence.
\end{lem}
\begin{proof}
  Let $a:A$ and let $\{a\}_A\defeq \setof{ x:A | x=a }$ be its fiber with respect to $\idfunc[A]$.
  We show that $\{ a\}_A$ is contractible.
  Then, discharging $a:A$, we get that $\fall{x:A} (\{ x\}_A$ is contractible); i.e.\ $\idfunc[A]$ is an equivalence.

  Let $\oa \defeq (a,\refl{a}):\{ a\}_A$.  As $(a,\refl{a}) = \oa$ we can use Id-induction \`{a} la Christine-Paulin to get
  \[\fall{x:A}{z:x=a} ((x,z)=\oa).\]
  Hence, by $\Sigma$-folding, $\fall{u:\{ a\}_A} (u=\oa)$.
  Thus $\{ a\}_A$ is contractible, as desired.
\end{proof}

\begin{defn}\label{defn:homotopy-between-functions}
  A \textbf{homotopy, $f\sim f'$} between maps $f,f':A\ra B$ is a function $h:\prd{x:A} (f(x)=f'(x))$.
\end{defn}

\begin{lem}\label{lem:homotopy-props}\ 
\begin{enumerate}
\item $\sim$ is an equivalence relation on each function type $A\ra B$.
  That is, we have terms of types
  \begin{gather*}
    \prd{f:A\to B} (f\sim f)\\
    \prd{f,g:A\to B} (f\sim g) \to (g\sim f)\\
    \prd{f,g,h:A\to B} (f\sim g) \to (g\sim h) \to (f\sim h).
  \end{gather*}
\item If $f:A\ra B$ then $f\circ \idfunc[A]\sim f\sim \idfunc[B]\circ f$.
\item If $f:A\ra B, g:B\ra C$ and $h:C\ra D$ then $h\circ (g\circ f)\;\sim\; (h\circ g)\circ f$.
\end{enumerate}
\end{lem}

\begin{lem}\label{lem:hom-nat}
(Naturality of homotopies) Let $h : f \sim g$ be a homotopy between $f,g : A \to B$. For any path $p : \id[A]{x}{y}$, the following diagram commutes:
\begin{align*}
\xymatrix{
fx \ar[r]^{fp} \ar[d]_{hx} & fy \ar[d]^{hy} \\
gx \ar[r]_{gp} & gy
}
\end{align*}
The higher path witnessing this will be denoted by $h(p)$.
\end{lem}

\begin{cor}\label{cor:hom-fg}
Let $h : P \sim \idfunc[A]$ be a homotopy, with $f : A \to A$. Then for any $x : A$ we have \[ h(fx) = f(hx) \] The above path will be denoted by $\com{h}{P}{x}$.
\end{cor}
\begin{proof}
By naturality of $h$ the following diagram commutes:
\begin{align*}
\xymatrix{
ffx \ar[r]^{f(hx)} \ar[d]_{h(fx)} & fx \ar[d]^{hx} \\
fx \ar[r]_{hx} & x
}
\end{align*}
Thus $h(fx) = f(hx)$ as desired.
\end{proof}

%% TODO: This should probably be folded into wherever we discuss function extensionality, so that $(f\sim g)\eqv (f=g)$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Bijections and Isomorphisms}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{defn} \label{defn:isos}
Let $f:A\ra B$.
\begin{enumerate}
\item $f$ is a {\em bijection} if it is both injective and surjective, where
\begin{itemize}
\item $f$ is {\em injective} if $\forall_{x,x':A}\; \; fx=fx'\;\ra\; x=x'$,
\item $f$ is {\em surjective} if $\forall_{y:B}\exists_{x:A}\;\; fx=y$,
\end{itemize}
\item $f$ is {\em an isomorphism} if it has $g:B\ra A$ that is both a left and a right
inverse where,
\begin{itemize} \item $g:B\ra A$ is a {\em left/right inverse} to $f$ if 
$g\circ f\sim \idfunc[A]$/$f\circ g\sim \idfunc[B]$.
\end{itemize}
\item $f$ is {\em (left/right)-invertible} if it has a (left/right) inverse.
\item $f$ is a {\em weak isomorphism} if it is both left invertible and right invertible.
\item We write $A\cong B$ if there is an isomorphism $A\ra B$, and $A\cong_w B$ if there is a weak isomorphism $A\to B$.
\end{enumerate}
\end{defn}


\begin{thm}\label{thm:isos-id-and-composition} $\;$
\begin{enumerate}
\item $f:A\ra B$ is a surjection iff it is right-invertible.
\item If $f:A\ra B$ is left-invertible then it is injective.
\item $\idfunc[A]:A\ra A$ is an isomorphism.
\item If $f:A\ra B$ and $g:B\ra C$ are isomorphisms then so is $g\circ f:A\ra C$.
\end{enumerate}
\end{thm}
\begin{proof} Routine
\end{proof}
\begin{thm}\label{thm:bijections-isos}
The following are logically equivalent for $f:A\ra B$.
\begin{enumerate}
\item $f$ is a bijection.
\item $\forall_{y:B}\exists_{x:A}\;\; (fx=y\;\wedge \forall_{x':A}\;\; (fx'=y\;\ra\; x=x'))$.\footnote{One could consider calling this notion ``bijection`` and the other one ``weak bijection``, to match the terminology for isomorphism and weak isomorphism.}
\item $f$ is an isomorphism.
\item $f$ is a weak isomorphism.
\end{enumerate}
\end{thm}
\begin{proof}
The proof of this proposition in type theory can be done by proving the implications $(i)\ra (ii)\ra (iii)\ra (iv)\ra (i)$.  $(i)\ra (ii)$ and $(iii)\ra (i)$ are the same as in set theory.  The proof that $(ii)\ra (iii)$ requires, given $(ii)$, the proof of the existence of a function $g$ inverse to $f$.  In set theory this uses the fact that functions are defined to be total single-valued relations.  Instead, in type theory the proof of the existence of $g$
uses the non-dependent version of the type theoretic axiom of choice.  This axiom holds in the propositions as types interpretation of logic because of the strong form of the existential quantifier.  For $(iv)\ra (i)$ let $f$ be both left and right invertible.  By (i) and (ii) of Theorem~\ref{thm:isos-id-and-composition}, $f$ is both injective and surjective and hence a bijection.  
\end{proof}
\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Adjoint  Isomorphisms}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\comment{%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%In order to define the notion of an adjoint isomorphism we need the following definition.
%\begin{defn} $\;$
%If $f:A\ra B$ define, by Id-induction, $fz:fx=fx'$ for $x,x':A, z:x=x'$ such that $f\refl{x} = \refl{fx}$ for $x:A$.
%\end{defn}
%}%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{defn} A function $f:A\ra B$ is an {\em adjoint isomorphism} if there are $g:B\ra A$, $\eta: g \circ f = \idfunc[A]$ and $\epsilon:f \circ g = \idfunc[B]$ such that there exists a path
  \[\tau : \forall_{x:A}\;\map{f}{\eta x} = \epsilon(fx)\]
We write $A\cong^f_a B$ if there is an adjoint isomorphism $A\ra B$.
\end{defn}
We note that in the above definition, the coherence condition relating $\eta$ and $\epsilon$ only involves $f$. There is an analogous coherence condition involving $g$:
  \[\upsilon : \forall_{y:B}\; \map{g}{\epsilon y} = \eta(gy)\]
We write $A\cong^g_a B$ for the notion of adjoint isomorphism which uses the above condition instead. Fortunately, it turns out each of the conditions implies the other one:

\begin{lem}\label{lem:coh-equiv}
For $f : A \to B$, $g:B\ra A$, $\eta: g \circ f = \idfunc[A]$ and $\epsilon:f \circ g = \idfunc[B]$, the following conditions are equivalent:
\begin{itemize}
\item $\forall_{x:A}\;\map{f}{\eta x} = \epsilon(fx)$
\item $\forall_{y:B}\; \map{g}{\epsilon y} = \eta(gy)$
\end{itemize}
\end{lem}
\begin{proof}
It suffices to show one direction; the other one is obtained by swapping $A/B$, $f/g$, and $\eta/\epsilon$. Let $\tau : \forall_{x:A}\;\map{f}{\eta x} = \epsilon(fx)$. Fix $y : B$. Using naturality of $\epsilon$ and applying $g$, we get the following commuting diagram :
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{gfgfgy \ar^{gfg(\epsilon y)}[r] \ar_{g(\epsilon (fgy))}[d] & gfgy \ar^{g(\epsilon y)}[d] \\ gfgy \ar_{g(\epsilon y)}[r] & gy
  }\]
Using $\tau(gy)$ gives us
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{gfgfgy \ar^{gfg(\epsilon y)}[r] \ar_{gf(\eta (gy))}[d] & gfgy \ar^{g(\epsilon y)}[d] \\ gfgy \ar_{g(\epsilon y)}[r] & gy
  }\]
Since $\eta$ commutes with $f \circ g$, we have
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{gfgfgy \ar^{gfg(\epsilon y)}[r] \ar_{\eta (gfgy)}[d] & gfgy \ar^{g(\epsilon y)}[d] \\ gfgy \ar_{g(\epsilon y)}[r] & gy
  }\]
However, by naturality of $\eta$ we also have
\[\uppercurveobject{{ }}\lowercurveobject{{ }}\twocellhead{{ }}
  \xymatrix{gfgfgy \ar^{gfg(\epsilon y)}[r] \ar_{\eta (gfgy)}[d] & gfgy \ar^{\eta(gy)}[d] \\ gfgy \ar_{g(\epsilon y)}[r] & gy 
  }\]
Thus we have $g(\epsilon y) = \eta(g y)$ as desired.
\end{proof}

Now we want to show that the various forms of equivalence introduced are in fact equivalent. The following definition and lemmas will be useful.

\begin{defn}
For $f : A \to B$, $g : B \to A$, and $\eta : g \circ f \sim \idfunc[A]$, we denote
\[ \coh{f}{g}{\eta} \defeq \prd{y : B} \sm{\gamma : fgy = y} g(\gamma) = \eta y \]
\end{defn}

\begin{lem}\label{lem:hfib}
Let $f : A \to B$ and $y : B$. For any $p, p' : \mathtt{hfiber} \; f \;y$, we have
\[ \big(p = p'\big) \simeq \sm{\gamma : \proj{1}(p) = \proj{1}(p')} f\gamma \ct \proj{2}(p') = \proj{2}(p) \]
\end{lem}
\begin{proof}
We use the known interactions between $\Sigma$-types, identity types, and transports.
\end{proof}

\begin{lem}\label{lem:coheq}
Let $f : A \to B$, $g : B \to A$, and $\eta : g \circ f \sim \idfunc[A]$. For any $y : B$ and $p, p' :\coh{f}{g}{\eta} \; y$, we have
\[ \big(p = p'\big) \simeq \sm{\delta : \proj{1}(p) = \proj{1}(p')} g \delta \ct \proj{2}(p') = \proj{2}(p) \]
\end{lem}
\begin{proof}
We use the known interactions between function types, $\Sigma$-types, identity types, and transports.
\end{proof}

\begin{cor}\label{lem:higher-hom}
For any adjoint isomorphism $(f,g,\eta,\epsilon,\tau) : A \cong_a^f B$ and any $p : \id[A]{x}{x'}$ the following diagram commutes:
\begin{align*}
\xymatrix{
f(\eta x') \ar[dd]_{\tau x'} \ar[r]^{\mathit{via \;} \eta(p) \;\;\;\;\; \; \;\;\;\;\;\;} & f(\opp{gf(p)} \ct \eta x \ct p) \ar[d] \\
& \opp{fgf(p)} \ct f(\eta x) \ct f(p) \ar[d]_{\mathit{via \;} \tau x} \\
\epsilon(f x') \ar[r]_{\mathit{via \;} \epsilon(fp)\;\;\;\;\; \; \;\;\;\;\;\;\;\;\;\;}  & \opp{fgf(p)} \ct \epsilon (fx) \ct f(p)}
\end{align*}
Similarly, for any $(f,g,\eta,\epsilon,\upsilon) : A \cong_a^g B$ and any $p : \id[A]{y}{y'}$ the following diagram commutes:
\begin{align*}
\xymatrix{
g(\epsilon y') \ar[dd]_{\upsilon y'} \ar[r]^{\mathit{via \;} \epsilon(p) \;\;\;\;\; \; \;\;\;\;\;\;} & g(\opp{fg(p)} \ct \eta y \ct p) \ar[d] \\
& \opp{gfg(p)} \ct g(\epsilon y) \ct g(p) \ar[d]_{\mathit{via \;} \upsilon y} \\
\eta(g y') \ar[r]_{\mathit{via \;} \eta(gp)\;\;\;\;\; \; \;\;\;\;\;\;\;\;\;\;}  & \opp{gfg(p)} \ct \eta (gy) \ct g(p)}
\end{align*}
\end{cor}
\begin{proof}
TODO
\end{proof}

\begin{lem}\label{lem:coh-fg}
For any adjoint isomorphism $(f,g,\eta,\epsilon,\tau) : A \cong_a^f B$ the following diagram commutes for each $x : A$:

\begin{align*}
\xymatrix{
f(\eta (g f x)) \ar[d]_{\mathit{via \; } \com{\eta}{g \circ f}{x}} \ar[r]^{\tau(gfx)} &
\epsilon (fgfx) \ar[d]^{\com{\epsilon}{f\circ g}{fx}} \\
fgf (\eta x) \ar[r]_{\mathit{via \;} \tau x} &
fg(\epsilon (f x))} 
\end{align*}

Similarly, for any $(f,g,\eta,\epsilon,\upsilon) : A \cong_a^g B$ the following diagram commutes for each $y : B$:

\begin{align*}
\xymatrix{
g(\epsilon (f g y)) \ar[d]_{\mathit{via \; } \com{\epsilon}{f \circ g}{y}} \ar[r]^{\upsilon(fgy)} &
\eta (gfgy) \ar[d]^{\com{\eta}{g\circ f}{gy}} \\
gfg (\epsilon y) \ar[r]_{\mathit{via \;} \upsilon y} &
gf(\eta (g y))} 
\end{align*}
\end{lem}
\begin{proof}
TODO
\end{proof}

We can now establish equivalence among the various equivalences encountered thus far.

\begin{thm}\label{thm:equivs-equiv}
For any types $A, B$, we have 
\begin{align*}
(A = B) & \simeq (A \simeq B) \\
       & \simeq (A\cong^f_a B) \\
       & \simeq (A\cong^g_a B) \\
       & \simeq (A \cong_w B) \\
       & \simeq (B \cong_w A) \\
        & \simeq (B\cong^g_a A) \\
        & \simeq (B\cong^f_a A) \\
        & \simeq (B \simeq A) \\
        & \simeq (B = A)
\end{align*}
\end{thm}

\begin{proof}
It suffices to exhibit isomorphisms among the various types.
\begin{description}
\item [$\mathit{0)} \; (A = B) \cong (B = A)$]
Basic properties of paths.

\item[$\mathit{1)} \; (A = B) \cong (A \simeq B)$]
Univalence.

\item[$\mathit{2)} \; (B = A) \cong (B \simeq A)$]
Follows from $\mathit{2)}$ by swapping $A$ and $B$.

\item[$\mathit{3)} \; (A \simeq B) \cong (A \cong^f_a B)$] We proceed in 4 steps:
\begin{enumerate}
\item Define a function $F : (A \simeq B) \to (A \cong^f_a B)$. Fix a function $f : A \to B$ and a proof $P(y) := (c(y), h(y))$ that every homotopy fiber of $f$ is contractible.
We define an inverse mapping $g : B \to A$ by mapping each $y : B$ to the center of contraction of the h-fiber at $y$:
\[ g(y) \defeq \proj{1}(c(y)) \]
We can thus define the transformation $\epsilon$ by mapping $y$ to the witness that $g(y)$ indeed belongs to the h-fiber at $y$:
\[ \epsilon(y) \defeq \proj{2}(c(y)) \]
To define $\eta$ and $\tau$, by Lemma~\ref{lem:hfib} we have a family of equivalences $E(y,p,p')$ witnessing
\[ \big( p = p' \big) \simeq \big( \sm{\gamma : \proj{1}(p) = \proj{1}(p')} f\gamma \; \ct \; \proj{2}(p') = \proj{2}(p) \big) \]
for paths in the h-fiber at $y$. A special case arises when $y \defeq fx$ and $p' \defeq (x,\refl{fx})$. In this case,
$E(fx,p,(x,\refl{fx}))$ witnesses the equivalence
\[ \big( p = (x,\refl{fx}) \big) \simeq \big( \sm{\gamma : \proj{1}(p) = x} f\gamma \; \ct \; \refl{fx} = \proj{2}(p) \big) \]
The concatenation with identity path is clearly redundant and we have
\begin{align*}
& \big( \sm{\gamma : \proj{1}(p) = x} f\gamma \; \ct \; \refl{fx} = \proj{2}(p) \big) \simeq \\ 
& \big( \sm{\gamma : \proj{1}(p) = x} f\gamma = \proj{2}(p) \big)
\end{align*}
Let $E'(p,x)$ denote the above equivalence, defined in the obvious way by concatenation.
\medskip

We can then define $\eta$ and $\tau$ (roughly) by constructing a path from $(gfx,\epsilon(fx))$ to $(x,\refl{fx})$ in the h-fiber at $fx$. More precisely, we put
\begin{align*}
\eta(x) & \defeq \proj{1} (\chi(x)) \\
\tau(x) & \defeq \proj{2} (\chi(x))
\end{align*}
where
\begin{align*} \chi(x) \defeq E'(c(fx), x) \; (E(fx, c(fx), (x,\refl{fx})) \; (h(fx)(x, \refl{fx}))) \end{align*} \\


\item Define a function $G : (A \cong^f_a B) \to (A \simeq B)$. Fix an adjoint isomorphism $(f,g,\eta,\epsilon,\tau)$. We want to show that every homotopy fiber of $f$ is contractible. Fix $y : B$. As our center of contraction for $\mathtt{hfiber} \; f \;y$ we put 
\[c(y) \defeq (gy, \epsilon y)\]
Now take any $p : \mathtt{hfiber} \; f \;y$. We want to construct a path $h(y,p) : c(y) = p$. According to Lemma \ref{lem:hfib}, it suffices to give a path $\gamma(y,p) : \id{gy}{\proj{1}(p)}$ for which we have a path $\theta(y,p) : f(\gamma(y,p)) \ct \proj{2}(p) = \epsilon y$. We put $\gamma(y,p) \defeq {\opp{g(\proj{2}(p))}} \ct {\eta (\proj{1}(p))}$. Then we have 
\begin{align*}
f(\gamma(y,p)) \ct \proj{2}(p) & = \opp{fg(\proj{2}(p))} \ct {f (\eta(\proj{1}(p)))} \ct \proj{2}(p) \\
& = \opp{fg(\proj{2}(p))} \ct {\epsilon(f(\proj{1}(p)))} \ct \proj{2}(p) \\
& = \epsilon y
\end{align*}
where the second equality follows by $\tau(\proj{1}(p))$ and the third equality follows by the naturality of $\epsilon$. We let $\theta(y,p)$ be the path obtained by concatenating the above chain of equalities and put 
\begin{align*}
 h(y,p) \defeq \opp{E(y,c(y),p)} (\gamma(y,p), \theta(y,p))
\end{align*} \\


\item Show that $G \circ F \sim \idfunc[\eqv A B]$. Fix a function $f : A \to B$ and a proof $P$ that each homotopy fiber of $f$ is contractible. Obviously $G(F(f,P)) \equiv (f,P')$ for some $P'$. Thus, it suffices to prove that $P = P'$ in the type $\prd{y:B} \mathtt{iscontr \;} (\mathtt{hfiber \;} f \; y)$. However, this type is contractible: by $P$ (and also $P'$), each $\mathtt{hfiber} \; f \; y$ is contractible. Finally, $\mathtt{iscontr \;}$ and $\Pi$ preserve contractibility\footnote{There should be a note on this somewhere in the Basics chapter}. Thus we have $P = P'$ as desired. \\



\item Show that $F \circ G \sim \idfunc[A \cong_a^f B]$. Fix an adjoint isomorphism $(f,g,\eta,\epsilon,\tau)$. Using definitional $\eta$-expansion for functions, we have \[F(G(f,g,\eta,\epsilon,\tau)) \equiv (f, g, \eta', \epsilon, \tau')\] for some $\eta'$ and $\tau'$. It thus suffices to show that for each $x : A$, we have $(n'x,\tau' x) = (nx,\tau x)$ in the type $\sm{\gamma : gfx = x} f\gamma = \epsilon(fx)$, i.e., in $\coh{g}{f}{\eta} \; x$. Fix $x : A$. It is easy to see that
\begin{align*}
(n'x,\tau' x) = E'((gfx, \eta(fx)),x) \; (\refl{gfx} \ct \eta x, \theta)
\end{align*}
where $\theta$ is the following path, with the arrows defined in the obvious ways:
\begin{align*}
\xymatrix{
f(\refl{gfx} \ct \eta x) \ct \refl{fx} \ar[d] \\
\refl{fgfx} \ct f(\eta x) \ct \refl{fx} \ar[d]_{\mathit{via \;}\tau x} \\
\refl{fgfx} \ct \epsilon (fx) \ct \refl{fx} \ar[d] \\
\epsilon (f x)}
\end{align*}
It is easy to show by identity elimination that the following diagram commutes:
\begin{align*}
\xymatrix{
f(\refl{gfx} \ct \eta x) \ar[r] \ar[d] & f(\refl{gfx} \ct \eta x) \ct \refl{fx} \ar[d] \\
f(\eta x) \ar[r] \ar[d]_{\tau x} & \refl{fgfx} \ct f(\eta x) \ct \refl{fx} \ar[d]_{\mathit{via \;}\tau x} \\
\epsilon (f x) \ar[r] \ar[rd] & \refl{fgfx} \ct \epsilon (fx) \ct \refl{fx} \ar[d] \\
& \epsilon (f x)}
\end{align*}
Thus we have $\theta = \theta'$, where $\theta'$ is the following path:
\begin{align*}
\xymatrix{
f(\refl{gfx} \ct \eta x) \ct \refl{fx} \ar[d] \\
f(\refl{gfx} \ct \eta x) \ar[d] \\
f(\eta x) \ar[d] _{\tau x} \\
\epsilon (f x)}
\end{align*}
In other words, we have  
\begin{align*}
(n'x,\tau' x) = E'((gfx, \eta(fx)),x) \; (\refl{gfx} \ct \eta x, \theta')
\end{align*}
Now \[(\refl{gfx} \ct \eta x, \theta') = \opp{E'((gfx, \eta(fx)),x)} \; (\refl{gfx} \ct \eta x, \theta'')\] where $\theta''$ is
\begin{align*}
\xymatrix{
f(\refl{gfx} \ct \eta x) \ar[d] \\
f(\eta x) \ar[d] _{\tau x} \\
\epsilon (f x)}
\end{align*}
Thus $(n'x,\tau' x) = (\refl{gfx} \ct \eta x, \theta'')$. All that remains is to show that $(\eta x, \tau x) = (\refl{gfx} \ct \eta x, \theta'')$ in $\coh{g}{f}{\epsilon} \; x$. By Lem.~\ref{lem:coheq}, it suffices to exhibit a path $\delta : \refl{gfx} \ct \eta x = \eta x$ such that $f(\delta) \ct \tau(x) = \theta''$. It is clear that the obvious path from $\refl{gfx} \ct \eta x$ to $\eta x$ does the job. \\
\end{enumerate}

\item[$\mathit{4)} \; (B \simeq A) \cong (B \cong^f_a A)$] Follows from $\mathit{3)}$ by swapping $A$ and $B$.

\item[$\mathit{5)} \; (A \cong^f_a B) \cong (B \cong^g_a A)$] We simply swap $f/g$, and $\eta/\epsilon$.

\item[$\mathit{6)} \; (B \cong^f_a A) \cong (A \cong^g_a B)$] Follows from $\mathit{5)}$ by swapping $A$ and $B$.

\item[$\mathit{7)} \; (A \cong^g_a B) \cong  (A \cong_w B)$] We proceed in 4 steps:
\begin{enumerate}
\item Define a function $F : (A \cong^g_a B) \to (A \cong_w B)$. This is very simple: given an adjoint isomorphism $(f,g,\eta,\epsilon,\upsilon) : A \cong^g_a B$, 
we take $(f,g,g,\eta,\epsilon)$ to be our desired weak isomorphism. \\



\item Define a function $G : (A \cong_w B) \to (A \cong^g_a B)$. Given a weak isomorphism $(f,g,h,\eta,\epsilon)$, our adjoint isomorphism will be $(f,g,\eta,\epsilon',\upsilon')$, for suitable $\epsilon'$ and $\upsilon'$. 
Namely, we put
\begin{align*}
\epsilon'(y) \defeq \opp{fg(\epsilon y)} \ct f(\eta (h y)) \ct \epsilon y
\end{align*}
Then for any $y : B$ we have
\begin{align*}
g(\epsilon'(y)) & = \opp{gfg(\epsilon y)} \ct gf(\eta (h y)) \ct g(\epsilon y) \\
& = \opp{gfg(\epsilon y)} \ct \eta (gfhy) \ct g(\epsilon y) \\
& = \eta(gy)
\end{align*}
where the second equality follows since $\eta$ commutes with $g \circ f$ and the third equality follows by naturality of $\eta$. We let $\upsilon'(y)$ be the above chain of equalities. \\



\item Show that $G \circ F \sim \idfunc[A \cong^g_a B]$. Fix an adjoint isomorphism $(f,g,\eta,\epsilon,\upsilon)$. It is easy to see that $G(F(f,g,\eta,\epsilon,\upsilon)) \equiv (f,g,\eta, \epsilon', \upsilon')$, where
\begin{align*}
\epsilon'(y) \defeq \opp{fg(\epsilon y)} \ct f(\eta (g y)) \ct \epsilon y
\end{align*}
and $\upsilon'(y)$ is the following chain of paths:

\begin{align*}
\xymatrix{
g(\opp{fg(\epsilon y)} \ct f(\eta (g y)) \ct \epsilon y) \ar[d] \\
\opp{gfg(\epsilon y)} \ct gf(\eta (g y)) \ct g(\epsilon y) \ar[d]^{\mathit{via\;}\com{\eta}{g\circ f}{gy}} \\
\opp{gfg(\epsilon y)} \ct \eta (gfgy) \ct g(\epsilon y) \ar[d]^{\mathit{via \;} \eta(g(\epsilon y))} \\
\eta(g y)}
\end{align*}
It thus suffices to show that for each $y : B$, we have $(\epsilon y,\upsilon y) = (\epsilon' y,\upsilon' y)$ in the type $\sm{\gamma : fgy = y} g(\gamma) = \eta(g y)$, i.e., in the type $\coh{f}{g}{\eta} \; y$. By Lem.~\ref{lem:coheq}, it suffices to exhibit a path $\delta : \epsilon y = \epsilon' y$ such that $g(\delta) \ct \upsilon' y = \upsilon y$.

Let $\delta : \epsilon y = \epsilon' y$ be the path 

\begin{align*}
\xymatrix{
\epsilon y \ar[d]^{\mathit{via \;} \epsilon(\epsilon y)} \\
\opp{fg(\epsilon y)} \ct \epsilon (f g y) \ct \epsilon y \ar[d]^{\mathit{via \; } \com{\epsilon}{f \circ g}{y}} \\
\opp{fg(\epsilon y)} \ct fg (\epsilon y) \ct \epsilon y \ar[d]^{\mathit{via \;} \upsilon y} \\
\opp{fg(\epsilon y)} \ct f (\eta(g y)) \ct \epsilon y}
\end{align*}
It thus remains to show that $\upsilon y$ is equal to the path

\begin{align*}
\xymatrix{
g(\epsilon y) \ar[d]^{\mathit{via \;} \epsilon(\epsilon y)} \\
g(\opp{fg(\epsilon y)} \ct \epsilon (f g y) \ct \epsilon y) \ar[d]^{\mathit{via \; } \com{\epsilon}{f \circ g}{y}} \\
g(\opp{fg(\epsilon y)} \ct fg (\epsilon y) \ct \epsilon y) \ar[d]^{\mathit{via \;} \upsilon y} \\
g(\opp{fg(\epsilon y)} \ct f (\eta(g y)) \ct \epsilon y) \ar[d] \\
\opp{gfg(\epsilon y)} \ct gf(\eta (g y)) \ct g(\epsilon y) \ar[d]^{\mathit{via\;}\com{\eta}{g\circ f}{gy}} \\
\opp{gfg(\epsilon y)} \ct \eta (gfgy) \ct g(\epsilon y) \ar[d]^{\mathit{via \;} \eta(g(\epsilon y))} \\
\eta(g y)}
\end{align*}
Now the following diagram clearly commutes:

\begin{align*}
\xymatrix{
g(\epsilon y) \ar[d]^{\mathit{via \;} \epsilon(\epsilon y)} & \\
g(\opp{fg(\epsilon y)} \ct \epsilon (f g y) \ct \epsilon y) \ar[d]^{\mathit{via \; } \com{\epsilon}{f \circ g}{y}} \ar[r] &
\opp{gfg(\epsilon y)} \ct g(\epsilon (f g y)) \ct g(\epsilon y) \ar[d]^{\mathit{via \; } \com{\epsilon}{f \circ g}{y}} \\  
g(\opp{fg(\epsilon y)} \ct fg (\epsilon y) \ct \epsilon y) \ar[d]^{\mathit{via \;} \upsilon y} \ar[r] &
\opp{gfg(\epsilon y)} \ct gfg (\epsilon y) \ct g(\epsilon y) \ar[d]^{\mathit{via \;} \upsilon y} \\
g(\opp{fg(\epsilon y)} \ct f (\eta(g y)) \ct \epsilon y) \ar[r] &
\opp{gfg(\epsilon y)} \ct gf(\eta (g y)) \ct g(\epsilon y) \ar[d]^{\mathit{via\;}\com{\eta}{g\circ f}{gy}} \\
 & \opp{gfg(\epsilon y)} \ct \eta (gfgy) \ct g(\epsilon y) \ar[d]^{\mathit{via \;} \eta(g(\epsilon y))} \\
 & \eta(g y)}
\end{align*}
This means it suffices to show that $\upsilon y$ is equal to the path

\begin{align*}
\xymatrix{
g(\epsilon y) \ar[d]^{\mathit{via \;} \epsilon(\epsilon y)} \\
g(\opp{fg(\epsilon y)} \ct \epsilon (f g y) \ct \epsilon y) \ar[d] \\
\opp{gfg(\epsilon y)} \ct g(\epsilon (f g y)) \ct g(\epsilon y) \ar[d]^{\mathit{via \; } \com{\epsilon}{f \circ g}{y}} \\
\opp{gfg(\epsilon y)} \ct gfg (\epsilon y) \ct g(\epsilon y) \ar[d]^{\mathit{via \;} \upsilon y} \\
\opp{gfg(\epsilon y)} \ct gf(\eta (g y)) \ct g(\epsilon y) \ar[d]^{\mathit{via\;}\com{\eta}{g\circ f}{gy}} \\
\opp{gfg(\epsilon y)} \ct \eta (gfgy) \ct g(\epsilon y) \ar[d]^{\mathit{via \;} \eta(g(\epsilon y))} \\
\eta(g y)}
\end{align*}
Now by Lem.\ref{lem:coh-fg} we have

\begin{align*}
\xymatrix{
\opp{gfg(\epsilon y)} \ct g(\epsilon (f g y)) \ct g(\epsilon y) \ar[d]_{\mathit{via \; } \com{\epsilon}{f \circ g}{y}} \ar[r]^{\mathit{via \; } \upsilon(fgy)} &
\opp{gfg(\epsilon y)} \ct \eta (gfgy) \ct g(\epsilon y) \ar[d]^{\mathit{via\;}\com{\eta}{g\circ f}{gy}} \\
\opp{gfg(\epsilon y)} \ct gfg (\epsilon y) \ct g(\epsilon y) \ar[r]_{\mathit{via \;} \upsilon y} &
\opp{gfg(\epsilon y)} \ct gf(\eta (g y)) \ct g(\epsilon y)} 
\end{align*}
Thus it suffices to show that $\upsilon y$ is equal to the path

\begin{align*}
\xymatrix{
g(\epsilon y) \ar[d]^{\mathit{via \;} \epsilon(\epsilon y)} \\
g(\opp{fg(\epsilon y)} \ct \epsilon (f g y) \ct \epsilon y) \ar[d] \\
\opp{gfg(\epsilon y)} \ct g(\epsilon (f g y)) \ct g(\epsilon y) \ar[d]^{\mathit{via \; \upsilon(fgy)}}  \\
\opp{gfg(\epsilon y)} \ct \eta (gfgy) \ct g(\epsilon y) \ar[d]^{\mathit{via \;} \eta(g(\epsilon y))} \\
\eta(g y)}
\end{align*}
However, this follows at once from Lem.~\ref{lem:higher-hom}. \\



\item Show that $F \circ G \sim \idfunc[A \cong_w B]$. Fix a weak isomorphism $(f,g,h,\eta,\epsilon)$. It is easy to see that $F(G(f,g,h,\eta,\epsilon)) \equiv (f,g,g,\eta,\epsilon')$, where
\begin{align*}
\epsilon'(y) \defeq \opp{fg(\epsilon y)} \ct f(\eta (h y)) \ct \epsilon y
\end{align*}
Thus it suffices to show that for each $y : B$, we have $(g y, \epsilon' y) = (h y, \epsilon y)$ in the type $\sm{x : A} f x = y$, i.e., in $\mathtt{hfiber \;} f \; y$. By Lem.~\ref{lem:hfib} it suffices to give a path $\gamma : gy = hy$ such that $f(\gamma) \ct \epsilon y = e' y$. This is obviously satisfied if we take  $\gamma \defeq \opp{g(\epsilon y)} \ct \eta(h y)$. \\
\end{enumerate}


\item[$\mathit{8)} \; (B \cong^g_a A) \cong  (B \cong_w A)$]  Follows from $\mathit{7)}$ by swapping $A$ and $B$.
\end{description}
\end{proof}

\begin{thm}\label{thm:equiv-iso-adj} For any $A$ and $B$ we have
\[ (A \cong^f_a B) \leftrightarrow (A \cong B) \]
\end{thm}
\begin{proof}
One direction is obvious. For the other one, suppose that $(g,\eta,\varepsilon)$ is a quasi-inverse for $f$. We have to provide
a quadruple $(g',\eta',\varepsilon',c)$ witnessing that $f$ is an equivalence. To
define $g'$ and $\eta'$, we can just make the obvious choice by setting $g'
\defeq g$ and $\eta'\defeq \eta$. However, in the definition of $\varepsilon'$ we
need start worrying about the construction of $c$, so we cannot just follow our nose
and take $\varepsilon'$ to be $\varepsilon$. Instead, we take
\begin{equation*}
\varepsilon'(b) \defeq (\varepsilon(b)\ct \ap{f}{\eta(g(b))})\ct \varepsilon(f(g(b)))^{-1}
\end{equation*}
Now we need to find
\begin{equation*}
c(a):(\varepsilon(f(a))\ct \ap{f}{\eta(g(f(a)))})\ct \varepsilon(f(g(f(a))))^{-1}=\ap{f}{\eta(a)}
\end{equation*}
Note first that by lemma \ref{lem:htpy_natural}, we have 
$\eta(g(f(a)))\ct\eta(a)=\ap{g}{\ap{f}{\eta(a)}}\ct\eta(a)$ and hence it follows
that $\eta(g(f(a)))=\ap{g}{\ap{f}{\eta(a)}}$. Therefore, we can apply lemma
\ref{lem:htpy_natural} once more to compute
\begin{align*}
\varepsilon(f(a))\ct \ap{f}{\eta(g(f(a)))}
& = \varepsilon(f(a))\ct \ap{f}{\ap{g}{\ap{f}{\eta(a)}}}\\
& = \ap{f}{\eta(a)}\ct\varepsilon(f(g(f(a))))
\end{align*}
from which we get the desired path $c(a)$.
\end{proof}



\comment{
\begin{enumerate}
\item $f$ is an equivalence.
\item $f$ is a weak isomorphism
\item $f$ is an adjoint isomorphism
\end{enumerate}
\begin{proof} 
Let $f:A\ra B$ be an equivalence.  So each type $Cy$ is contractible, where for $y:B$, $Cy \defeq \Sigma_{x:A}\; fx=y$.  This means that
  \[ \forall_{y:B}\exists_{u:Cy}\forall_{u':Cy}\; u'=u.\]
By $\Sigma$-unfolding we get
  \[ \forall_{y:B}\exists_{x:A}\exists_{z:(fx=y)}
                            \forall_{x':A}\forall_{z':(fx'=y)}\; (x,z)=(x',z').
  \]
It follows that
  \[ \forall_{y:B}\exists_{x:A}[fx=y\wedge\forall_{x':A}(fx'=y\ra  x=x')].
  \]
Hence, by $(ii)\ra (iv)$ of \autoref{thm:bijections-isos} , $f$ is a weak isomorphism.

\begin{cor}\label{cor:equivs-equiv}
For types $A,B$ we have the following relationships among the various equivalences:
between our four equivalence relations.
  \[ (\eqv A B) \simeq (A\cong_a^f B) \simeq (A\cong_w B) \leftrightarrow (A\cong B).\]
\end{cor}
\begin{proof} ??

\end{proof}}

\section{Identity Systems on a Type Universe}
\newcommand{\sfr}[1]{{{\sf r}_{#1}}}
Let $\bbU$ be a type universe.

\begin{defn} An {\em identity system $(R,\sfr{})$ on $\bbU$} consists of a type $R_{A,B}$ for $A,B:\bbU$, together with $\sfr{A}:R_{A,A}$ for $A:\bbU$, such that the following holds.  
\begin{quote}
If $D_{A,B}(e)$ is a type for $A,B:\bbU$ and $e:R_{A,B}$ then there is   
  \[ J_{A,B}(e):D_{A,B}(e)\mbox{ for } A,B:\bbU \mbox{ and } e:R_{A,B},\] 
such that
  \[ J_{A,A}(\sfr{A})=d_A\mbox{ for } A:\bbU.\]
\end{quote}
\end{defn}
\begin{eg}
$(Id_\bbU,\refl{\bbU})$ is an identity system on $\bbU$.
\end{eg}
\begin{thm}
If $(R,\sfr{})$ is an identity system on $\bbU$ then
\begin{enumerate}
\item $R_{A,B}\ra \eqv{A}{B}$ for $A,B:\bbU$
\item If $f_e:A\ra B$ and $g_e:B\ra A$ for $A,B:\bbU$ and $e:R_{A,B}$ such that 
  \[ f_{\sfr{A}} = g_{\sfr{A}}=\idfunc[A]\mbox{ for } A:\bbU\] 
then
  \[ g_e\circ f_e =\idfunc[A]\mbox{ and } f_e\circ g_e = \idfunc[B]
      \mbox{ for }  A,B:\bbU \mbox{ and } e:R_{A,B} \]
\end{enumerate}
\end{thm}
\newcommand{\sfequiv}[1]{{\sf reflequiv}^\bbU_{#1}}
\begin{rmk} Once we have the notion of a univalent type universe we can get the following result. 
\end{rmk}
\begin{thm}
$\bbU$ is a univalent type universe iff $(Equiv^\bbU,\sfequiv{})$ is an identity system on $\bbU$, where
  \[ Equiv^\bbU_{A,B}\defeq (\eqv{A}{B})\mbox{ for } A,B:\bbU\]
and, if $s_A: (\idfunc[A]\mbox{ is an equivalence }A\ra A)$,
  \[ \sfequiv{A}\defeq (\idfunc[A],s_A):\eqv{A}{A}\mbox{ for } A:\bbU.\]
\end{thm}


Using the two theorems I believe (from a still mysterious coq proof of Assia and Cyril) that we can get a quick proof of function extensionality on a univalent universe.
% Local Variables:
% TeX-master: "main"
% End:
